---
- name: Add rainier.alpine.lab Replica DC
  hosts: rainier_child_replica
  gather_facts: no
  vars:
    windows_password: "{{ lookup('env','WINDOWS_PASSWORD') }}"

  tasks:
    - name: Check DC status
      include_tasks: ../tasks/check-dc-status.yml

    - name: Configure DNS before promotion
      include_tasks: ../tasks/configure-dns-for-domain.yml
      vars:
        dns_servers:
          - "192.168.35.34"  # MARBLE-DC (rainier.alpine.lab PDC)
          - "192.168.35.30"  # GRANITE-DC (alpine.lab)
          - "192.168.35.31"  # BASALT-DC (alpine.lab)
      when: not is_domain_controller

    - name: Install AD-DS if not a DC
      include_tasks: ../tasks/install-adds.yml
      when: not is_domain_controller

    - name: Promote to replica DC
      include_tasks: ../tasks/promote-replica-dc.yml
      vars:
        domain_dns_name: "rainier.alpine.lab"
        domain_admin_user: "ALPINE\\Administrator"
      when: not is_domain_controller

    - name: Verify DC promotion
      include_tasks: ../tasks/verify-dc-promotion.yml
      when: not is_domain_controller

- name: Summary
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display completion
      debug:
        msg: "rainier.alpine.lab replica DC deployment complete"
