---
- name: Debug WinRM Connection
  hosts: localhost
  gather_facts: no

  vars:
    windows_password: "{{ lookup('env', 'WINDOWS_PASSWORD') }}"

  tasks:
    - name: Check if password is set
      debug:
        msg: "Password length: {{ windows_password | length }} characters"

    - name: Test direct connection to ATLAS
      win_ping:
      vars:
        ansible_host: "192.168.35.227"  # Use the IP you know works
        ansible_user: "Administrator"
        ansible_password: "{{ windows_password }}"
        ansible_connection: winrm
        ansible_winrm_transport: basic
        ansible_winrm_server_cert_validation: ignore
        ansible_port: 5985
      register: test_result
      ignore_errors: yes

    - name: Show result
      debug:
        msg: "Connection: {{ 'SUCCESS' if test_result is success else 'FAILED - ' + test_result.msg }}"

    - name: If failed, test with hardcoded password
      win_ping:
      vars:
        ansible_host: "192.168.35.227"
        ansible_user: "Administrator"
        ansible_password: "Password123!"  # Hardcoded
        ansible_connection: winrm
        ansible_winrm_transport: basic
        ansible_winrm_server_cert_validation: ignore
        ansible_port: 5985
      register: hardcoded_test
      ignore_errors: yes
      when: test_result is failed

    - name: Show hardcoded result
      debug:
        msg: "Hardcoded password: {{ 'SUCCESS' if hardcoded_test is success else 'FAILED' }}"
      when: test_result is failed