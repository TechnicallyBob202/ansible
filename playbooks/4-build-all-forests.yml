---
# ==========================================
# MASTER ORCHESTRATOR - BUILD ALL FORESTS
# Uses import_playbook for Semaphore/AWX compatibility
# ==========================================
# This orchestrator imports other playbooks sequentially
# The inventory is automatically passed from Semaphore
# ==========================================

- name: Display Build Plan
  hosts: localhost
  gather_facts: yes
  
  tasks:
    - name: Display orchestrator info
      debug:
        msg:
          - "=========================================="
          - "SEMPERIS LAB - FULL BUILD ORCHESTRATOR"
          - "=========================================="
          - "This will build the complete multi-forest lab"
          - "Started: {{ ansible_date_time.iso8601 }}"
          - "=========================================="

# ==========================================
# PHASE 1: PRE-BUILD CHECKS
# ==========================================
- import_playbook: 4a-pre-build-checks.yml

# ==========================================
# PHASE 2: FOREST ROOTS
# ==========================================
- import_playbook: 4b-build-arbor-forest-root.yml
- import_playbook: 4c-build-alpine-forest-root.yml

# ==========================================
# PHASE 3: ROOT REPLICA DCs
# ==========================================
- import_playbook: 4d-add-arbor-replica-dc.yml
- import_playbook: 4e-add-alpine-replica-dc.yml

# ==========================================
# PHASE 4: CHILD DOMAINS
# ==========================================
- import_playbook: 4f-build-mauna-child-domain.yml
- import_playbook: 4g-build-rainier-child-domain.yml

# ==========================================
# PHASE 5: CHILD REPLICA DCs
# ==========================================
- import_playbook: 4h-add-mauna-replica-dc.yml
- import_playbook: 4i-add-rainier-replica-dc.yml

# ==========================================
# PHASE 6: POST-CONFIGURATION
# ==========================================
- import_playbook: 4j-configure-dns.yml
# - import_playbook: 4j-configure-ad-sites.yml  # Uncomment when created
# - import_playbook: 4k-create-service-accounts.yml  # Uncomment when created
# - import_playbook: 4l-validate-replication.yml  # Uncomment when created
# - import_playbook: 4m-save-domain-info.yml  # Uncomment when created

# ==========================================
# FINAL SUMMARY
# ==========================================
- name: Build Complete Summary
  hosts: localhost
  gather_facts: yes
  
  tasks:
    - name: Create state directory
      file:
        path: "{{ playbook_dir }}/../state"
        state: directory
        mode: '0755'

    - name: Generate final summary
      copy:
        content: |
          ========================================
          SEMPERIS LAB BUILD COMPLETE
          ========================================
          
          Build Completed: {{ ansible_date_time.iso8601 }}
          
          FORESTS BUILT:
          
          1. arbor.lab (Single Domain)
             ✓ KOA-DC (PDC) - 192.168.35.20
             ✓ OAK-DC (Replica) - 192.168.35.21
          
          2. alpine.lab (Multi-Domain Forest)
             Root Domain: alpine.lab
               ✓ GRANITE-DC (PDC) - 192.168.35.30
               ✓ BASALT-DC (Replica) - 192.168.35.31
             
             Child Domain: mauna.alpine.lab
               ✓ SLATE-DC (PDC) - 192.168.35.32
               ✓ SHALE-DC (Replica) - 192.168.35.33
             
             Child Domain: rainier.alpine.lab
               ✓ MARBLE-DC (PDC) - 192.168.35.34
               ✓ QUARTZ-DC (Replica) - 192.168.35.35
          
          TOTAL: 8 Domain Controllers across 2 forests
          STATUS: FULLY OPERATIONAL ✅
          
          ========================================
        dest: "{{ playbook_dir }}/../state/final-build-summary.txt"
        mode: '0644'

    - name: Display completion message
      debug:
        msg:
          - ""
          - "=========================================="
          - "✅ FULL LAB BUILD COMPLETED"
          - "=========================================="
          - ""
          - "All forests and domains operational:"
          - "  ✅ arbor.lab (2 DCs)"
          - "  ✅ alpine.lab root (2 DCs)"
          - "  ✅ mauna.alpine.lab (2 DCs)"
          - "  ✅ rainier.alpine.lab (2 DCs)"
          - ""
          - "Total: 8 Domain Controllers"
          - "Summary: state/final-build-summary.txt"
          - "=========================================="
