---
- name: Test dynamic tag creation via direct API call
  hosts: localhost
  gather_facts: false

  vars:
    proxmox_host: "192.168.33.21"
    proxmox_user: "root@pam"
    proxmox_password: "{{ lookup('env', 'proxmox-root-password') }}"
    proxmox_validate_certs: false
    proxmox_node: "semperis-nuc-1"
    vmid: 3510
    proxmox_vm_tags: "ADFR,DSP,TEST"

  tasks:
    - name: Ensure required env var is set
      assert:
        that:
          - proxmox_password | length > 0
        fail_msg: "Missing env var proxmox-root-password"

    - name: Apply tags directly via REST API
      ansible.builtin.uri:
        url: "https://{{ proxmox_host }}:8006/api2/json/nodes/{{ proxmox_node }}/qemu/{{ vmid }}/config"
        method: PUT
        user: "{{ proxmox_user }}"
        password: "{{ proxmox_password }}"
        body_format: form-urlencoded
        body:
          tags: "{{ proxmox_vm_tags }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        status_code: 200
      register: proxmox_tag_response

    - name: Show response
      debug:
        var: proxmox_tag_response.json
