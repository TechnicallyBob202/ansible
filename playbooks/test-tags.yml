---
# Test playbook for Proxmox tag application
# Run with: ansible-playbook test-tags.yml

- name: Test Proxmox VM Tag Application
  hosts: localhost
  gather_facts: false
  collections:
    - community.general

  vars:
    test_vmid: 3510        # ATLAS
    test_node: semperis-nuc-1
    test_proxmox_host: 192.168.33.21
    test_tags: "ADFR"      # e.g., "ADFR,DSP"
    proxmox_user: root@pam
    proxmox_password: "{{ lookup('env', 'proxmox-root-password') }}"
    proxmox_validate_certs: false

  tasks:
    - name: Validate required environment variables
      assert:
        that:
          - proxmox_password is defined
          - proxmox_password | length > 0
        fail_msg: "Required environment variable not set: proxmox-root-password"

    - name: Get current VM info before tagging
      community.general.proxmox_vm_info:
        api_host: "{{ test_proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
      register: vm_info_before

    - name: Extract current tags before
      set_fact:
        tags_before_raw: "{{ (vm_info_before.proxmox_vms | selectattr('vmid', 'equalto', test_vmid) | list | first | default({})).tags | default('') }}"

    - name: Display current tags
      debug:
        msg: "Current tags: {{ tags_before_raw | default('(none)') }}"

    - name: Apply tags (single pass, idempotent)
      community.general.proxmox_kvm:
        api_host: "{{ test_proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        vmid: "{{ test_vmid }}"
        node: "{{ test_node }}"
        tags: "{{ test_tags }}"
        update: yes
      register: tag_apply

    - name: Display apply result
      debug:
        msg: "Apply changed: {{ tag_apply.changed }}"

    - name: Wait briefly for API to persist changes
      pause:
        seconds: 2

    - name: Read back VM info (retry for eventual consistency)
      community.general.proxmox_vm_info:
        api_host: "{{ test_proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
      register: vm_info_after
      retries: 3
      delay: 2
      until: >
        (
          (
            (vm_info_after.proxmox_vms | selectattr('vmid','equalto', test_vmid) | list | first | default({})).tags | default('')
          ) | length
        ) >= 0

    - name: Extract tags after
      set_fact:
        tags_after_raw: "{{ (vm_info_after.proxmox_vms | selectattr('vmid','equalto', test_vmid) | list | first | default({})).tags | default('') }}"

    - name: Normalize expected and actual tags
      set_fact:
        expected_tags_list: "{{ test_tags | regex_replace('\\s+', '') | regex_replace(';', ',') | split(',') | select('truthy') | map('upper') | list | unique | sort }}"
        actual_tags_list:   "{{ tags_after_raw | regex_replace('\\s+', '') | regex_replace(';', ',') | split(',') | select('truthy') | map('upper') | list | unique | sort }}"

    - name: Display result
      debug:
        msg:
          - "Tag application test complete:"
          - "  Before (raw): {{ tags_before_raw | default('(none)') }}"
          - "  After  (raw): {{ tags_after_raw  | default('(none)') }}"
          - "  Expected (norm): {{ expected_tags_list }}"
          - "  Actual   (norm): {{ actual_tags_list }}"
          - "  Success: {{ expected_tags_list == actual_tags_list }}"