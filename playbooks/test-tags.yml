---
- name: Test dynamic tag creation in Proxmox
  hosts: localhost
  gather_facts: false

  vars:
    proxmox_host: "your.proxmox.host"
    proxmox_user: "root@pam"
    proxmox_password: "your_password"
    proxmox_validate_certs: false
    proxmox_node: "pve"
    vmid: 101
    proxmox_vm_tags: "ADFR,DSP,TEST"  # comma-separated list for Proxmox

  tasks:
    - name: Get current VM info
      community.general.proxmox_kvm_info:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        vmid: "{{ vmid }}"
        node: "{{ proxmox_node }}"
      register: vm_info

    - name: Show current tags
      debug:
        msg: "Current tags: {{ vm_info.proxmox_kvm_info[0].tags | default('none') }}"

    - name: Apply tags directly via API (bypasses tag validation)
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        vmid: "{{ vmid }}"
        node: "{{ proxmox_node }}"
        api_update_vm:
          tags: "{{ proxmox_vm_tags }}"
      register: tag_update
      changed_when: "'update pending' in (tag_update.msg | default('')) or tag_update.changed"

    - name: Get updated VM info
      community.general.proxmox_kvm_info:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        vmid: "{{ vmid }}"
        node: "{{ proxmox_node }}"
      register: vm_info_after

    - name: Show updated tags
      debug:
        msg:
          - "Before: {{ vm_info.proxmox_kvm_info[0].tags | default('none') }}"
          - "After:  {{ vm_info_after.proxmox_kvm_info[0].tags | default('none') }}"
          - "Expected: {{ proxmox_vm_tags }}"
