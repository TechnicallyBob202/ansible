---
- name: Deploy Semperis Lab - 17 VMs (Parallel via Shell)
  hosts: localhost
  gather_facts: no

  vars:
    proxmox_host1: 192.168.33.21
    proxmox_host2: 192.168.33.22
    proxmox_user: root@pam
    proxmox_password: "{{ lookup('env', 'proxmox-root-password') }}"

    template_host1: 9001
    template_host2: 9002
    network_bridge: vmbr0
    network_vlan: 35

    vms:
      # Host 1 VMs
      - { name: "ATLAS", vmid: 3510, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 4, memory: 8192, disk: "100G" }
      - { name: "SUMMIT", vmid: 3511, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 4, memory: 8192, disk: "100G" }
      - { name: "PEAK", vmid: 3512, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 4, memory: 16384, disk: "200G" }
      - { name: "RIDGE", vmid: 3513, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 4096, disk: "500G" }
      - { name: "KOA-DC01", vmid: 3520, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "GRANITE-DC01", vmid: 3530, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "SLATE-DC01", vmid: 3532, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "MARBLE-DC01", vmid: 3534, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "MESA-R01", vmid: 3550, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 4096, disk: "80G" }
      # Host 2 VMs
      - { name: "CREST", vmid: 3514, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 4096, disk: "500G" }
      - { name: "SLOPE", vmid: 3519, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "OAK-DC01", vmid: 3521, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "BASALT-DC01", vmid: 3531, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "SHALE-DC01", vmid: 3533, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "QUARTZ-DC01", vmid: 3535, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "BLUFF-R01", vmid: 3551, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "CLIFF-R01", vmid: 3552, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 4096, disk: "80G" }

  tasks:
    - name: Display deployment plan
      debug:
        msg:
          - "=========================================="
          - "Deploying 17 VMs (Parallel SSH)"
          - "=========================================="
          - "Using SSH to Proxmox hosts for true parallelization"
          - "=========================================="

    # ============================================
    # Clone ALL VMs in background using qm clone
    # ============================================
    - name: Clone VMs in background using SSH (true async)
      shell: |
        ssh -o StrictHostKeyChecking=no root@{{ item.host }} \
          "qm clone {{ item.template }} {{ item.vmid }} --name {{ item.name }} --full 1" &
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Wait for all clones to complete
      pause:
        minutes: 3
        prompt: "Waiting 3 minutes for all VM clones to complete..."

    - name: Configure VLAN tags
      community.general.proxmox_nic:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: no
        vmid: "{{ item.vmid }}"
        interface: net0
        bridge: "{{ network_bridge }}"
        tag: "{{ network_vlan }}"
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Configure VM hardware
      community.general.proxmox_kvm:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: no
        vmid: "{{ item.vmid }}"
        node: "{{ item.node }}"
        name: "{{ item.name }}"
        cores: "{{ item.cores }}"
        memory: "{{ item.memory }}"
        update: yes
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Resize VM disks
      community.general.proxmox_disk:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: no
        vmid: "{{ item.vmid }}"
        disk: scsi0
        size: "{{ item.disk }}"
        state: resized
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Start all VMs
      community.general.proxmox_kvm:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: no
        vmid: "{{ item.vmid }}"
        node: "{{ item.node }}"
        state: started
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Wait for VMs to boot
      pause:
        seconds: 60
        prompt: "Waiting for all VMs to boot and get DHCP addresses..."

    - name: Display completion summary
      debug:
        msg:
          - "=========================================="
          - "VM Deployment Complete!"
          - "=========================================="
          - "All 17 VMs deployed and started"
          - "Next: Run 2-configure-ips.yml"
          - "=========================================="