---
- name: Deploy 17 Lab VMs
  hosts: localhost
  gather_facts: no

  vars:
    proxmox_host1: 192.168.33.21
    proxmox_host2: 192.168.33.22
    proxmox_user: root@pam
    proxmox_password: "{{ lookup('env', 'PROXMOX_ROOT_PASSWORD') }}"
    validate_certs: no
    proxmox_pool: "ADFR-DSP"
    template_host1: 9001
    template_host2: 9002
    network_bridge: vmbr0
    network_vlan: 35

    vms:
      - { name: "ATLAS", vmid: 3501, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 6144, disk: "100G" }
      - { name: "SUMMIT", vmid: 3502, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 6144, disk: "100G" }
      - { name: "PEAK", vmid: 3503, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 4, memory: 8192, disk: "200G" }
      - { name: "RIDGE", vmid: 3504, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 4096, disk: "500G" }
      - { name: "SLOPE", vmid: 3509, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 4096, disk: "80G" }
      - { name: "KOA-DC01", vmid: 3510, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 3072, disk: "80G" }
      - { name: "GRANITE-DC01", vmid: 3520, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 3072, disk: "80G" }
      - { name: "SLATE-DC01", vmid: 3522, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 3072, disk: "80G" }
      - { name: "MARBLE-DC01", vmid: 3524, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 3072, disk: "80G" }
      - { name: "MESA-R01", vmid: 3550, host: "{{ proxmox_host1 }}", node: "semperis-nuc-1", template: "{{ template_host1 }}", cores: 2, memory: 3072, disk: "80G" }
      - { name: "CREST", vmid: 3505, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 4096, disk: "500G" }
      - { name: "OAK-DC01", vmid: 3511, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 3072, disk: "80G" }
      - { name: "BASALT-DC01", vmid: 3521, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 3072, disk: "80G" }
      - { name: "SHALE-DC01", vmid: 3523, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 3072, disk: "80G" }
      - { name: "QUARTZ-DC01", vmid: 3525, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 3072, disk: "80G" }
      - { name: "BLUFF-R01", vmid: 3551, host: "{{ proxmox_host2 }}", node: "semperis-nuc-2", template: "{{ template_host2 }}", cores: 2, memory: 3072, disk: "80G" }

  tasks:
    - name: Display deployment plan
      debug:
        msg:
          - "Deploying {{ vms | length }} VMs"
          - "Host 1: {{ vms | selectattr('host', 'equalto', proxmox_host1) | list | length }} VMs"
          - "Host 2: {{ vms | selectattr('host', 'equalto', proxmox_host2) | list | length }} VMs"

    - name: Clone VMs from templates
      community.general.proxmox_kvm:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ validate_certs }}"
        node: "{{ item.node }}"
        vmid: "{{ item.template }}"
        clone: "{{ item.template }}"
        newid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        pool: "{{ proxmox_pool }}"
        full: yes
        timeout: 600
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Wait for clones to complete
      pause:
        seconds: 10

    - name: Configure VLAN tags
      community.general.proxmox_nic:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ item.vmid }}"
        interface: net0
        bridge: "{{ network_bridge }}"
        tag: "{{ network_vlan }}"
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Configure VM hardware
      community.general.proxmox_kvm:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ item.vmid }}"
        node: "{{ item.node }}"
        name: "{{ item.name }}"
        cores: "{{ item.cores }}"
        memory: "{{ item.memory }}"
        pool: "{{ proxmox_pool }}"
        update: yes
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Resize VM disks
      community.general.proxmox_disk:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ item.vmid }}"
        disk: scsi0
        size: "{{ item.disk }}"
        state: resized
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Tag VMs
      community.general.proxmox_kvm:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ item.vmid }}"
        node: "{{ item.node }}"
        tags: "adfr-dsp"
        update: yes
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Start all VMs
      community.general.proxmox_kvm:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ item.vmid }}"
        node: "{{ item.node }}"
        state: started
      loop: "{{ vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Wait for VMs to boot
      pause:
        seconds: 60

    - name: Deployment complete
      debug:
        msg: "All {{ vms | length }} VMs deployed"
