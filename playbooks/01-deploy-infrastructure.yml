---
# =============================================================================
# PHASE 1: Deploy VMs (clone + configure + start)
# =============================================================================
- name: Deploy Lab VMs from Inventory
  hosts: all
  gather_facts: false
  serial: 0

  vars:
    proxmox_operation: deploy

  tasks:
    - name: Display deployment plan
      debug:
        msg:
          - "Deploying {{ ansible_play_hosts | length }} VMs"
          - "VMs will boot with DHCP - run playbook 02 next to configure static IPs"
      run_once: true
      delegate_to: localhost

    - name: Deploy VM (clone + configure + start)
      include_role:
        name: proxmox
        apply:
          delegate_to: localhost

    - name: Display deployment status
      debug:
        msg: "{{ inventory_hostname }} - {{ 'NEWLY DEPLOYED' if (vm_changed | default(false)) else 'ALREADY EXISTS' }}"

    - name: Determine if any VMs were newly deployed
      set_fact:
        any_new_vms: "{{ (ansible_play_hosts
                          | map('extract', hostvars, 'vm_changed')
                          | select('equalto', true)
                          | list | length) > 0 }}"
      run_once: true
      delegate_to: localhost
      delegate_facts: true

    - name: Wait for VMs to boot (DHCP)
      pause:
        seconds: 60
      when: hostvars['localhost']['any_new_vms'] | default(false)
      run_once: true
      delegate_to: localhost

# =============================================================================
# PHASE 2: Ensure Proxmox Tags Exist
# =============================================================================
- name: Manage Proxmox Tags
  hosts: localhost
  gather_facts: false

  vars:
    proxmox_host: "{{ hostvars[groups['all'][0]].proxmox_host }}"

  tasks:
    - name: Ensure required tags exist in Proxmox
      include_role:
        name: proxmox
        tasks_from: manage_tags.yml

# =============================================================================
# PHASE 3: Update VM Tags (ALL VMs - new and existing)
# =============================================================================
- name: Update VM Tags
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Display tag update plan
      debug:
        msg: "{{ inventory_hostname }} - Setting tags to: {{ proxmox_vm_tags | default('none') }}"

    - name: Update VM tags
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs | default(false) }}"
        vmid: "{{ vmid }}"
        node: "{{ proxmox_node }}"
        tags: "{{ proxmox_vm_tags }}"
        update: yes
      register: tag_result
      delegate_to: localhost
      when: proxmox_vm_tags is defined

    - name: Display tag result
      debug:
        msg: "{{ inventory_hostname }} - Tags {{ 'updated' if (tag_result.changed | default(false)) else 'already set' }}"
      when: proxmox_vm_tags is defined

# =============================================================================
# PHASE 4: Snapshot after deployment (only VMs that were deployed)
# =============================================================================
- name: Snapshot after deploy
  hosts: all
  gather_facts: false
  serial: 2

  tasks:
    - name: Display snapshot decision
      debug:
        msg: "{{ inventory_hostname }} - Will {{ 'CREATE' if (vm_changed | default(false)) else 'SKIP' }} snapshot"

    - name: Take snapshot (post-deploy) - only for newly deployed VMs
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: post-deploy
      when: vm_changed | default(false)

# =============================================================================
# PHASE 5: Completion message
# =============================================================================
- name: Deployment Summary
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Count changed VMs
      set_fact:
        changed_count: "{{ groups['all'] | map('extract', hostvars, 'vm_changed') | select('equalto', true) | list | length }}"

    - name: Count tagged VMs
      set_fact:
        tagged_count: "{{ groups['all'] | map('extract', hostvars, 'tag_result') | selectattr('changed', 'defined') | selectattr('changed', 'equalto', true) | list | length }}"

    - name: Display detailed breakdown
      debug:
        msg: "{{ item }} - {{ 'NEWLY DEPLOYED' if hostvars[item].vm_changed | default(false) else 'ALREADY EXISTED' }}"
      loop: "{{ groups['all'] }}"

    - name: Deployment complete
      debug:
        msg:
          - "Deployment complete:"
          - "  {{ changed_count }}/{{ groups['all'] | length }} VMs were newly deployed"
          - "  {{ tagged_count }}/{{ groups['all'] | length }} VMs had tags updated"
          - "  Snapshots created for {{ changed_count }} newly deployed VMs"
          - ""
          - "Next: Run playbook 02-configure-base-os.yml to set static IPs"