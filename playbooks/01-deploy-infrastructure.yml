---
- name: Deploy Lab VMs from Inventory
  hosts: all
  gather_facts: no
  serial: 0  # Deploy all in parallel

  vars:
    proxmox_operation: deploy

  tasks:
    - name: Display deployment plan
      debug:
        msg:
          - "Deploying {{ ansible_play_hosts | length }} VMs"
          - "VMs will boot with DHCP - run playbook 02 next to configure static IPs"
      run_once: yes
      delegate_to: localhost

    - name: Deploy VM (clone + configure + start)
      include_role:
        name: proxmox
        apply:
          delegate_to: localhost

    - name: Determine if any VMs were newly deployed
      set_fact:
        any_new_vms: "{{ (ansible_play_hosts
                          | map('extract', hostvars, 'vm_preexisted')
                          | map('default', true)
                          | select('equalto', false)
                          | list | length) > 0 }}"
      run_once: yes
      delegate_to: localhost
      delegate_facts: true

    - name: Wait for VMs to boot (DHCP)
      pause:
        seconds: 60
      when: hostvars['localhost']['any_new_vms'] | default(true)
      run_once: yes
      delegate_to: localhost

# =============================================================================
# PHASE 2: Snapshot after deployment
# =============================================================================
- name: Snapshot after deploy
  hosts: all
  gather_facts: no
  serial: 2

  tasks:
    - name: Take snapshot (post-deploy)
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: post-deploy

# =============================================================================
# PHASE 3: Completion message
# =============================================================================
- name: Deployment Summary
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Deployment complete
      debug:
        msg:
          - "All VMs deployed"
          - "VMs are booting with DHCP addresses"
          - "Snapshot created: post-deploy"
          - "Next: Run playbook 02-configure-base-os.yml to set static IPs"