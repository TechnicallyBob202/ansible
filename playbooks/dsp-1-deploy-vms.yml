---
# =============================================================================
# DSP-1: Deploy DSP Lab VMs
# =============================================================================
# - Clone VMs from templates
# - Configure hardware (CPU, RAM, disk)
# - Configure network (VLAN, tags, pools)
# - Start VMs (boot with DHCP)
# - Snapshot newly deployed VMs
# =============================================================================

- name: DSP-1 - Deploy DSP Lab VMs
  hosts: all
  gather_facts: false
  serial: 0

  vars:
    proxmox_operation: deploy

  tasks:
    - name: Display deployment plan
      debug:
        msg:
          - "========================================="
          - "  DSP-1: Deploy DSP Lab Infrastructure"
          - "========================================="
          - ""
          - "Deploying {{ ansible_play_hosts | length }} VMs:"
          - "  • D3 Forest: {{ groups['d1_forest'] | default([]) | length }} VMs"
          - "  • DSP Infrastructure: {{ groups['DSP_infrastructure'] | default([]) | length }} VMs"
          - ""
          - "VMs will boot with DHCP"
          - "Run DSP-2 next to configure static IPs"
      run_once: true
      delegate_to: localhost

    - name: Deploy VM (clone + configure + start)
      include_role:
        name: proxmox
        apply:
          delegate_to: localhost

    - name: Display deployment status
      debug:
        msg: "{{ inventory_hostname }} - {{ 'NEWLY DEPLOYED' if (vm_changed | default(false)) else 'ALREADY EXISTS' }}"

    - name: Determine if any VMs were newly deployed
      set_fact:
        any_new_vms: "{{ (ansible_play_hosts
                          | map('extract', hostvars, 'vm_changed')
                          | select('equalto', true)
                          | list | length) > 0 }}"
      run_once: true
      delegate_to: localhost
      delegate_facts: true

    - name: Wait for VMs to boot (DHCP)
      pause:
        seconds: 60
      when: hostvars['localhost']['any_new_vms'] | default(false)
      run_once: true
      delegate_to: localhost

# =============================================================================
# Snapshot newly deployed VMs
# =============================================================================
- name: Snapshot after deployment
  hosts: all
  gather_facts: false
  serial: 2

  tasks:
    - name: Display snapshot decision
      debug:
        msg: "{{ inventory_hostname }} - Will {{ 'CREATE' if (vm_changed | default(false)) else 'SKIP' }} snapshot"

    - name: Take snapshot (post-deploy)
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: post-deploy
      when: vm_changed | default(false)

# =============================================================================
# Summary
# =============================================================================
- name: DSP-1 Complete
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display completion summary
      debug:
        msg:
          - ""
          - "========================================="
          - "  DSP-1 Complete!"
          - "========================================="
          - ""
          - "✓ VMs deployed and started"
          - "✓ Snapshots created for new VMs"
          - ""
          - "Next: Run DSP-2 to configure static IPs and hostnames"