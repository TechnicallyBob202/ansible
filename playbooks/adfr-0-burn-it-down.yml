---
- name: Cleanup All Lab VMs
  hosts: all
  connection: local
  gather_facts: false

  vars:
    proxmox_user: root@pam
    proxmox_password: "{{ lookup('env', 'proxmox-root-password') }}"

  tasks:
    - name: Display cleanup plan
      debug:
        msg:
          - "WARNING: This will destroy {{ ansible_play_hosts | length }} VMs"
          - "Waiting 10 seconds... Press Ctrl+C to abort"
      run_once: true

    - name: Wait before destruction
      pause:
        seconds: 10
      run_once: true

    - name: Stop and destroy VMs
      include_role:
        name: proxmox
        tasks_from: destroy.yml

    - name: Compute summary
      run_once: true
      set_fact:
        _destroyed_count: "{{ ansible_play_hosts | map('extract', hostvars, 'host_destroyed') | select('truthy') | list | length }}"
        _skipped_count: "{{ ansible_play_hosts | map('extract', hostvars, 'host_skipped') | select('truthy') | list | length }}"
        _absent_count: "{{ ansible_play_hosts | length - _destroyed_count - _skipped_count }}"

    - name: Cleanup summary
      run_once: true
      debug:
        msg:
          - "Destroyed: {{ _destroyed_count }}"
          - "Already absent: {{ _absent_count }}"
          - "Skipped (pre-check said absent): {{ _skipped_count }}"