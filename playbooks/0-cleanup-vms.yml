---
- name: Cleanup All Lab VMs
  hosts: localhost
  gather_facts: no

  vars:
    proxmox_host1: 192.168.33.21
    proxmox_host2: 192.168.33.22
    proxmox_user: root@pam
    proxmox_password: "{{ lookup('env', 'proxmox-root-password') }}"
    validate_certs: no

    vm_ids_host1:
      - 3510  # ATLAS
      - 3512  # PEAK
      - 3513  # RIDGE
      - 3520  # KOA-DC
      - 3530  # GRANITE-DC
      - 3532  # SLATE-DC
      - 3534  # MARBLE-DC
      - 3550  # MESA

    vm_ids_host2:
      - 3511  # SUMMIT
      - 3514  # CREST
      - 3521  # OAK-DC
      - 3531  # BASALT-DC
      - 3533  # SHALE-DC
      - 3535  # QUARTZ-DC
      - 3551  # BLUFF

  tasks:
    - name: Display cleanup plan
      debug:
        msg:
          - "Destroying {{ (vm_ids_host1 | length) + (vm_ids_host2 | length) }} VMs"
          - "Host 1: {{ vm_ids_host1 | length }} VMs"
          - "Host 2: {{ vm_ids_host2 | length }} VMs"

    - name: Wait 5 seconds
      pause:
        seconds: 5

    - name: Stop VMs on Host 1
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host1 }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ item }}"
        node: semperis-nuc-1
        state: stopped
        force: yes
      loop: "{{ vm_ids_host1 }}"
      ignore_errors: yes

    - name: Stop VMs on Host 2
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host2 }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ item }}"
        node: semperis-nuc-2
        state: stopped
        force: yes
      loop: "{{ vm_ids_host2 }}"
      ignore_errors: yes

    - name: Wait for VMs to stop
      pause:
        seconds: 5

    - name: Destroy VMs on Host 1
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host1 }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ item }}"
        node: semperis-nuc-1
        state: absent
      loop: "{{ vm_ids_host1 }}"
      ignore_errors: yes

    - name: Destroy VMs on Host 2
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host2 }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ validate_certs }}"
        vmid: "{{ item }}"
        node: semperis-nuc-2
        state: absent
      loop: "{{ vm_ids_host2 }}"
      ignore_errors: yes

    - name: Cleanup complete
      debug:
        msg: "All lab VMs destroyed"
