---
- name: Revert Servers to PRE-DEMO Snapshot
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display revert plan
      debug:
        msg:
          - "========================================="
          - "  Post-Demo Rollback to PRE-DEMO"
          - "========================================="
          - ""
          - "This will revert ADFR management server and recovery VMs to:"
          - "  Snapshot: PRE-DEMO"
          - ""
          - "Waiting 10 seconds... Press Ctrl+C to abort"

    - name: Wait before reverting
      pause:
        seconds: 10

# =============================================================================
# PHASE 1: Stop All VMs
# =============================================================================
- name: Stop All VMs
  hosts: adfr_management:adfr_recovery_D1
  gather_facts: false
  serial: 0

  tasks:
    - name: Stop VM before revert
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        vmid: "{{ vmid }}"
        node: "{{ proxmox_node }}"
        state: stopped
        force: yes
      delegate_to: localhost
      register: stop_result

    - name: Display stop result
      debug:
        msg: "{{ inventory_hostname }} - stopped"

# =============================================================================
# PHASE 2: Revert to PRE-DEMO Snapshot
# =============================================================================
- name: Revert to PRE-DEMO Snapshot
  hosts: adfr_management:adfr_recovery_D1
  gather_facts: false
  serial: 3

  tasks:
    - name: Revert snapshot
      shell: |
        ssh -i /root/.ssh/ansible_key \
          -o StrictHostKeyChecking=no \
          root@{{ proxmox_host }} \
          "qm rollback {{ vmid }} PRE-DEMO"
      delegate_to: localhost
      register: rollback_result

    - name: Wait for Proxmox to register rollback state
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        vmid: "{{ vmid }}"
        node: "{{ proxmox_node }}"
        state: current
      delegate_to: localhost
      register: vm_state
      until: vm_state.status == 'stopped'
      retries: 12
      delay: 5
      changed_when: false

    - name: Wait for rollback
      pause:
        seconds: 15
      run_once: true
      delegate_to: localhost

    - name: Display rollback result
      debug:
        msg: "{{ inventory_hostname }} - reverted to PRE-DEMO snapshot"

# =============================================================================
# PHASE 3: Start All VMs
# =============================================================================
- name: Start All VMs
  hosts: adfr_management:adfr_recovery_D1
  gather_facts: false
  serial: 0

  tasks:
    - name: Start VM after revert
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        vmid: "{{ vmid }}"
        node: "{{ proxmox_node }}"
        state: started
      delegate_to: localhost

    - name: Display start result
      debug:
        msg: "{{ inventory_hostname }} - started"

    - name: Wait for VMs to boot
      pause:
        seconds: 30
      run_once: true
      delegate_to: localhost

# =============================================================================
# PHASE 4: Wait for WinRM and Synchronize Time
# =============================================================================
- name: Wait for WinRM and Sync Time
  hosts: adfr_management:adfr_recovery_D1
  gather_facts: false
  serial: 0

  tasks:
    - name: Wait for WinRM to be available
      wait_for_connection:
        timeout: 600
        sleep: 10
        delay: 30
      register: connection_result

    - name: Verify WinRM is responsive
      ansible.windows.win_ping:
      register: ping_result
      retries: 10
      delay: 5
      until: ping_result is succeeded

    - name: Force time synchronization with NTP
      ansible.windows.win_shell: |
        w32tm /resync /force
        Start-Sleep -Seconds 5
        w32tm /query /status
      register: time_sync_result

    - name: Display time sync result
      debug:
        msg: "{{ inventory_hostname }} - time synchronized"

# =============================================================================
# PHASE 5: Summary
# =============================================================================
- name: Display Summary
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display completion message
      debug:
        msg:
          - ""
          - "========================================="
          - "  Post-Demo Rollback Complete"
          - "========================================="
          - ""
          - "All VMs have been reverted to PRE-DEMO snapshot:"
          - "  • Management Server"
          - "  • Recovery VMs"
          - ""
          - "All VMs have been restarted"
          - "Time has been synchronized on all VMs"
          - ""
          - "Lab is ready for next demo"