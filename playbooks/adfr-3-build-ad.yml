---
- name: Build Active Directory Forests and Domains
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Display build plan
      debug:
        msg:
          - "Building Active Directory Infrastructure"
          - "  Forest 1: D1.lab (2 DCs)"
          - "  Forest 2: D2.lab (6 DCs in 3 domains)"
          - "Total Duration: 45-60 minutes"

# =============================================================================
# PHASE 1: Initialize Change Tracking
# =============================================================================
- name: Initialize Change Tracking for All VMs
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Initialize vm_changed flag
      set_fact:
        vm_changed: false

# =============================================================================
# PHASE 2: Install AD Features on All Domain Controllers
# =============================================================================
- name: Install Active Directory Features
  hosts: domain_controllers
  gather_facts: false
  serial: 0
  tasks:
    - name: Install AD-DS features
      include_role:
        name: active_directory
        tasks_from: install_ad_features.yml
      register: features_result

    - name: Mark VM as changed if features were installed
      set_fact:
        vm_changed: "{{ vm_changed or (features_result.changed | default(false)) }}"

# =============================================================================
# PHASE 3: Set steady-state DNS on all DCs (static from inventory)
# =============================================================================
- name: Set steady-state DNS on all DCs
  hosts: domain_controllers
  gather_facts: false
  tasks:
    - name: Apply DNS settings from inventory (idempotent)
      include_role:
        name: active_directory
        tasks_from: set_dns.yml

# =============================================================================
# PHASE 4: Promote Forest Root PDCs (serial: 2)
# =============================================================================
- name: Promote Forest Root PDCs
  hosts: D1-DC01:D2-DC01
  gather_facts: false
  serial: 2
  tasks:
    - name: Check domain status
      include_role:
        name: active_directory
        tasks_from: check_domain_status.yml

    - name: Promote to forest root PDC
      include_role:
        name: active_directory
        tasks_from: promote_forest_root.yml
      when: not is_domain_controller
      register: promotion_result

    - name: Abort if promotion failed
      fail:
        msg: |
          CRITICAL: Forest root promotion failed for {{ inventory_hostname }}
          Error: {{ promotion_result.msg | default('Unknown error') }}

          Manual cleanup required before continuing.
      when:
        - promotion_result is defined
        - promotion_result.failed | default(false)

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"
      when:
        - promotion_result is defined
        - not (promotion_result.failed | default(false))

    - name: Wait for DC to be ready
      include_role:
        name: active_directory
        tasks_from: wait_for_dc_ready.yml
      when: promotion_result.changed | default(false)

    - name: Check FSMO roles
      include_role:
        name: active_directory
        tasks_from: check_fsmo_roles.yml

# =============================================================================
# PHASE 4.5: Ensure DNS on Forest Root PDCs
# =============================================================================
- name: Ensure DNS on Forest Root PDCs
  hosts: D1-DC01:D2-DC01
  gather_facts: false
  tasks:
    - name: Ensure DNS is installed and configured
      include_role:
        name: active_directory
        tasks_from: ensure_dns.yml

# =============================================================================
# PHASE 5: Promote Forest Root Replica DCs (serial: 2)
# =============================================================================
- name: Promote Forest Root Replica DCs
  hosts: D1-DC02:D2-DC02
  gather_facts: false
  serial: 2
  tasks:
    - name: Check domain status
      include_role:
        name: active_directory
        tasks_from: check_domain_status.yml

    - name: Promote to replica DC
      include_role:
        name: active_directory
        tasks_from: promote_replica_dc.yml
      when: not is_domain_controller
      register: promotion_result

    - name: Abort if promotion failed
      fail:
        msg: |
          CRITICAL: Replica DC promotion failed for {{ inventory_hostname }}
          Error: {{ promotion_result.msg | default('Unknown error') }}

          Manual cleanup required before continuing.
      when:
        - promotion_result is defined
        - promotion_result.failed | default(false)

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"
      when:
        - promotion_result is defined
        - not (promotion_result.failed | default(false))

    - name: Wait for DC to be ready
      include_role:
        name: active_directory
        tasks_from: wait_for_dc_ready.yml
      when: promotion_result.changed | default(false)

    - name: Verify replication
      include_role:
        name: active_directory
        tasks_from: verify_replication.yml

# =============================================================================
# PHASE 5.5: Ensure DNS on Forest Root Replicas
# =============================================================================
- name: Ensure DNS on Forest Root Replicas
  hosts: D1-DC02:D2-DC02
  gather_facts: false
  tasks:
    - name: Ensure DNS is installed and configured
      include_role:
        name: active_directory
        tasks_from: ensure_dns.yml

# =============================================================================
# PHASE 6: Promote Child Domain PDCs (serial: 2)
# =============================================================================
- name: Promote Child Domain PDCs
  hosts: D21-DC01:D22-DC01
  gather_facts: false
  serial: 2
  tasks:
    - name: Check domain status
      include_role:
        name: active_directory
        tasks_from: check_domain_status.yml

    - name: Promote to child domain PDC
      include_role:
        name: active_directory
        tasks_from: promote_child_domain.yml
      when: not is_domain_controller
      register: promotion_result

    - name: Abort if promotion failed
      fail:
        msg: |
          CRITICAL: Child domain promotion failed for {{ inventory_hostname }}
          Error: {{ promotion_result.msg | default('Unknown error') }}

          Manual cleanup required before continuing.
          Consider running Stage 0 cleanup on this DC.
      when:
        - promotion_result is defined
        - promotion_result.failed | default(false)

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"
      when:
        - promotion_result is defined
        - not (promotion_result.failed | default(false))

    - name: Wait for DC to be ready
      include_role:
        name: active_directory
        tasks_from: wait_for_dc_ready.yml
      when: promotion_result.changed | default(false)

    - name: Check FSMO roles
      include_role:
        name: active_directory
        tasks_from: check_fsmo_roles.yml

# =============================================================================
# PHASE 6.5: Ensure DNS on Child Domain PDCs
# =============================================================================
- name: Ensure DNS on Child Domain PDCs
  hosts: D21-DC01:D22-DC01
  gather_facts: false
  tasks:
    - name: Ensure DNS is installed and configured
      include_role:
        name: active_directory
        tasks_from: ensure_dns.yml

# =============================================================================
# PHASE 7: Promote Child Domain Replica DCs (serial: 2)
# =============================================================================
- name: Promote Child Domain Replica DCs
  hosts: D21-DC02:D22-DC02
  gather_facts: false
  serial: 2
  tasks:
    - name: Check domain status
      include_role:
        name: active_directory
        tasks_from: check_domain_status.yml

    - name: Promote to replica DC
      include_role:
        name: active_directory
        tasks_from: promote_replica_dc.yml
      when: not is_domain_controller
      register: promotion_result

    - name: Abort if promotion failed
      fail:
        msg: |
          CRITICAL: Replica DC promotion failed for {{ inventory_hostname }}
          Error: {{ promotion_result.msg | default('Unknown error') }}

          Manual cleanup required before continuing.
      when:
        - promotion_result is defined
        - promotion_result.failed | default(false)

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"
      when:
        - promotion_result is defined
        - not (promotion_result.failed | default(false))

    - name: Wait for DC to be ready
      include_role:
        name: active_directory
        tasks_from: wait_for_dc_ready.yml
      when: promotion_result.changed | default(false)

    - name: Verify replication
      include_role:
        name: active_directory
        tasks_from: verify_replication.yml

# =============================================================================
# PHASE 7.5: Ensure DNS on Child Domain Replicas
# =============================================================================
- name: Ensure DNS on Child Domain Replicas
  hosts: D21-DC02:D22-DC02
  gather_facts: false
  tasks:
    - name: Ensure DNS is installed and configured
      include_role:
        name: active_directory
        tasks_from: ensure_dns.yml

# =============================================================================
# PHASE 8: Final Validation
# =============================================================================
- name: Final Validation
  hosts: domain_controllers
  gather_facts: false
  tasks:
    - name: Verify all DCs are operational
      include_role:
        name: active_directory
        tasks_from: wait_for_dc_ready.yml

    - name: Verify replication health
      include_role:
        name: active_directory
        tasks_from: verify_replication.yml

- name: Consolidate Domain Information
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Create files directory
      file:
        path: "{{ playbook_dir }}/../files"
        state: directory
        mode: '0755'

    - name: Consolidate domain SIDs
      shell: |
        cat /tmp/domain-sid-*.txt > {{ playbook_dir }}/../files/domain-sids.txt 2>/dev/null || echo "# No domain SID files found"
      changed_when: false

    - name: Consolidate FSMO roles
      shell: |
        cat /tmp/fsmo-roles-*.txt > {{ playbook_dir }}/../files/fsmo-roles.txt 2>/dev/null || echo "# No FSMO files found"
      changed_when: false

    - name: Display completion message
      debug:
        msg:
          - "Active Directory deployment complete!"
          - "  D1.lab: 2 DCs"
          - "  D2.lab: 2 DCs"
          - "  D21.lab: 2 DCs"
          - "  D22.lab: 2 DCs"
          - "Total: 8 Domain Controllers"
          - ""
          - "Domain information saved to files/"
          - "  - domain-sids.txt"
          - "  - fsmo-roles.txt"

# =============================================================================
# PHASE 9: Snapshot VMs That Changed
# =============================================================================
- name: Snapshot domain controllers after AD promotion
  hosts: domain_controllers
  gather_facts: false
  serial: 2
  tasks:
    - name: Display snapshot plan
      debug:
        msg: "{{ inventory_hostname }} - Will {{ 'SNAPSHOT' if vm_changed else 'SKIP snapshot' }}"

    - name: Create Proxmox snapshot
      include_role:
        name: proxmox
        tasks_from: snapshot_vm.yml
      vars:
        snapshot_name: "stage3-ad-promoted"
        snapshot_description: "After AD forest/domain promotion"
      when: vm_changed

# =============================================================================
# PHASE 10: Deployment Summary
# =============================================================================
- name: Deployment Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Count changed VMs
      set_fact:
        changed_dcs: "{{ groups['domain_controllers'] | map('extract', hostvars, 'vm_changed') | select('equalto', true) | list | length }}"
        total_dcs: "{{ groups['domain_controllers'] | length }}"

    - name: Display snapshot summary
      debug:
        msg:
          - "========================================="
          - "AD Build Complete!"
          - "========================================="
          - ""
          - "Snapshots Created:"
          - "  Domain Controllers: {{ changed_dcs }}/{{ total_dcs }}"
          - ""
          - "{{ (total_dcs | int) - (changed_dcs | int) }} VMs were already configured and skipped"
          - ""
          - "Next: Run playbooks/adfr-4-*.yml for next stage"