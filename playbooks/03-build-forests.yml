---
- name: Build Active Directory Forest Roots
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display build plan
      debug:
        msg:
          - "========================================="
          - "  Stage 03: Build AD Forest Roots"
          - "========================================="
          - ""
          - "Forests to build:"
          - "  • d1.lab (2 DCs: D1-DC01 PDC, D1-DC02 replica)"
          - "  • d2.lab (2 DCs: D2-DC01 PDC, D2-DC02 replica)"
          - ""
          - "Duration: ~20-30 minutes"

# =============================================================================
# PHASE 0: Check if reboot is needed from snapshot rollback
# =============================================================================
- name: Check if reboot is necessary
  hosts: domain_controllers
  gather_facts: false
  serial: 0
  tasks:
    - name: Check for pending reboots
      include_role:
        name: windows
        tasks_from: check_reboot_needed.yml

- name: Reboot only if necessary
  hosts: domain_controllers
  gather_facts: false
  serial: 0
  tasks:
    - name: Reboot to clear pending state if needed
      ansible.windows.win_reboot:
        reboot_timeout: 300
        post_reboot_delay: 30
      when: reboot_needed

# =============================================================================
# PHASE 1: Initialize Change Tracking
# =============================================================================
- name: Initialize Change Tracking
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Set vm_changed to true (always snapshot after promotion)
      set_fact:
        vm_changed: true

# =============================================================================
# PHASE 2: Install AD Features + Configure DNS
# =============================================================================
- name: Install AD Features and Configure DNS
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Install AD-DS features
      include_role:
        name: active_directory
        tasks_from: install_ad_features.yml

    - name: Map dns_servers to windows_dns_servers
      set_fact:
        windows_dns_servers: "{{ dns_servers }}"

    - name: Configure DNS
      include_role:
        name: windows
        tasks_from: set_dns.yml

# =============================================================================
# PHASE 3: Promote Forest Root PDCs (parallel by domain)
# =============================================================================
- name: Promote Forest Root PDCs
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Promote to forest root PDC
      include_role:
        name: active_directory
        tasks_from: promote_forest_root.yml
      when: dc_role == 'pdc'

# =============================================================================
# PHASE 4: Wait for PDCs to be fully online (critical before replica promo)
# =============================================================================
- name: Wait for PDCs to be fully operational
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Wait for DC to be fully ready (extended wait)
      include_role:
        name: active_directory
        tasks_from: wait_for_dc_ready.yml
      when: dc_role == 'pdc'

# =============================================================================
# PHASE 5: Promote Forest Root Replica DCs
# =============================================================================
- name: Promote Forest Root Replica DCs
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Check current domain status
      include_role:
        name: active_directory
        tasks_from: check_domain_status.yml

    - name: Verify forest root PDC is reachable (one-time check)
      ansible.windows.win_shell: |
        $cred = New-Object System.Management.Automation.PSCredential("{{ netbios_name }}\Administrator", (ConvertTo-SecureString "{{ ad_safe_mode_password }}" -AsPlainText -Force))
        Get-ADDomain -Identity "{{ domain_name }}" -Credential $cred | Out-Null
        Write-Output "OK"
      retries: 5
      delay: 10
      until: pdc_reach.rc == 0
      register: pdc_reach
      changed_when: false
      when: dc_role == 'replica'

    - name: Promote to replica DC
      include_role:
        name: active_directory
        tasks_from: promote_replica_dc.yml
      when: dc_role == 'replica'

# =============================================================================
# PHASE 6: Snapshot Changed VMs
# =============================================================================
- name: Snapshot after Forest Root Promotion
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 2
  tasks:
    - name: Create Proxmox snapshot
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: "stage3-forest-roots-promoted"
        snapshot_description: "After forest root promotion (both forests ready)"

# =============================================================================
# Summary
# =============================================================================
- name: Stage 03 Complete
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion summary
      debug:
        msg:
          - ""
          - "========================================="
          - "  Stage 03 Complete!"
          - "========================================="
          - ""
          - "✓ d1.lab forest built and operational"
          - "✓ d2.lab forest built and operational"
          - "✓ All DCs promoted and replicating"
          - "✓ Snapshots created"
          - ""
          - "Next: Run playbooks/04-build-child-domains.yml"