---
- name: Build Active Directory Forest Roots
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Display build plan
      debug:
        msg:
          - "Building AD Forest Roots"
          - "  Forest 1: d1.lab (2 DCs)"
          - "  Forest 2: d2.lab (2 DCs)"
          - "Total Duration: 20-30 minutes"

# =============================================================================
# PHASE 1: Initialize (always snapshot)
# =============================================================================
- name: Initialize
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Set vm_changed to true (always snapshot)
      set_fact:
        vm_changed: true

# =============================================================================
# PHASE 2: Install AD Features on Forest Root DCs
# =============================================================================
- name: Install Active Directory Features
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Install AD-DS features
      include_role:
        name: active_directory
        tasks_from: install_ad_features.yml
      register: features_result

# =============================================================================
# PHASE 3: Configure DNS on Forest Root DCs
# =============================================================================
- name: Set DNS to point to DC IPs
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Map dns_servers to windows_dns_servers
      set_fact:
        windows_dns_servers: "{{ dns_servers }}"

    - name: Configure DNS
      include_role:
        name: windows
        tasks_from: set_dns.yml
      register: dns_result

# =============================================================================
# PHASE 4: Promote Forest Root PDCs (parallel both forests)
# =============================================================================
- name: Promote Forest Root PDCs
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Check domain status
      include_role:
        name: active_directory
        tasks_from: check_domain_status.yml

    - name: Promote to forest root PDC
      include_role:
        name: active_directory
        tasks_from: promote_forest_root.yml
      when:
        - dc_role == 'pdc'
      register: promotion_result

# =============================================================================
# PHASE 5: Comprehensive PDC Health Validation
# =============================================================================
- name: Validate PDCs are fully operational
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 1
  tasks:
    - name: Re-check domain status
      include_role:
        name: active_directory
        tasks_from: check_domain_status.yml
      when: dc_role == 'pdc'

    - name: Verify PDC can enumerate itself
      ansible.windows.win_shell: |
        $dc = Get-ADDomainController -Identity $env:COMPUTERNAME -ErrorAction Stop
        $domain = Get-ADDomain -Identity "{{ domain_name }}" -ErrorAction Stop
        [PSCustomObject]@{
          Hostname = $dc.HostName
          IsGC = $dc.IsGlobalCatalog
          OperatingSystem = $dc.OperatingSystem
          PDCEmulator = $domain.PDCEmulator
          DomainMode = $domain.DomainMode
        } | ConvertTo-Json
      register: pdc_info
      retries: 10
      delay: 20
      until: pdc_info.rc == 0
      changed_when: false
      when: dc_role == 'pdc'

    - name: Parse PDC info
      set_fact:
        pdc_details: "{{ pdc_info.stdout | from_json }}"
      when:
        - dc_role == 'pdc'
        - pdc_info.stdout is defined

    - name: Display PDC health
      debug:
        msg:
          - "{{ inventory_hostname }} - Forest Root PDC Health Check"
          - "  Hostname: {{ pdc_details.Hostname }}"
          - "  Global Catalog: {{ pdc_details.IsGC }}"
          - "  PDC Emulator: {{ pdc_details.PDCEmulator }}"
          - "  Domain Mode: {{ pdc_details.DomainMode }}"
      when:
        - dc_role == 'pdc'
        - pdc_details is defined

    - name: Check FSMO roles on PDC
      include_role:
        name: active_directory
        tasks_from: check_fsmo_roles.yml
      when: dc_role == 'pdc'

# =============================================================================
# PHASE 6: Promote Forest Root Replica DCs (parallel both forests)
# =============================================================================
- name: Promote Forest Root Replica DCs
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Check domain status
      include_role:
        name: active_directory
        tasks_from: check_domain_status.yml

    - name: Verify forest root PDC is reachable
      ansible.windows.win_shell: |
        $cred = New-Object System.Management.Automation.PSCredential("{{ netbios_name }}\Administrator", (ConvertTo-SecureString "{{ ad_safe_mode_password }}" -AsPlainText -Force))
        Get-ADDomain -Identity "{{ domain_name }}" -Credential $cred | Out-Null
        Write-Output "Forest root reachable"
      retries: 30
      delay: 10
      until: result.rc == 0
      register: result
      changed_when: false
      when: dc_role == 'replica'

    - name: Promote to replica DC
      include_role:
        name: active_directory
        tasks_from: promote_replica_dc.yml
      when: dc_role == 'replica'
      register: promotion_result

# =============================================================================
# PHASE 7: Final Validation
# =============================================================================
- name: Final Domain Health Check
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 1
  tasks:
    - name: Re-check domain status
      include_role:
        name: active_directory
        tasks_from: check_domain_status.yml

    - name: Verify DC is operational
      include_role:
        name: active_directory
        tasks_from: wait_for_dc_ready.yml
      when: is_domain_controller

    - name: Verify replication health
      include_role:
        name: active_directory
        tasks_from: verify_replication.yml
      when: is_domain_controller

    - name: Final domain enumeration test
      ansible.windows.win_shell: |
        $domain = Get-ADDomain -Identity "{{ domain_name }}" -ErrorAction Stop
        $dcs = Get-ADDomainController -Filter * -ErrorAction Stop
        [PSCustomObject]@{
          Domain = $domain.DNSRoot
          DCCount = $dcs.Count
          DCs = ($dcs.Name -join ", ")
        } | ConvertTo-Json
      register: final_check
      changed_when: false

    - name: Display final domain status
      debug:
        msg:
          - "{{ inventory_hostname }} - Final Domain Status"
          - "{{ final_check.stdout | from_json | to_nice_json }}"

# =============================================================================
# PHASE 8: Snapshots
# =============================================================================
- name: Snapshot after AD promotion
  hosts: d1_dcs:d2_parent_dcs
  gather_facts: false
  serial: 2
  tasks:
    - name: Create Proxmox snapshot
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: "stage3-forest-roots-promoted"
        snapshot_description: "After AD forest root promotion"