---
- name: Build Active Directory Forest Roots
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display build plan
      debug:
        msg:
          - "========================================="
          - "  Stage 03: Build AD Forest Roots"
          - "========================================="
          - ""
          - "Forests to build:"
          - "  • Root PDCs and Replicas"
          - ""
          - "Duration: ~20-30 minutes"

# =============================================================================
# Check Current DC Status
# =============================================================================
- name: Check Current Forest Root DC Status
  hosts: forest_root_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Check if already promoted
      include_role:
        name: active_directory
        tasks_from: check_dc_status.yml

# =============================================================================
# Skip Promotion If Already Complete
# =============================================================================
- name: Evaluate Promotion Status
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check if all forest root DCs are already promoted
      set_fact:
        all_root_dcs_promoted: "{{ groups['forest_root_dcs'] | map('extract', hostvars, 'is_domain_controller') | all }}"

    - name: Display status
      debug:
        msg:
          - "Forest Root DC Status:"
          - "  All promoted: {{ all_root_dcs_promoted }}"
          - "  Individual status:"
          - "    D1-DC01: {{ hostvars['D1-DC01'].is_domain_controller | default(false) }}"
          - "    D1-DC02: {{ hostvars['D1-DC02'].is_domain_controller | default(false) }}"
          - "    D2-DC01: {{ hostvars['D2-DC01'].is_domain_controller | default(false) }}"
          - "    D2-DC02: {{ hostvars['D2-DC02'].is_domain_controller | default(false) }}"

# =============================================================================
# Ensure Windows Ready
# =============================================================================
- name: Ensure Windows is Ready
  hosts: forest_root_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Wait for Windows to be fully ready
      include_role:
        name: windows
        tasks_from: wait_for_windows_ready.yml

# =============================================================================
# Initialize Change Tracking
# =============================================================================
- name: Initialize Change Tracking
  hosts: forest_root_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Set vm_changed to true (always snapshot after promotion)
      set_fact:
        vm_changed: true

# =============================================================================
# Install AD Features
# =============================================================================
- name: Install Active Directory Features
  hosts: forest_root_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Install AD-DS features
      include_role:
        name: active_directory
        tasks_from: install_ad_features.yml

# =============================================================================
# Promote Forest Root PDCs
# =============================================================================
- name: Promote Forest Root PDCs
  hosts: root_pdcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Promote to forest root PDC
      include_role:
        name: active_directory
        tasks_from: promote_forest_root.yml

# =============================================================================
# Promote Forest Root Replica DCs
# =============================================================================
- name: Promote Forest Root Replica DCs
  hosts: root_replicas
  gather_facts: false
  serial: 0
  tasks:
    - name: Wait for Windows to be ready before replica promotion
      include_role:
        name: windows
        tasks_from: wait_for_windows_ready.yml

    - name: Promote to replica DC
      include_role:
        name: active_directory
        tasks_from: promote_replica_dc.yml

    - name: Wait for Windows after replica promotion
      include_role:
        name: windows
        tasks_from: wait_for_windows_ready.yml

# =============================================================================
# Snapshot Changed VMs
# =============================================================================
- name: Snapshot after Forest Root Promotion
  hosts: forest_root_dcs
  gather_facts: false
  serial: 2
  tasks:
    - name: Create Proxmox snapshot if vm_changed
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: "stage3-forest-roots-promoted"
        snapshot_description: "After forest root promotion"
      when: vm_changed | default(true)

# =============================================================================
# Summary
# =============================================================================
- name: Stage 03 Complete
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion summary
      debug:
        msg:
          - ""
          - "========================================="
          - "Stage 03 Complete!"
          - "========================================="
          - ""
          - "✓ Forest roots built and operational"
          - "✓ All DCs promoted and replicating"
          - "✓ DNS SRV records verified"
          - "✓ FSMO roles verified"
          - "✓ Snapshots created"
          - ""
          - "Next: Run Stage 04 to build child domains"