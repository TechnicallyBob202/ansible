---
- name: Build Active Directory Child Domains
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Display build plan
      debug:
        msg:
          - "========================================="
          - "  Stage 04: Build AD Child Domains"
          - "========================================="
          - ""
          - "Child domains to build:"
          - "  • Child PDCs and Replicas"
          - ""
          - "REQUIRES: parent forest already built"
          - "Duration: ~30-45 minutes"

# =============================================================================
# Ensure Windows Ready
# =============================================================================
- name: Ensure Windows is Ready
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Wait for Windows to be fully ready
      include_role:
        name: windows
        tasks_from: wait_for_windows_ready.yml

# =============================================================================
# Initialize Change Tracking
# =============================================================================
- name: Initialize Change Tracking for Child Domain VMs
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Initialize vm_changed flag
      set_fact:
        vm_changed: false

# =============================================================================
# Install AD Features
# =============================================================================
- name: Install Active Directory Features
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Install AD-DS features
      include_role:
        name: active_directory
        tasks_from: install_ad_features.yml
      register: features_result

    - name: Mark VM as changed if features were installed
      set_fact:
        vm_changed: "{{ vm_changed or (features_result.changed | default(false)) }}"

# =============================================================================
# Promote Child Domain PDCs
# =============================================================================
- name: Promote Child Domain PDCs
  hosts: child_pdcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Promote to child domain PDC
      include_role:
        name: active_directory
        tasks_from: promote_child_domain.yml
      register: promotion_result

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"

# =============================================================================
# Configure DNS After Child Domain PDC Promotion
# =============================================================================
# Post-promotion DNS configuration for child PDCs:
# 1. Update NIC DNS servers to point to child DCs (dns_servers_post_promo)
# 2. Configure conditional forwarders to parent domain (dns_forwarders_parent)
# =============================================================================
- name: Configure DNS After Child Domain PDC Promotion
  hosts: child_pdcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Update DNS servers to child domain DCs
      ansible.windows.win_dns_client:
        adapter_names: '*'
        dns_servers: "{{ dns_servers_post_promo }}"
      register: dns_update
      when: dns_servers_post_promo is defined

    - name: Wait for DNS changes to take effect
      ansible.windows.win_shell: |
        Start-Sleep -Seconds 5
        $dns = Get-DnsClientServerAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"}
        Write-Output "DNS Servers: $($dns.ServerAddresses -join ', ')"
      changed_when: false
      when: dns_servers_post_promo is defined

    - name: Configure DNS conditional forwarders to parent domain
      ansible.windows.win_shell: |
        $parentDomain = "{{ parent_domain }}"
        $forwarderIPs = @({{ dns_forwarders_parent | map('quote') | join(',') }})

        try {
          # Load DNS Server module (may take a moment after promotion)
          Import-Module DnsServer -ErrorAction Stop

          # Check if conditional forwarder already exists
          $existing = Get-DnsServerConditionalForwarderZone -Name $parentDomain -ErrorAction SilentlyContinue

          if ($existing) {
            # Update existing
            Set-DnsServerConditionalForwarderZone -Name $parentDomain -MasterServers $forwarderIPs -PassThru -ErrorAction Stop | Out-Null
            Write-Output "Conditional forwarder updated for $parentDomain"
          } else {
            # Create new
            Add-DnsServerConditionalForwarderZone -Name $parentDomain -MasterServers $forwarderIPs -PassThru -ErrorAction Stop | Out-Null
            Write-Output "Conditional forwarder created for $parentDomain"
          }

          Write-Output "Forwarder IPs:"
          $forwarderIPs | ForEach-Object { Write-Output "  $_" }
          exit 0
        } catch {
          Write-Output "ERROR: $_"
          exit 1
        }
      register: forwarder_result
      when: dns_forwarders_parent is defined
      failed_when: forwarder_result.rc != 0
      retries: 3
      delay: 10
      until: forwarder_result.rc == 0

    - name: Verify forwarder resolution to parent domain
      ansible.windows.win_shell: |
        $parentDomain = "{{ parent_domain }}"

        try {
          $records = Resolve-DnsName -Name $parentDomain -Type SOA -ErrorAction Stop
          if ($records) {
            Write-Output "Forwarder resolution verified for $parentDomain"
            exit 0
          } else {
            Write-Output "WARNING: Could not resolve parent domain"
            exit 0
          }
        } catch {
          Write-Output "WARNING: Forwarder resolution check failed - $_"
          exit 0
        }
      register: forwarder_verify
      changed_when: false
      when: dns_forwarders_parent is defined

    - name: Mark VM as changed if DNS was configured
      set_fact:
        vm_changed: "{{ vm_changed or (dns_update.changed | default(false)) or (forwarder_result.changed | default(false)) }}"
      when: dns_servers_post_promo is defined or dns_forwarders_parent is defined

# =============================================================================
# Promote Child Domain Replica DCs
# =============================================================================
- name: Promote Child Domain Replica DCs
  hosts: child_replicas
  gather_facts: false
  serial: 0
  tasks:
    - name: Wait for Windows to be ready before replica promotion
      include_role:
        name: windows
        tasks_from: wait_for_windows_ready.yml

    - name: Promote to replica DC in child domain
      include_role:
        name: active_directory
        tasks_from: promote_replica_dc.yml
      register: promotion_result

    - name: Wait for Windows after replica promotion
      include_role:
        name: windows
        tasks_from: wait_for_windows_ready.yml

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"

# =============================================================================
# Configure DNS After Child Domain Replica Promotion
# =============================================================================
# Post-promotion DNS configuration for child replicas:
# 1. Update NIC DNS servers to point to child DCs (dns_servers_post_promo)
# 2. Verify conditional forwarders are already configured (by PDC)
# =============================================================================
- name: Configure DNS After Child Domain Replica Promotion
  hosts: child_replicas
  gather_facts: false
  serial: 0
  tasks:
    - name: Update DNS servers to child domain DCs
      ansible.windows.win_dns_client:
        adapter_names: '*'
        dns_servers: "{{ dns_servers_post_promo }}"
      register: dns_update
      when: dns_servers_post_promo is defined

    - name: Wait for DNS changes to take effect
      ansible.windows.win_shell: |
        Start-Sleep -Seconds 5
        $dns = Get-DnsClientServerAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"}
        Write-Output "DNS Servers: $($dns.ServerAddresses -join ', ')"
      changed_when: false
      when: dns_servers_post_promo is defined

    - name: Verify conditional forwarders were configured by PDC
      ansible.windows.win_shell: |
        $parentDomain = "{{ parent_domain }}"

        try {
          Import-Module DnsServer -ErrorAction Stop
          $existing = Get-DnsServerConditionalForwarderZone -Name $parentDomain -ErrorAction SilentlyContinue

          if ($existing) {
            Write-Output "Conditional forwarder found for $parentDomain"
            Write-Output "Forwarders:"
            $existing.MasterServers | ForEach-Object { Write-Output "  $_" }
            exit 0
          } else {
            Write-Output "Conditional forwarder not found yet"
            exit 1
          }
        } catch {
          Write-Output "Could not verify forwarders - $_"
          exit 1
        }
      register: forwarder_check
      retries: 10
      delay: 10
      until: forwarder_check.rc == 0
      when: dns_forwarders_parent is defined

    - name: Mark VM as changed if DNS was configured
      set_fact:
        vm_changed: "{{ vm_changed or (dns_update.changed | default(false)) }}"
      when: dns_servers_post_promo is defined

# =============================================================================
# Snapshot Changed VMs
# =============================================================================
- name: Snapshot after Child Domain Promotion
  hosts: child_domain_dcs
  gather_facts: false
  serial: 2
  tasks:
    - name: Display snapshot plan
      debug:
        msg: "{{ inventory_hostname }} - Will {{ 'SNAPSHOT' if vm_changed else 'SKIP snapshot' }}"

    - name: Create Proxmox snapshot
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: "stage4-child-domains-promoted"
        snapshot_description: "After AD child domain promotion with DNS forwarders"
      when: vm_changed

# =============================================================================
# Summary
# =============================================================================
- name: Display Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      debug:
        msg:
          - ""
          - "========================================="
          - "Stage 04 Complete"
          - "========================================="
          - ""
          - "✓ Child domain PDCs promoted"
          - "✓ Child domain replicas promoted"
          - "✓ DNS servers updated (NIC pointing to child DCs)"
          - "✓ Conditional forwarders configured to parent domain"
          - "✓ All DCs replicating"
          - "✓ Parent domain accessible from child domains"
          - ""
          - "Child domains are now fully operational with:"
          - "  • DNS pointing to themselves"
          - "  • Forwarders configured for parent domain resolution"
          - "  • Full trust relationship with parent"
          - ""
          - "Next: Run Stage 05 for product deployment"