---
- name: Build Active Directory Child Domains
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Display build plan
      debug:
        msg:
          - "========================================="
          - "  Stage 04: Build AD Child Domains"
          - "========================================="
          - ""
          - "Child domains to build:"
          - "  • Child PDCs and Replicas"
          - ""
          - "REQUIRES: parent forest already built"
          - "Duration: ~30-45 minutes"

# =============================================================================
# Ensure Windows Ready
# =============================================================================
- name: Ensure Windows is Ready
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Wait for Windows to be fully ready
      include_tasks: wait_for_windows_ready.yml

# =============================================================================
# Initialize Change Tracking
# =============================================================================
- name: Initialize Change Tracking for Child Domain VMs
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Initialize vm_changed flag
      set_fact:
        vm_changed: false

# =============================================================================
# DNS Delegation Setup (before any child promotions)
# =============================================================================
- name: Setup DNS Delegations for Child Domains
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display delegation setup plan
      debug:
        msg:
          - "Setting up DNS delegations for child domains..."
          - "This must complete before child domain promotions"

    - name: Check and create delegations for each child domain
      include_tasks: check_dns_delegation.yml
      loop: "{{ groups['child_pdcs'] }}"
      loop_control:
        loop_var: child_pdc_host
      vars:
        domain_name: "{{ hostvars[child_pdc_host].domain_name }}"
        parent_domain: "{{ hostvars[child_pdc_host].parent_domain }}"
        domain_netbios: "{{ hostvars[child_pdc_host].domain_netbios }}"

    - name: Create delegations for missing child domains
      include_tasks: create_dns_delegation.yml
      loop: "{{ groups['child_pdcs'] }}"
      loop_control:
        loop_var: child_pdc_host
      when: not delegation_exists
      vars:
        domain_name: "{{ hostvars[child_pdc_host].domain_name }}"
        parent_domain: "{{ hostvars[child_pdc_host].parent_domain }}"
        domain_netbios: "{{ hostvars[child_pdc_host].domain_netbios }}"

# =============================================================================
# Install AD Features
# =============================================================================
- name: Install Active Directory Features
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Install AD-DS features
      include_role:
        name: active_directory
        tasks_from: install_ad_features.yml
      register: features_result

    - name: Mark VM as changed if features were installed
      set_fact:
        vm_changed: "{{ vm_changed or (features_result.changed | default(false)) }}"

# =============================================================================
# Configure DNS
# =============================================================================
- name: Configure DNS on Child Domain DCs
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Map dns_servers to windows_dns_servers
      set_fact:
        windows_dns_servers: "{{ dns_servers }}"

    - name: Configure DNS
      include_role:
        name: windows
        tasks_from: set_dns.yml
      register: dns_result

    - name: Mark VM as changed if DNS was configured
      set_fact:
        vm_changed: "{{ vm_changed or (dns_result.changed | default(false)) }}"

# =============================================================================
# Promote Child Domain PDCs
# =============================================================================
- name: Promote Child Domain PDCs
  hosts: child_pdcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Promote to child domain PDC
      include_role:
        name: active_directory
        tasks_from: promote_child_domain.yml
      register: promotion_result

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"

# =============================================================================
# Promote Child Domain Replica DCs
# =============================================================================
- name: Promote Child Domain Replica DCs
  hosts: child_replicas
  gather_facts: false
  serial: 0
  tasks:
    - name: Wait for Windows to be ready before replica promotion
      include_tasks: wait_for_windows_ready.yml

    - name: Promote to replica DC in child domain
      include_role:
        name: active_directory
        tasks_from: promote_replica_dc.yml
      register: promotion_result

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"

# =============================================================================
# Snapshot Changed VMs
# =============================================================================
- name: Snapshot after Child Domain Promotion
  hosts: child_domain_dcs
  gather_facts: false
  serial: 2
  tasks:
    - name: Display snapshot plan
      debug:
        msg: "{{ inventory_hostname }} - Will {{ 'SNAPSHOT' if vm_changed else 'SKIP snapshot' }}"

    - name: Create Proxmox snapshot
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: "stage4-child-domains-promoted"
        snapshot_description: "After AD child domain promotion"
      when: vm_changed

# =============================================================================
# Summary
# =============================================================================
- name: Display Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      debug:
        msg:
          - ""
          - "========================================="
          - "Stage 04 Complete"
          - "========================================="
          - ""
          - "✓ DNS delegations created in parent zone"
          - "✓ Child domain PDCs promoted"
          - "✓ Child domain replica DCs promoted"
          - "✓ DNS zones created in child domains"
          - "✓ Forwarders configured to parent"
          - ""
          - "All DCs promoted, delegated, and replicating"
          - ""
          - "Next: Run Stage 05 for product deployment"