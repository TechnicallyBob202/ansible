---
- name: Build Active Directory Child Domains
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Display build plan
      debug:
        msg:
          - "========================================="
          - "  Stage 04: Build AD Child Domains"
          - "========================================="
          - ""
          - "Child domains to build:"
          - "  • d21.d2.lab (under d2.lab)"
          - "  • d22.d2.lab (under d2.lab)"
          - ""
          - "REQUIRES: d2.lab forest already built"
          - "Duration: ~20-30 minutes"

# =============================================================================
# PHASE 0: Initialize Change Tracking for All Child Domain VMs
# =============================================================================
- name: Initialize Change Tracking for All Child Domain VMs
  hosts: d21_child_dcs:d22_child_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Initialize vm_changed flag
      set_fact:
        vm_changed: false

# =============================================================================
# PHASE 1: Install AD Features on Child Domain DCs
# =============================================================================
- name: Install Active Directory Features
  hosts: d21_child_dcs:d22_child_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Install AD-DS features
      include_role:
        name: active_directory
        tasks_from: install_ad_features.yml
      register: features_result

    - name: Mark VM as changed if features were installed
      set_fact:
        vm_changed: "{{ vm_changed or (features_result.changed | default(false)) }}"

# =============================================================================
# PHASE 2: Configure DNS on Child Domain DCs
# =============================================================================
- name: Configure DNS on Child Domain DCs
  hosts: d21_child_dcs:d22_child_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Map dns_servers to windows_dns_servers (includes all DCs for this domain)
      set_fact:
        windows_dns_servers: "{{ dns_servers }}"

    - name: Configure DNS
      include_role:
        name: windows
        tasks_from: set_dns.yml
      register: dns_result

    - name: Mark VM as changed if DNS was configured
      set_fact:
        vm_changed: "{{ vm_changed or (dns_result.changed | default(false)) }}"

# =============================================================================
# PHASE 3: Promote Child Domain PDCs
# =============================================================================
- name: Promote Child Domain PDCs
  hosts: d21_child_dcs:d22_child_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Promote to child domain PDC
      include_role:
        name: active_directory
        tasks_from: promote_child_domain.yml
      when:
        - not is_domain_controller
        - dc_role == 'pdc'
      register: promotion_result

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"

# =============================================================================
# PHASE 4: Promote Child Domain Replica DCs
# =============================================================================
- name: Promote Child Domain Replica DCs
  hosts: d21_child_dcs:d22_child_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Promote to replica DC
      include_role:
        name: active_directory
        tasks_from: promote_replica_dc.yml
      when:
        - not is_domain_controller
        - dc_role == 'replica'
      register: promotion_result

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"

# =============================================================================
# PHASE 5: Snapshots (only for changed VMs)
# =============================================================================
- name: Snapshot after AD promotion
  hosts: d21_child_dcs:d22_child_dcs
  gather_facts: false
  serial: 2
  tasks:
    - name: Display snapshot plan
      debug:
        msg: "{{ inventory_hostname }} - Will {{ 'SNAPSHOT' if vm_changed else 'SKIP snapshot' }}"

    - name: Create Proxmox snapshot
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: "stage4-child-domains-promoted"
        snapshot_description: "After AD child domain promotion"
      when: vm_changed

# =============================================================================
# PHASE 7: Summary
# =============================================================================
- name: Display Summary
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display completion message
      debug:
        msg:
          - ""
          - "========================================="
          - "Stage 04 Complete"
          - "========================================="
          - ""
          - "Child domains built:"
          - "  • d21.d2.lab"
          - "  • d22.d2.lab"
          - ""
          - "All DCs promoted and replicating"
          - ""
          - "Next: Run Stage 05 to create OUs and populate dummy data"