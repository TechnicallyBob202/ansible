---
- name: Build Active Directory Child Domains
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Display build plan
      debug:
        msg:
          - "========================================="
          - "  Stage 04: Build AD Child Domains"
          - "========================================="
          - ""
          - "Child domains to build:"
          - "  • Child PDCs and Replicas"
          - ""
          - "REQUIRES: parent forest already built"
          - "Duration: ~30-45 minutes"

# =============================================================================
# Check Current DC Status
# =============================================================================
- name: Check Current Child Domain DC Status
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Check if already promoted
      include_role:
        name: active_directory
        tasks_from: check_dc_status.yml

# =============================================================================
# Skip Promotion If Already Complete
# =============================================================================
- name: Evaluate Promotion Status
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check if all child DCs are already promoted
      set_fact:
        all_child_dcs_promoted: "{{ (groups['child_domain_dcs'] | map('extract', hostvars, 'is_domain_controller') | list) == ([True] * (groups['child_domain_dcs'] | length)) }}"

    - name: Display status
      debug:
        msg:
          - "Child Domain DC Status:"
          - "  All promoted: {{ all_child_dcs_promoted }}"
          - "  Individual status:"
          - "    D21-DC01: {{ hostvars['D21-DC01'].is_domain_controller | default(false) }}"
          - "    D21-DC02: {{ hostvars['D21-DC02'].is_domain_controller | default(false) }}"
          - "    D22-DC01: {{ hostvars['D22-DC01'].is_domain_controller | default(false) }}"
          - "    D22-DC02: {{ hostvars['D22-DC02'].is_domain_controller | default(false) }}"

# =============================================================================
# Skip remaining plays if all child DCs already promoted
# =============================================================================
- name: Set Skip Flag
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check if all child DCs already promoted
      set_fact:
        skip_promotion_plays: "{{ (groups['child_domain_dcs'] | map('extract', hostvars, 'is_domain_controller') | list) == ([True] * (groups['child_domain_dcs'] | length)) }}"

# =============================================================================
# Ensure Windows Ready
# =============================================================================
- name: Ensure Windows is Ready
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Wait for Windows to be fully ready
      include_role:
        name: windows
        tasks_from: wait_for_windows_ready.yml
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

# =============================================================================
# Initialize Change Tracking
# =============================================================================
- name: Initialize Change Tracking for Child Domain VMs
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Initialize vm_changed flag
      set_fact:
        vm_changed: false
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

# =============================================================================
# Install AD Features
# =============================================================================
- name: Install Active Directory Features
  hosts: child_domain_dcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Install AD-DS features
      include_role:
        name: active_directory
        tasks_from: install_ad_features.yml
      register: features_result
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Mark VM as changed if features were installed
      set_fact:
        vm_changed: "{{ vm_changed or (features_result.changed | default(false)) }}"
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

# =============================================================================
# Promote Child Domain PDCs
# =============================================================================
- name: Promote Child Domain PDCs
  hosts: child_pdcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Promote to child domain PDC
      include_role:
        name: active_directory
        tasks_from: promote_child_domain.yml
      register: promotion_result
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

# Configure DNS After Child Domain PDC Promotion
# =============================================================================
# After child domain PDC promotion:
# 1. Update NIC DNS servers to point to child DCs (dns_servers_post_promo)
# =============================================================================
- name: Configure DNS After Child Domain PDC Promotion
  hosts: child_pdcs
  gather_facts: false
  serial: 0
  tasks:
    - name: Update DNS servers to child domain DCs
      ansible.windows.win_dns_client:
        adapter_names: '*'
        dns_servers: "{{ dns_servers_post_promo }}"
      register: dns_update
      when: dns_servers_post_promo is defined and not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Wait for DNS changes to take effect
      ansible.windows.win_shell: |
        Start-Sleep -Seconds 5
        $dns = Get-DnsClientServerAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"}
        Write-Output "DNS Servers: $($dns.ServerAddresses -join ', ')"
      changed_when: false
      when: dns_servers_post_promo is defined and not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Mark VM as changed if DNS was configured
      set_fact:
        vm_changed: "{{ vm_changed or (dns_update.changed | default(false)) }}"
      when: dns_servers_post_promo is defined and not hostvars['localhost'].skip_promotion_plays | default(false)

# =============================================================================
# Configure DNS on Replicas Before Promotion
# =============================================================================
# Replicas need to point to the child PDC to contact it during promotion
# =============================================================================
- name: Configure DNS on Child Domain Replicas Before Promotion
  hosts: child_replicas
  gather_facts: false
  serial: 0
  tasks:
    - name: Update DNS to child PDC before replica promotion
      ansible.windows.win_dns_client:
        adapter_names: '*'
        dns_servers: "{{ dns_servers_post_promo }}"
      register: dns_update
      when: dns_servers_post_promo is defined and not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Wait for DNS changes to take effect
      ansible.windows.win_shell: |
        Start-Sleep -Seconds 5
        $dns = Get-DnsClientServerAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"}
        Write-Output "DNS Servers: $($dns.ServerAddresses -join ', ')"
      changed_when: false
      when: dns_servers_post_promo is defined and not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Brief pause to let DNS settle
      pause:
        seconds: 10
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

# =============================================================================
# Promote Child Domain Replica DCs
# =============================================================================
- name: Promote Child Domain Replica DCs
  hosts: child_replicas
  gather_facts: false
  serial: 0
  tasks:
    - name: Wait for Windows to be ready before replica promotion
      include_role:
        name: windows
        tasks_from: wait_for_windows_ready.yml
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Promote to replica DC in child domain
      include_role:
        name: active_directory
        tasks_from: promote_replica_dc.yml
      register: promotion_result
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Wait for Windows after replica promotion
      include_role:
        name: windows
        tasks_from: wait_for_windows_ready.yml
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Mark VM as changed if promoted
      set_fact:
        vm_changed: "{{ vm_changed or (promotion_result.changed | default(false)) }}"
      when: not hostvars['localhost'].skip_promotion_plays | default(false)

# =============================================================================
# Configure DNS After Child Domain Replica Promotion
# =============================================================================
# After child domain replica promotion:
# 1. Update NIC DNS servers to point to child DCs (dns_servers_post_promo)
# =============================================================================
- name: Configure DNS After Child Domain Replica Promotion
  hosts: child_replicas
  gather_facts: false
  serial: 0
  tasks:
    - name: Update DNS servers to child domain DCs
      ansible.windows.win_dns_client:
        adapter_names: '*'
        dns_servers: "{{ dns_servers_post_promo }}"
      register: dns_update
      when: dns_servers_post_promo is defined and not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Wait for DNS changes to take effect
      ansible.windows.win_shell: |
        Start-Sleep -Seconds 5
        $dns = Get-DnsClientServerAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"}
        Write-Output "DNS Servers: $($dns.ServerAddresses -join ', ')"
      changed_when: false
      when: dns_servers_post_promo is defined and not hostvars['localhost'].skip_promotion_plays | default(false)

    - name: Mark VM as changed if DNS was configured
      set_fact:
        vm_changed: "{{ vm_changed or (dns_update.changed | default(false)) }}"
      when: dns_servers_post_promo is defined and not hostvars['localhost'].skip_promotion_plays | default(false)

# =============================================================================
# Snapshot Changed VMs
# =============================================================================
- name: Snapshot after Child Domain Promotion
  hosts: child_domain_dcs
  gather_facts: false
  serial: 2
  tasks:
    - name: Check if snapshot already exists
      ansible.builtin.shell: |
        ssh -i /root/.ssh/ansible_key \
          -o StrictHostKeyChecking=no \
          root@{{ proxmox_host }} \
          "qm snapshot {{ vmid }} stage4-child-domains-promoted --list 2>/dev/null | grep -q stage4-child-domains-promoted"
      delegate_to: localhost
      register: snapshot_check
      failed_when: false
      changed_when: false

    - name: Create Proxmox snapshot if vm_changed or snapshot doesn't exist
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: "stage4-child-domains-promoted"
        snapshot_description: "After AD child domain promotion with DNS updates"
      when: vm_changed | default(false) or snapshot_check.rc != 0

# =============================================================================
# Summary
# =============================================================================
- name: Display Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      debug:
        msg:
          - ""
          - "========================================="
          - "Stage 04 Complete"
          - "========================================="
          - ""
          - "✓ Child domain PDCs promoted"
          - "✓ Child domain replicas promoted"
          - "✓ DNS servers updated (NIC pointing to child DCs)"
          - "✓ All DCs replicating"
          - ""
          - "Child domains are now fully operational"
          - ""
          - "Next: Run Stage 05 for product deployment"