# playbooks/debug-robocopy.yml
---
- name: Debug Robocopy Issue
  hosts: ATLAS
  gather_facts: no

  tasks:
    - name: Display variables being used
      debug:
        msg:
          - "adfr_smb_source: {{ adfr_smb_source }}"
          - "adfr_local_path: {{ adfr_local_path }}"
          - "adfr_version: {{ adfr_version }}"

    - name: Test 1 - Can we see the share root?
      ansible.windows.win_shell: |
        Test-Path "\\192.168.33.13\Semperis"
      register: share_test

    - name: Display share test
      debug:
        var: share_test.stdout_lines

    - name: Test 2 - Can we list source files?
      ansible.windows.win_shell: |
        $source = "{{ adfr_smb_source }}"
        Write-Output "Testing source: $source"
        if (Test-Path $source) {
          Write-Output "Source exists: True"
          Get-ChildItem $source | Select-Object Name, Length | Format-Table -AutoSize | Out-String
        } else {
          Write-Output "Source exists: False"
        }
      register: list_test
      failed_when: false

    - name: Display file list
      debug:
        var: list_test.stdout_lines

    - name: Test 3 - Manual robocopy with verbose output
      ansible.windows.win_shell: |
        $source = "{{ adfr_smb_source }}"
        $dest = "{{ adfr_local_path }}"

        Write-Output "Source: $source"
        Write-Output "Dest: $dest"
        Write-Output "Source exists: $(Test-Path $source)"
        Write-Output "Dest exists: $(Test-Path $dest)"
        Write-Output ""

        # Ensure dest exists
        if (-not (Test-Path $dest)) {
          New-Item -Path $dest -ItemType Directory -Force | Out-Null
        }

        # Run robocopy with full logging
        robocopy "$source" "$dest" /E /V /LOG:C:\robocopy-debug.log

        $exitCode = $LASTEXITCODE
        Write-Output ""
        Write-Output "Exit code: $exitCode"
        Write-Output ""
        Write-Output "=== Last 50 lines of log ==="
        if (Test-Path C:\robocopy-debug.log) {
          Get-Content C:\robocopy-debug.log -Tail 50
        } else {
          Write-Output "Log file not created"
        }
      register: manual_robocopy
      failed_when: false

    - name: Display manual robocopy results
      debug:
        var: manual_robocopy.stdout_lines

    - name: Test 4 - Check what's in destination
      ansible.windows.win_shell: |
        $dest = "{{ adfr_local_path }}"
        if (Test-Path $dest) {
          Write-Output "Destination exists"
          $items = Get-ChildItem $dest -Recurse -ErrorAction SilentlyContinue
          Write-Output "Total items: $($items.Count)"
          Write-Output ""
          Write-Output "Top-level contents:"
          Get-ChildItem $dest | Select-Object Name, Length, Mode | Format-Table -AutoSize | Out-String
        } else {
          Write-Output "$dest does not exist"
        }
      register: dest_check

    - name: Display destination contents
      debug:
        var: dest_check.stdout_lines