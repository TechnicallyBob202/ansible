---
- name: Build alpine.lab Forest Root Domain
  hosts: alpine_forest_root_pdc
  gather_facts: no
  vars:
    windows_password: "{{ lookup('env','WINDOWS_PASSWORD') }}"
    domain_name: "alpine.lab"

  tasks:
    - name: Check domain status
      include_tasks: ../tasks/check-domain-exists.yml

    - name: Store domain facts to localhost
      set_fact:
        alpine_domain_exists: "{{ domain_exists }}"
        alpine_domain_sid: "{{ domain_sid }}"
      delegate_to: localhost
      delegate_facts: yes

    - name: Install AD-DS if domain doesn't exist
      include_tasks: ../tasks/install-adds.yml
      when: not hostvars['localhost']['alpine_domain_exists']

    - name: Promote to forest root PDC
      include_tasks: ../tasks/promote-forest-root-pdc.yml
      vars:
        domain_dns_name: "alpine.lab"
        domain_netbios_name: "ALPINE"
      when: not hostvars['localhost']['alpine_domain_exists']

    - name: Update domain SID fact
      set_fact:
        alpine_domain_sid: "{{ domain_sid }}"
      delegate_to: localhost
      delegate_facts: yes
      when: 
        - not hostvars['localhost']['alpine_domain_exists']
        - domain_sid is defined

- name: Add alpine.lab Replica DC
  hosts: alpine_forest_root_replica
  gather_facts: no
  vars:
    windows_password: "{{ lookup('env','WINDOWS_PASSWORD') }}"

  tasks:
    - name: Check DC status
      include_tasks: ../tasks/check-dc-status.yml

    - name: Install AD-DS if not a DC
      include_tasks: ../tasks/install-adds.yml
      when: not is_domain_controller

    - name: Promote to replica DC
      include_tasks: ../tasks/promote-replica-dc.yml
      vars:
        domain_dns_name: "alpine.lab"
        domain_admin_user: "ALPINE\\Administrator"
      when: not is_domain_controller

    - name: Verify DC promotion
      include_tasks: ../tasks/verify-dc-promotion.yml
      when: not is_domain_controller

- name: Save alpine.lab Domain SID
  hosts: localhost
  gather_facts: yes
  tasks:
    - name: Save SID to file
      include_tasks: ../tasks/save-domain-sid.yml
      vars:
        domain_name: "alpine.lab"
        domain_sid: "{{ hostvars['localhost']['alpine_domain_sid'] }}"
        output_file: "alpine-domain-sid.txt"
