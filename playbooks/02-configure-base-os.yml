---
# =============================================================================
# WINDOWS VMS - Discover IPs and Configure Static Network
# =============================================================================
- name: Discover IPs and Configure Static Network (Windows)
  hosts: all
  gather_facts: false

  tasks:
    - name: Display configuration plan
      debug:
        msg: "Configuring network for {{ groups['all'] | length }} VMs (Windows + Linux)"
      run_once: true

    - name: Initialize change tracking
      set_fact:
        vm_changed: false

# =============================================================================
# PHASE 1: Discover Current IPs (Windows only)
# =============================================================================
- name: Discover Current IPs (Windows)
  hosts: all:!linux_infrastructure
  gather_facts: false
  serial: 0

  tasks:
    - name: Save target static IP from inventory
      set_fact:
        target_ip: "{{ ansible_host }}"
      when: ansible_connection == 'winrm'

    - name: Discover current IP from Proxmox
      include_role:
        name: windows
        tasks_from: discover_ip.yml
      when: ansible_connection == 'winrm'

    - name: Check if IP already matches target
      set_fact:
        needs_ip_config: "{{ discovered_ip != target_ip }}"
      when: ansible_connection == 'winrm'

    - name: Update ansible_host to discovered IP
      set_fact:
        ansible_host: "{{ discovered_ip }}"
      when: ansible_connection == 'winrm'

    - name: Display IP status (Windows)
      debug:
        msg: "{{ inventory_hostname }}: Current={{ discovered_ip }}, Target={{ target_ip }}, NeedsConfig={{ needs_ip_config }}"
      when: ansible_connection == 'winrm'

# =============================================================================
# PHASE 2: Configure Static IPs (Windows)
# =============================================================================
- name: Configure Static IP Addresses (Windows)
  hosts: all:!linux_infrastructure
  gather_facts: false
  serial: 0

  tasks:
    - name: Set static IP
      include_role:
        name: windows
        tasks_from: set_static_ip.yml
      when:
        - ansible_connection == 'winrm'
        - needs_ip_config
      register: ip_result

    - name: Mark VM as changed if IP was configured
      set_fact:
        vm_changed: "{{ vm_changed | default(false) or (ip_result.changed | default(false)) }}"
      when: ansible_connection == 'winrm'

    - name: Update ansible_host to static IP
      set_fact:
        ansible_host: "{{ target_ip }}"
      when:
        - ansible_connection == 'winrm'
        - needs_ip_config

    - name: Wait for all IPs to settle
      pause:
        seconds: 10
      run_once: true
      when: hostvars | dict2items | selectattr('value.needs_ip_config', 'defined') | selectattr('value.needs_ip_config', 'equalto', true) | list | length > 0

# =============================================================================
# PHASE 3: Configure DNS and Hostname (Windows)
# =============================================================================
- name: Configure DNS and Hostname (Windows)
  hosts: all:!linux_infrastructure
  gather_facts: false
  serial: 0

  tasks:
    - name: Configure DNS servers
      include_role:
        name: windows
        tasks_from: set_dns.yml
      when: ansible_connection == 'winrm'
      register: dns_result

    - name: Mark VM as changed if DNS was configured
      set_fact:
        vm_changed: "{{ vm_changed | default(false) or (dns_result.changed | default(false)) }}"
      when: ansible_connection == 'winrm'

    - name: Set hostname
      include_role:
        name: windows
        tasks_from: set_hostname.yml
      when: ansible_connection == 'winrm'
      register: hostname_result

    - name: Mark VM as changed if hostname was set
      set_fact:
        vm_changed: "{{ vm_changed | default(false) or (hostname_result.changed | default(false)) }}"
      when: ansible_connection == 'winrm'

# =============================================================================
# PHASE 4: Reboot Windows hosts that need it
# =============================================================================
- name: Reboot hosts that changed hostname (Windows)
  hosts: all:!linux_infrastructure
  gather_facts: false
  serial: 0

  tasks:
    - name: Reboot if needed
      include_role:
        name: windows
        tasks_from: reboot.yml
      when:
        - ansible_connection == 'winrm'
        - reboot_required | default(false)
      register: reboot_result

    - name: Mark VM as changed if rebooted
      set_fact:
        vm_changed: "{{ vm_changed | default(false) or (reboot_result.changed | default(false)) }}"
      when: ansible_connection == 'winrm'

# =============================================================================
# PHASE 5: Configure Linux VMs
# =============================================================================
- name: Configure Linux VMs
  hosts: linux_infrastructure
  gather_facts: false
  serial: 1
  vars:
    ansible_connection: ssh
    ansible_user: blyons
    ansible_python_interpreter: /usr/bin/python3
    # become to root if blyons is non-root with sudo
    ansible_become: true
    ansible_become_method: sudo

    linux_operation: configure_network
    linux_gateway: "{{ windows_gateway | default('192.168.35.1') }}"
    linux_dns_servers: "{{ windows_dns_servers | default(['1.1.1.1','1.0.0.1']) }}"
    linux_ip_prefix: "{{ windows_ip_prefix | default(24) }}"
  tasks:
    - name: Display Linux VM configuration
      debug:
        msg: "Configuring Linux VM: {{ inventory_hostname }} at {{ ansible_ssh_host }} -> {{ ansible_host }}"

    - name: Configure Linux network
      include_role:
        name: linux
      register: linux_result

    - name: Mark Linux VM as changed
      set_fact:
        vm_changed: "{{ linux_result.changed | default(true) }}"

# =============================================================================
# PHASE 6: Validation (Windows)
# =============================================================================
- name: Validate Configuration (Windows)
  hosts: all:!linux_infrastructure
  gather_facts: false

  tasks:
    - name: Get network configuration
      ansible.windows.win_shell: |
        $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
        $ip = Get-NetIPAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4
        $dns = Get-DnsClientServerAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4

        [PSCustomObject]@{
          Hostname = $env:COMPUTERNAME
          IPAddress = $ip.IPAddress
          DNS = $dns.ServerAddresses -join ","
        } | ConvertTo-Json
      register: network_info
      changed_when: false
      when: ansible_connection == 'winrm'

    - name: Parse network information
      set_fact:
        network_config: "{{ network_info.stdout | from_json }}"
      when: ansible_connection == 'winrm'

    - name: Validate configuration (Windows)
      debug:
        msg:
          - "{{ inventory_hostname }}:"
          - "  IP: {{ network_config.IPAddress }} (expected: {{ ansible_host }})"
          - "  Hostname: {{ network_config.Hostname }} (expected: {{ inventory_hostname }})"
          - "  DNS: {{ network_config.DNS }}"
          - "  Changed: {{ vm_changed | default(false) }}"
      when: ansible_connection == 'winrm'

    - name: Validate configuration (Linux)
      debug:
        msg:
          - "{{ inventory_hostname }}:"
          - "  IP: {{ ansible_host }}"
          - "  Type: Linux/RHEL"
          - "  Changed: {{ vm_changed | default(false) }}"
      when: ansible_connection == 'ssh'

    - name: Summary
      debug:
        msg: "All {{ groups['all'] | length }} VMs configured successfully"
      run_once: true

# =============================================================================
# PHASE 7: Snapshot (only changed VMs)
# =============================================================================
- name: Snapshot after base OS configuration
  hosts: all
  gather_facts: false
  serial: 2

  tasks:
    - name: Take snapshot - only for changed VMs
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: post-config
      when: vm_changed | default(false)

# =============================================================================
# PHASE 8: Final Summary
# =============================================================================
- name: Configuration Summary
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Count changed VMs by type
      set_fact:
        changed_windows: "{{ groups['all'] | map('extract', hostvars) | selectattr('ansible_connection', 'equalto', 'winrm') | selectattr('vm_changed', 'defined') | selectattr('vm_changed', 'equalto', true) | list | length }}"
        changed_linux: "{{ groups['linux_infrastructure'] | default([]) | map('extract', hostvars, 'vm_changed') | select('equalto', true) | list | length }}"
        total_windows: "{{ groups['all'] | map('extract', hostvars) | selectattr('ansible_connection', 'equalto', 'winrm') | list | length }}"
        total_linux: "{{ groups['linux_infrastructure'] | default([]) | length }}"

    - name: Calculate totals
      set_fact:
        total_changed: "{{ (changed_windows | int) + (changed_linux | int) }}"
        total_vms: "{{ (total_windows | int) + (total_linux | int) }}"

    - name: Display summary
      debug:
        msg:
          - "Configuration complete:"
          - "  Windows VMs: {{ changed_windows }}/{{ total_windows }} modified"
          - "  Linux VMs: {{ changed_linux }}/{{ total_linux }} modified"
          - "  Total: {{ total_changed }}/{{ total_vms }} VMs modified"
          - "  Snapshots created for {{ total_changed }} VMs"