---
- name: Stage 02 - Configure Base OS
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display stage introduction
      debug:
        msg:
          - "========================================="
          - "  Stage 02: Configure Base OS"
          - "========================================="
          - ""
          - "Configuring {{ groups['all'] | length }} VMs:"
          - "  • Wait for VMs to fully boot"
          - "  • Discover current IPs"
          - "  • Configure static IPs"
          - "  • Set DNS servers"
          - "  • Set hostnames"
          - "  • Install AD-DS features (DCs only)"
          - "  • Reboot if needed"
          - "  • Snapshot changed VMs"

# =============================================================================
# Check Current DC Promotion Status
# =============================================================================
- name: Check Current DC Promotion Status
  hosts: domain_controllers
  gather_facts: false
  serial: 0
  tasks:
    - name: Check if server is a domain controller
      ansible.windows.win_shell: |
        $CS = Get-WmiObject Win32_ComputerSystem
        if ($CS.DomainRole -ge 4) { exit 0 }
        exit 1
      register: dc_check
      failed_when: false
      changed_when: false

    - name: Set is_domain_controller fact
      set_fact:
        is_domain_controller: "{{ dc_check.rc == 0 }}"
      changed_when: false

# =============================================================================
# Check Current Configuration Status
# =============================================================================
- name: Check Current VM Configuration Status
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Check if VM is already running and accessible
      ansible.windows.win_ping:
      register: ping_result
      failed_when: false
      changed_when: false

    - name: Get current network configuration if accessible
      ansible.windows.win_shell: |
        $nic = Get-NetIPConfiguration -InterfaceAlias 'Ethernet*' | Select-Object -First 1
        $hostname = $env:COMPUTERNAME
        $dns = (Get-DnsClientServerAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"}).ServerAddresses

        Write-Output "Hostname: $hostname"
        Write-Output "IP: $($nic.IPv4Address.IPAddress)"
        Write-Output "DNS: $($dns -join ', ')"
      register: current_config
      when: ping_result.unreachable is not defined
      failed_when: false
      changed_when: false

    - name: Set configuration status facts
      set_fact:
        vm_accessible: "{{ ping_result.unreachable is not defined }}"
        current_hostname: "{{ (current_config.stdout_lines[0] | regex_search('Hostname: (.+)') | regex_replace('Hostname: ', '')) if current_config.rc == 0 else 'UNKNOWN' }}"
        current_ip: "{{ (current_config.stdout_lines[1] | regex_search('IP: (.+)') | regex_replace('IP: ', '')) if current_config.rc == 0 else 'UNKNOWN' }}"
      changed_when: false

# =============================================================================
# Display Configuration Status
# =============================================================================
- name: Display Configuration Status
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display VM status summary
      debug:
        msg:
          - "VM Configuration Status:"
          - "  Total VMs: {{ groups['all'] | length }}"
          - "  Accessible: {{ groups['all'] | map('extract', hostvars, 'vm_accessible') | select('equalto', true) | list | length }}"
          - "  Will proceed with configuration checks and updates"

# =============================================================================
# Initialize Change Tracking
# =============================================================================
- name: Initialize Change Tracking
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Initialize vm_changed flag
      set_fact:
        vm_changed: false

# =============================================================================
# Discover Current IPs from Proxmox
# =============================================================================
- name: Discover Current IPs
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Save target static IP
      set_fact:
        target_ip: "{{ ansible_host }}"

    - name: Discover current IP from Proxmox (with retries)
      block:
        - name: Include IP discovery role
          include_role:
            name: proxmox
            apply:
              delegate_to: localhost
          vars:
            proxmox_operation: discover_ip
          register: ip_discovery_result
      rescue:
        - name: Wait before retry
          pause:
            seconds: 15
          delegate_to: localhost

        - name: Retry IP discovery (attempt 2)
          include_role:
            name: proxmox
            apply:
              delegate_to: localhost
          vars:
            proxmox_operation: discover_ip
          register: ip_discovery_result

    - name: Determine if IP config is needed
      set_fact:
        needs_ip_config: "{{ (discovered_ip | default('')) != target_ip }}"

    - name: Display IP status
      debug:
        msg: "{{ inventory_hostname }}: {{ discovered_ip | default('UNKNOWN') }} → {{ target_ip }} {{ '(already correct)' if not needs_ip_config else '(needs config)' }}"

# =============================================================================
# Build groups for conditional network configuration
# =============================================================================
- name: Separate hosts by network config needs
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Create group for hosts needing network config
      group_by:
        key: "needs_network_config_{{ 'yes' if (hostvars[inventory_hostname].get('needs_ip_config', false) | bool) else 'no' }}"
      changed_when: false

# =============================================================================
# Configure Network (Windows - Only hosts needing config)
# =============================================================================
- name: Configure Windows Static IPs
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Update ansible_host to discovered IP (for hosts needing config)
      set_fact:
        ansible_host: "{{ discovered_ip }}"
      when:
        - needs_ip_config | default(false)
        - ansible_connection == 'winrm'
        - discovered_ip is defined
        - discovered_ip != ''

    - name: Set static IP address
      include_role:
        name: windows
        tasks_from: set_static_ip
      register: ip_result
      when:
        - needs_ip_config | default(false)
        - ansible_connection == 'winrm'

    - name: Consolidate IP changes
      set_fact:
        vm_changed: "{{ vm_changed or (ip_result.changed | default(false)) }}"
      when:
        - needs_ip_config | default(false)
        - ansible_connection == 'winrm'

    - name: Update ansible_host to target IP (after config)
      set_fact:
        ansible_host: "{{ target_ip }}"
      when:
        - needs_ip_config | default(false)
        - ansible_connection == 'winrm'
        - ip_result.changed | default(false)

    - name: Wait for IP to settle after static config
      pause:
        seconds: 10
      when:
        - needs_ip_config | default(false)
        - ansible_connection == 'winrm'
        - ip_result.changed | default(false)

    - name: Test WinRM on new static IP
      ansible.windows.win_ping:
      retries: 30
      delay: 10
      until: ping_static is succeeded
      register: ping_static
      failed_when: ping_static is failed
      when:
        - needs_ip_config | default(false)
        - ansible_connection == 'winrm'
        - ip_result.changed | default(false)

# =============================================================================
# Configure DNS and Hostname (Windows - All windows hosts)
# =============================================================================
- name: Configure Windows DNS and Hostname
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Check if this is a domain controller
      ansible.windows.win_shell: |
        $CS = Get-WmiObject Win32_ComputerSystem
        if ($CS.DomainRole -lt 4) { exit 1 }
        exit 0
      register: dc_check
      failed_when: false
      changed_when: false
      when: ansible_connection == 'winrm'

    - name: Determine DNS servers based on DC promotion status
      set_fact:
        windows_dns_servers: >-
          {{
            dns_servers_post_promo if (dns_servers_post_promo is defined and is_domain_controller | default(false))
            else dns_servers_pre_promo if (dns_servers_pre_promo is defined and not (is_domain_controller | default(false)))
            else dns_servers if (dns_servers is defined)
            else ['1.1.1.1', '1.0.0.1']
          }}
      when: ansible_connection == 'winrm'

    - name: Configure DNS servers
      include_role:
        name: windows
        tasks_from: set_dns
      register: dns_result
      when: ansible_connection == 'winrm'

    - name: Set hostname
      include_role:
        name: windows
        tasks_from: set_hostname
      register: hostname_result
      when: ansible_connection == 'winrm'

    - name: Consolidate DNS and hostname changes
      set_fact:
        vm_changed: "{{ vm_changed or (dns_result.changed | default(false)) or (hostname_result.changed | default(false)) }}"
      when: ansible_connection == 'winrm'

# =============================================================================
# Configure Network (Linux - Only hosts needing config)
# =============================================================================
- name: Configure Linux Static IPs
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Set static IP
      include_role:
        name: linux
        tasks_from: set_static_ip
      register: ip_result
      when:
        - (needs_ip_config | default(false)) or (secondary_ip is defined)
        - ansible_connection != 'winrm'

    - name: Consolidate IP changes
      set_fact:
        vm_changed: "{{ vm_changed or (ip_result.changed | default(false)) }}"
      when:
        - (needs_ip_config | default(false)) or (secondary_ip is defined)
        - ansible_connection != 'winrm'

    - name: Update ansible_host to target IP
      set_fact:
        ansible_host: "{{ target_ip }}"
      when:
        - (needs_ip_config | default(false)) or (secondary_ip is defined)
        - ansible_connection != 'winrm'
        - ip_result.changed | default(false)

    - name: Wait for IP to settle
      pause:
        seconds: 10
      when:
        - (needs_ip_config | default(false)) or (secondary_ip is defined)
        - ansible_connection != 'winrm'
        - ip_result.changed | default(false)

    - name: Update system packages
      include_role:
        name: linux
        tasks_from: update
      when:
        - vm_changed
        - ansible_connection != 'winrm'

    - name: Reboot if changes were made
      include_role:
        name: linux
        tasks_from: reboot
      when:
        - vm_changed
        - ansible_connection != 'winrm'

# =============================================================================
# Install AD-DS Features (Domain Controllers Only)
# =============================================================================
- name: Install AD-DS Features on Domain Controllers
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Verify WinRM connectivity before installing features
      ansible.windows.win_ping:
      retries: 5
      delay: 5
      register: promo_ping_test
      failed_when: promo_ping_test is failed
      when:
        - "'domain_controllers' in group_names"
        - ansible_connection == 'winrm'

    - name: Install Active Directory Domain Services features
      include_role:
        name: active_directory
        tasks_from: install_ad_features
      register: adds_install_result
      when:
        - "'domain_controllers' in group_names"
        - ansible_connection == 'winrm'

    - name: Consolidate AD-DS changes
      set_fact:
        vm_changed: "{{ vm_changed or (adds_install_result.changed | default(false)) }}"
      when:
        - "'domain_controllers' in group_names"
        - ansible_connection == 'winrm'

# =============================================================================
# Check for Pending Reboots (Windows)
# =============================================================================
- name: Check if reboot is necessary (Windows)
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Check for pending reboots
      include_role:
        name: windows
        tasks_from: check_reboot_needed
      when: ansible_connection == 'winrm'

# =============================================================================
# Reboot Windows Hosts if Needed
# =============================================================================
- name: Reboot Windows Hosts
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Reboot to clear pending state if needed
      ansible.windows.win_reboot:
        reboot_timeout: 300
        post_reboot_delay: 30
      when:
        - ansible_connection == 'winrm'
        - (reboot_needed or reboot_required | default(false))

# =============================================================================
# Reboot Linux Hosts if Needed
# =============================================================================
- name: Reboot Linux Hosts
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Update ansible_host to target IP before reboot
      set_fact:
        ansible_host: "{{ target_ip }}"
      when:
        - ansible_connection != 'winrm'
        - needs_ip_config | default(false)

    - name: Reboot Linux hosts that were modified
      ansible.builtin.reboot:
        reboot_timeout: 300
        post_reboot_delay: 30
      when:
        - ansible_connection != 'winrm'
        - vm_changed

# =============================================================================
# Validate Windows Configuration
# =============================================================================
- name: Validate Windows Configuration
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Get network configuration
      ansible.windows.win_shell: |
        $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
        $ip = Get-NetIPAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4
        $dns = Get-DnsClientServerAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4

        [PSCustomObject]@{
          Hostname = $env:COMPUTERNAME
          IPAddress = $ip.IPAddress
          DNS = $dns.ServerAddresses -join ","
        } | ConvertTo-Json
      register: network_info
      changed_when: false
      when: ansible_connection == 'winrm'

    - name: Parse network information
      set_fact:
        network_config: "{{ network_info.stdout | from_json }}"
      when:
        - ansible_connection == 'winrm'
        - network_info.stdout is defined

    - name: Validate configuration
      debug:
        msg:
          - "{{ inventory_hostname }}:"
          - "  IP: {{ network_config.IPAddress }} ✓"
          - "  Hostname: {{ network_config.Hostname }} ✓"
          - "  DNS: {{ network_config.DNS }}"
          - "  Changed: {{ vm_changed }}"
      when:
        - ansible_connection == 'winrm'
        - network_config is defined

# =============================================================================
# Validate Linux Configuration
# =============================================================================
- name: Validate Linux Configuration
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Validate network configuration
      include_role:
        name: linux
        tasks_from: validate
      when: ansible_connection != 'winrm'

# =============================================================================
# Snapshot All VMs
# =============================================================================
- name: Snapshot All VMs
  hosts: all
  gather_facts: false
  serial: 2
  tasks:
    - name: Create Proxmox snapshot if vm_changed
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: "stage2-base-configured"
        snapshot_description: "After base OS configuration (IP, DNS, hostname, AD-DS features)"
      when: vm_changed | default(false)

# =============================================================================
# Summary
# =============================================================================
- name: Display Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Count changed VMs
      set_fact:
        changed_vms: "{{ groups['all'] | map('extract', hostvars, 'vm_changed') | select('equalto', true) | list | length }}"
        total_vms: "{{ groups['all'] | length }}"

    - name: Display summary
      debug:
        msg:
          - ""
          - "========================================="
          - "Stage 02 Complete"
          - "========================================="
          - ""
          - "VMs Configured: {{ changed_vms }}/{{ total_vms }}"
          - ""
          - "{{ (total_vms | int) - (changed_vms | int) }} VMs were already configured"
          - ""
          - "✓ All Windows/Linux configurations applied"
          - "✓ AD-DS features installed on all domain controllers"
          - ""
          - "Next: Run playbooks/03-build-forests.yml to build AD forests"