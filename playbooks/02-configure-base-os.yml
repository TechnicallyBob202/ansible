---
- name: Stage 02 - Configure Base OS
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display stage introduction
      debug:
        msg:
          - "========================================="
          - "  Stage 02: Configure Base OS"
          - "========================================="
          - ""
          - "Configuring VMs:"
          - "  • Wait for VMs to fully boot"
          - "  • Discover current IPs"
          - "  • Configure static IPs"
          - "  • Set DNS servers"
          - "  • Set hostnames"
          - "  • Install AD-DS features (DCs only)"
          - "  • Reboot if needed"
          - "  • Snapshot changed VMs"

# =============================================================================
# Initialize Change Tracking
# =============================================================================
- name: Initialize Change Tracking
  hosts: domain_controllers
  gather_facts: false
  serial: 0
  tasks:
    - name: Initialize vm_changed flag
      set_fact:
        vm_changed: false

# =============================================================================
# Discover Current IPs
# =============================================================================
- name: Discover Current IPs
  hosts: domain_controllers
  gather_facts: false
  serial: 0
  tasks:
    - name: Save target static IP
      set_fact:
        target_static_ip: "{{ ansible_host }}"
      changed_when: false

    - name: Include IP discovery role
      include_role:
        name: proxmox
        tasks_from: discover_ip.yml

    - name: Check if IP already matches
      set_fact:
        ip_needs_config: "{{ current_ip != target_static_ip }}"
      changed_when: false

    - name: Update ansible_host to discovered IP
      set_fact:
        ansible_host: "{{ current_ip }}"
      changed_when: false

    - name: Display IP status
      debug:
        msg: "{{ inventory_hostname }}: {{ current_ip }} → {{ target_static_ip }} ({{ 'needs config' if ip_needs_config else 'already correct' }})"
      changed_when: false

# =============================================================================
# Wait for Windows to be Ready
# =============================================================================
- name: Wait for Windows Ready
  hosts: domain_controllers
  gather_facts: false
  serial: 0
  tasks:
    - name: Wait for Windows to be fully ready
      include_tasks: wait_for_windows_ready.yml

# =============================================================================
# Install AD-DS Features on Domain Controllers
# =============================================================================
- name: Install AD-DS Features on Domain Controllers
  hosts: domain_controllers
  gather_facts: false
  serial: 0
  tasks:
    - name: Install Active Directory Domain Services features
      include_role:
        name: active_directory
        tasks_from: install_ad_features.yml
      register: features_install

    - name: Mark VM as changed if features were installed
      set_fact:
        vm_changed: "{{ vm_changed or (features_install.changed | default(false)) }}"

# =============================================================================
# Configure Network
# =============================================================================
- name: Configure Windows Network
  hosts: domain_controllers
  gather_facts: false
  serial: 0
  tasks:
    - name: Configure static IP
      include_role:
        name: windows
        tasks_from: configure_network.yml
      register: network_config

    - name: Mark VM as changed if network was configured
      set_fact:
        vm_changed: "{{ vm_changed or (network_config.changed | default(false)) }}"

    - name: Set hostname
      include_role:
        name: windows
        tasks_from: set_hostname.yml
      register: hostname_config

    - name: Mark VM as changed if hostname was set
      set_fact:
        vm_changed: "{{ vm_changed or (hostname_config.changed | default(false)) }}"

    - name: Set DNS servers
      include_role:
        name: windows
        tasks_from: set_dns.yml
      register: dns_config

    - name: Mark VM as changed if DNS was configured
      set_fact:
        vm_changed: "{{ vm_changed or (dns_config.changed | default(false)) }}"

# =============================================================================
# Reboot if needed
# =============================================================================
- name: Reboot if Configuration Changed
  hosts: domain_controllers
  gather_facts: false
  serial: 0
  tasks:
    - name: Reboot if VM was changed
      ansible.windows.win_reboot:
        msg: "Rebooting due to configuration changes"
        reboot_timeout: 600
      when: vm_changed

    - name: Wait for Windows after reboot
      include_tasks: wait_for_windows_ready.yml
      when: vm_changed

# =============================================================================
# Snapshot Changed VMs
# =============================================================================
- name: Snapshot Changed VMs
  hosts: domain_controllers
  gather_facts: false
  serial: 2
  tasks:
    - name: Display snapshot plan
      debug:
        msg: "{{ inventory_hostname }} - Will {{ 'SNAPSHOT' if vm_changed else 'SKIP snapshot' }}"

    - name: Create Proxmox snapshot
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: "stage2-base-os-configured"
        snapshot_description: "After base OS configuration"
      when: vm_changed

# =============================================================================
# Summary
# =============================================================================
- name: Stage 02 Complete
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      debug:
        msg:
          - ""
          - "========================================="
          - "Stage 02 Complete"
          - "========================================="
          - ""
          - "✓ All VMs booted and reachable"
          - "✓ Static IPs configured"
          - "✓ Hostnames set"
          - "✓ DNS configured"
          - "✓ AD-DS features installed"
          - "✓ Snapshots created"
          - ""
          - "Next: Run Stage 03 to build forest roots"