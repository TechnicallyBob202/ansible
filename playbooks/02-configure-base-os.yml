---
# =============================================================================
# Stage 02: Configure Base OS
# =============================================================================
# Purpose: Configure all VMs (Windows and Linux)
# - Discover current IPs from Proxmox
# - Wait for VMs to fully boot
# - Configure static IPs
# - Set DNS servers
# - Set hostnames
# - Install AD-DS features on domain controllers
# - Reboot if needed
# - Snapshot changed VMs

- name: Stage 02 - Configure Base OS
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display stage introduction
      debug:
        msg:
          - "========================================="
          - "  Stage 02: Configure Base OS"
          - "========================================="
          - ""
          - "Configuring {{ groups['all'] | length }} VMs:"
          - "  • Wait for VMs to fully boot"
          - "  • Discover current IPs"
          - "  • Configure static IPs"
          - "  • Set DNS servers"
          - "  • Set hostnames"
          - "  • Install AD-DS features (DCs only)"
          - "  • Reboot if needed"
          - "  • Snapshot changed VMs"

# =============================================================================
# Initialize Change Tracking
# =============================================================================
- name: Initialize Change Tracking
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Initialize vm_changed flag
      set_fact:
        vm_changed: false

# =============================================================================
# Discover Current IPs from Proxmox
# =============================================================================
- name: Discover Current IPs
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Save target static IP
      set_fact:
        target_ip: "{{ ansible_host }}"

    - name: Discover current IP from Proxmox (with retries)
      block:
        - name: Include IP discovery role
          include_role:
            name: proxmox
            apply:
              delegate_to: localhost
          vars:
            proxmox_operation: discover_ip
          register: ip_discovery_result
      rescue:
        - name: Wait before retry
          pause:
            seconds: 15
          delegate_to: localhost

        - name: Retry IP discovery (attempt 2)
          include_role:
            name: proxmox
            apply:
              delegate_to: localhost
          vars:
            proxmox_operation: discover_ip
          register: ip_discovery_result
          ignore_errors: true

        - name: Wait before final retry
          pause:
            seconds: 15
          when: ip_discovery_result.failed | default(false)
          delegate_to: localhost

        - name: Retry IP discovery (attempt 3)
          include_role:
            name: proxmox
            apply:
              delegate_to: localhost
          vars:
            proxmox_operation: discover_ip
          register: ip_discovery_result
          when: ip_discovery_result.failed | default(false)

    - name: Abort if IP discovery failed after retries
      fail:
        msg: |
          CRITICAL: Could not discover IP for {{ inventory_hostname }} (vmid {{ vmid }}) after 3 attempts

          This usually means:
          - VM is not running
          - qemu-guest-agent is not installed or not running
          - VM is still booting (wait a few minutes and try again)

          Manual intervention required before continuing.
      when: ip_discovery_result.failed | default(false)

    - name: Check if IP already matches
      set_fact:
        needs_ip_config: "{{ discovered_ip != target_ip }}"

    - name: Update ansible_host to discovered IP
      set_fact:
        ansible_host: "{{ discovered_ip }}"

    - name: Display IP status
      debug:
        msg: "{{ inventory_hostname }}: {{ discovered_ip }} → {{ target_ip }} ({{ 'needs config' if needs_ip_config else 'already correct' }})"

# =============================================================================
# Wait for WinRM Availability (Windows)
# =============================================================================
- name: Wait for WinRM Availability (Windows)
  hosts: windows
  gather_facts: false
  serial: 0

  tasks:
    - name: Test WinRM connectivity
      ansible.windows.win_ping:
      retries: 60
      delay: 5
      until: ping_result is succeeded
      register: ping_result
      ignore_errors: true

    - name: Show WinRM connection result
      debug:
        msg: "{{ inventory_hostname }}: WinRM {{ 'reachable' if ping_result is succeeded else 'unreachable (at ' + ansible_host + ')' }}"

# =============================================================================
# Wait for SSH Availability (Linux)
# =============================================================================
- name: Wait for SSH Availability (Linux)
  hosts: linux
  gather_facts: false
  serial: 0

  tasks:
    - name: Wait for SSH port to be available on discovered IP
      wait_for:
        host: "{{ discovered_ip }}"
        port: 22
        delay: 5
        timeout: 300
      delegate_to: localhost
      register: ssh_port_check

    - name: Show SSH port is available
      debug:
        msg: "{{ inventory_hostname }}: SSH port available at {{ discovered_ip }}"

# =============================================================================
# Configure Static IPs and Network (Windows)
# =============================================================================
- name: Configure Windows Network
  hosts: windows
  gather_facts: false
  serial: 0

  tasks:
    - name: Check if already a domain controller
      ansible.windows.win_shell: |
        $CS = Get-WmiObject Win32_ComputerSystem
        if ($CS.DomainRole -ge 4) {
          Write-Output "IS_DC"
        } else {
          Write-Output "NOT_DC"
        }
      register: dc_check
      changed_when: false

    - name: Set DNS servers to Cloudflare (if NOT a DC)
      set_fact:
        windows_dns_servers: "{{ ['1.1.1.1', '1.0.0.1'] }}"
      when: dc_check.stdout | trim == 'NOT_DC'

    - name: Set DNS servers to domain DNS (if IS a DC)
      set_fact:
        windows_dns_servers: "{{ dns_servers }}"
      when: dc_check.stdout | trim == 'IS_DC'

    - name: Set static IP
      include_role:
        name: windows
        tasks_from: set_static_ip
      register: ip_result

    - name: Consolidate IP changes
      set_fact:
        vm_changed: "{{ vm_changed or (ip_result.changed | default(false)) }}"

    - name: Update ansible_host to target IP
      set_fact:
        ansible_host: "{{ target_ip }}"
      when: needs_ip_config

    - name: Wait for IP to settle
      pause:
        seconds: 10
      when: needs_ip_config

    - name: Configure DNS servers
      include_role:
        name: windows
        tasks_from: set_dns
      register: dns_result

    - name: Set hostname
      include_role:
        name: windows
        tasks_from: set_hostname
      register: hostname_result

    - name: Consolidate DNS and hostname changes
      set_fact:
        vm_changed: "{{ vm_changed or (dns_result.changed | default(false)) or (hostname_result.changed | default(false)) }}"

    - name: Test WinRM on static IP
      ansible.windows.win_ping:
      retries: 30
      delay: 10
      until: ping_result is succeeded
      register: ping_result

# =============================================================================
# Configure Static IPs and Network (Linux)
# =============================================================================
- name: Configure Linux Network
  hosts: linux
  gather_facts: false
  serial: 0
  vars:
    ansible_connection: ssh
    ansible_python_interpreter: /usr/bin/python3
    ansible_port: 22
    ansible_ssh_private_key_file: /root/.ssh/semperis_admin
    ansible_user: blyons
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o PubkeyAuthentication=yes -o PasswordAuthentication=no'

  tasks:
    - name: Set static IP
      include_role:
        name: linux
        tasks_from: set_static_ip
      register: ip_result

    - name: Consolidate IP changes
      set_fact:
        vm_changed: "{{ vm_changed or (ip_result.changed | default(false)) }}"

    - name: Update ansible_host to target IP
      set_fact:
        ansible_host: "{{ target_ip }}"
      when: needs_ip_config

    - name: Wait for IP to settle
      pause:
        seconds: 10
      when: needs_ip_config

    - name: Wait for connection to settle
      pause:
        seconds: 5

    - name: Configure DNS servers
      include_role:
        name: linux
        tasks_from: set_dns
      register: dns_result

    - name: Set hostname
      include_role:
        name: linux
        tasks_from: set_hostname
      register: hostname_result

    - name: Consolidate DNS and hostname changes
      set_fact:
        vm_changed: "{{ vm_changed or (dns_result.changed | default(false)) or (hostname_result.changed | default(false)) }}"

# ==============