---
# =============================================================================
# Stage 02: Configure Base OS - ADFR Lab
# =============================================================================
# Purpose: Configure networking on all ADFR VMs (Windows)
# - Discover current IPs from Proxmox
# - Wait for VMs to fully boot
# - Configure static IPs
# - Set DNS servers (Cloudflare during Stage 02)
# - Set hostnames
# - Install AD-DS features on domain controllers
# - Reboot if needed
# - Snapshot changed VMs

- name: Stage 02 - Configure Base OS (ADFR)
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display stage introduction
      debug:
        msg:
          - "========================================="
          - "  Stage 02: Configure Base OS - ADFR"
          - "========================================="
          - ""
          - "Configuring {{ groups['all'] | length }} VMs:"
          - "  • Wait for VMs to fully boot"
          - "  • Discover current IPs"
          - "  • Configure static IPs"
          - "  • Set DNS to Cloudflare (Stage 02)"
          - "  • Set hostnames"
          - "  • Install AD-DS features (DCs only)"
          - "  • Reboot if needed"
          - "  • Snapshot changed VMs"

# =============================================================================
# PHASE 1: Initialize Change Tracking
# =============================================================================
- name: Initialize Change Tracking
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Initialize vm_changed flag
      set_fact:
        vm_changed: false

# =============================================================================
# PHASE 2: Discover Current IPs (with extended retries)
# =============================================================================
- name: Discover Current IPs (Windows)
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Save target static IP
      set_fact:
        target_ip: "{{ ansible_host }}"

    - name: Discover current IP from Proxmox (with retries)
      block:
        - name: Include IP discovery role
          include_role:
            name: proxmox
            apply:
              delegate_to: localhost
          vars:
            proxmox_operation: discover_ip
          register: ip_discovery_result
      rescue:
        - name: Wait before retry
          pause:
            seconds: 15
          delegate_to: localhost

        - name: Retry IP discovery (attempt 2)
          include_role:
            name: proxmox
            apply:
              delegate_to: localhost
          vars:
            proxmox_operation: discover_ip
          register: ip_discovery_result
          ignore_errors: true

        - name: Wait before final retry
          pause:
            seconds: 15
          when: ip_discovery_result.failed | default(false)
          delegate_to: localhost

        - name: Retry IP discovery (attempt 3)
          include_role:
            name: proxmox
            apply:
              delegate_to: localhost
          vars:
            proxmox_operation: discover_ip
          register: ip_discovery_result
          when: ip_discovery_result.failed | default(false)

    - name: Abort if IP discovery failed after retries
      fail:
        msg: |
          CRITICAL: Could not discover IP for {{ inventory_hostname }} (vmid {{ vmid }}) after 3 attempts

          This usually means:
          - VM is not running
          - qemu-guest-agent is not installed or not running
          - VM is still booting (wait a few minutes and try again)

          Manual intervention required before continuing.
      when:
        - ip_discovery_result is defined
        - ip_discovery_result.failed | default(false)

    - name: Check if IP already matches
      set_fact:
        needs_ip_config: "{{ discovered_ip != target_ip }}"

    - name: Update ansible_host to discovered IP
      set_fact:
        ansible_host: "{{ discovered_ip }}"

    - name: Display IP status
      debug:
        msg: "{{ inventory_hostname }}: {{ discovered_ip }} → {{ target_ip }} ({{ 'needs config' if needs_ip_config else 'already correct' }})"

# =============================================================================
# PHASE 3: Wait for WinRM on Discovered IPs (with collective retry loop)
# =============================================================================
- name: Wait for WinRM Availability
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Test WinRM connectivity (initial attempt)
      ansible.windows.win_ping:
      retries: 60
      delay: 5
      until: ping_result is succeeded
      register: ping_result
      ignore_errors: true

    - name: Show connection attempt results
      debug:
        msg: "{{ inventory_hostname }}: WinRM {{ 'reachable' if ping_result is succeeded else 'unreachable (at ' + ansible_host + ')' }}"

# =============================================================================
# PHASE 3b: Retry unreachable hosts for up to 5 minutes
# =============================================================================
- name: Retry Unreachable VMs
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Collect initially unreachable hosts
      set_fact:
        unreachable_hosts: "{{ groups['all'] | select('in', hostvars) | select(lambda x: hostvars[x].ping_result.failed | default(false)) | list }}"
        retry_attempt: 0

    - name: Display initial status
      debug:
        msg: |
          Initial WinRM Status:
            Reachable: {{ (groups['all'] | length) - (unreachable_hosts | length) }}/{{ groups['all'] | length }}
            Unreachable: {{ unreachable_hosts | length }}/{{ groups['all'] | length }}
            {% if unreachable_hosts | length > 0 %}
            Retrying: {{ unreachable_hosts | join(', ') }}
            {% endif %}

# =============================================================================
# PHASE 3c: Retry loop for unreachable hosts (up to 5 minutes)
# =============================================================================
- name: Retry Unreachable Hosts (loop until all reachable or 5 min timeout)
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Retry WinRM if initially failed
      block:
        - name: Wait 1 minute before retry
          pause:
            seconds: 60
          when:
            - hostvars['localhost'].unreachable_hosts is defined
            - inventory_hostname in hostvars['localhost'].unreachable_hosts

        - name: Retry WinRM connectivity
          ansible.windows.win_ping:
          retries: 10
          delay: 5
          until: retry_ping is succeeded
          register: retry_ping
          ignore_errors: true
          when:
            - hostvars['localhost'].unreachable_hosts is defined
            - inventory_hostname in hostvars['localhost'].unreachable_hosts

        - name: Update ping_result if retry succeeded
          set_fact:
            ping_result: "{{ retry_ping }}"
          when:
            - hostvars['localhost'].unreachable_hosts is defined
            - inventory_hostname in hostvars['localhost'].unreachable_hosts
            - retry_ping is defined

        - name: Show retry result
          debug:
            msg: "{{ inventory_hostname }}: {{ 'NOW REACHABLE ✓' if (ping_result.failed | default(false)) == false else 'still unreachable' }}"
          when:
            - hostvars['localhost'].unreachable_hosts is defined
            - inventory_hostname in hostvars['localhost'].unreachable_hosts

      ignore_errors: true

    - name: Retry round 2 (if still failed)
      block:
        - name: Wait 1 minute before round 2
          pause:
            seconds: 60

        - name: Retry WinRM round 2
          ansible.windows.win_ping:
          retries: 10
          delay: 5
          until: retry_ping_2 is succeeded
          register: retry_ping_2
          ignore_errors: true

        - name: Update ping_result if round 2 succeeded
          set_fact:
            ping_result: "{{ retry_ping_2}}"
          when: retry_ping_2 is defined

        - name: Show round 2 result
          debug:
            msg: "{{ inventory_hostname }}: {{ 'NOW REACHABLE ✓' if (ping_result.failed | default(false)) == false else 'still unreachable' }}"

      when:
        - hostvars['localhost'].unreachable_hosts is defined
        - inventory_hostname in hostvars['localhost'].unreachable_hosts
        - ping_result.failed | default(false)
      ignore_errors: true

    - name: Retry round 3 (final attempt)
      block:
        - name: Wait 1 minute before final attempt
          pause:
            seconds: 60

        - name: Retry WinRM final
          ansible.windows.win_ping:
          retries: 10
          delay: 5
          until: retry_ping_3 is succeeded
          register: retry_ping_3
          ignore_errors: true

        - name: Update ping_result if final retry succeeded
          set_fact:
            ping_result: "{{ retry_ping_3 }}"
          when: retry_ping_3 is defined

        - name: Show final result
          debug:
            msg: "{{ inventory_hostname }}: {{ 'NOW REACHABLE ✓' if (ping_result.failed | default(false)) == false else 'STILL UNREACHABLE' }}"

      when:
        - hostvars['localhost'].unreachable_hosts is defined
        - inventory_hostname in hostvars['localhost'].unreachable_hosts
        - ping_result.failed | default(false)
      ignore_errors: true

# =============================================================================
# PHASE 4: Configure Static IPs (Windows)
# =============================================================================
- name: Configure Static IPs (Windows)
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Set static IP
      include_role:
        name: windows
      vars:
        windows_operation: set_static_ip
      register: ip_result

    - name: Abort if IP configuration failed
      fail:
        msg: |
          CRITICAL: Failed to configure static IP for {{ inventory_hostname }}
          Error: {{ ip_result.msg | default('Unknown error') }}
      when:
        - ip_result is defined
        - ip_result.failed | default(false)

    - name: Mark VM as changed if IP was configured
      set_fact:
        vm_changed: "{{ vm_changed or (ip_result.changed | default(false)) }}"

    - name: Update ansible_host to target IP
      set_fact:
        ansible_host: "{{ target_ip }}"
      when: needs_ip_config

    - name: Wait for IP to settle
      pause:
        seconds: 10
      when: needs_ip_config

# =============================================================================
# PHASE 5: Verify WinRM on Static IPs
# =============================================================================
- name: Verify WinRM on Static IPs
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Test WinRM on static IP
      ansible.windows.win_ping:
      retries: 30
      delay: 10
      until: ping_result is succeeded
      register: ping_result

# =============================================================================
# PHASE 6: Configure DNS and Hostname (Windows)
# =============================================================================
- name: Configure DNS and Hostname (Windows)
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Configure DNS servers
      include_role:
        name: windows
      vars:
        windows_operation: set_dns
      register: dns_result

    - name: Abort if DNS configuration failed
      fail:
        msg: |
          CRITICAL: Failed to configure DNS for {{ inventory_hostname }}
          Error: {{ dns_result.msg | default('Unknown error') }}
      when:
        - dns_result is defined
        - dns_result.failed | default(false)

    - name: Mark VM as changed if DNS was configured
      set_fact:
        vm_changed: "{{ vm_changed or (dns_result.changed | default(false)) }}"

    - name: Set hostname
      include_role:
        name: windows
      vars:
        windows_operation: set_hostname
      register: hostname_result

    - name: Abort if hostname configuration failed
      fail:
        msg: |
          CRITICAL: Failed to set hostname for {{ inventory_hostname }}
          Error: {{ hostname_result.msg | default('Unknown error') }}
      when:
        - hostname_result is defined
        - hostname_result.failed | default(false)

    - name: Mark VM as changed if hostname was set
      set_fact:
        vm_changed: "{{ vm_changed or (hostname_result.changed | default(false)) }}"

# =============================================================================
# PHASE 7: Install AD-DS Features on Domain Controllers
# =============================================================================
- name: Install AD-DS Features (Domain Controllers Only)
  hosts: domain_controllers
  gather_facts: false
  serial: 0

  tasks:
    - name: Install Active Directory Domain Services features
      include_role:
        name: active_directory
        tasks_from: install_ad_features.yml
      register: adds_install_result

    - name: Mark VM as changed if AD-DS features were installed
      set_fact:
        vm_changed: "{{ vm_changed or (adds_install_result.changed | default(false)) }}"

# =============================================================================
# PHASE 8: Reboot Windows Hosts
# =============================================================================
- name: Check if reboot is necessary
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Check for pending reboots
      include_role:
        name: windows
        tasks_from: check_reboot_needed.yml

- name: Reboot only if necessary
  hosts: all
  gather_facts: false
  serial: 0
  tasks:
    - name: Reboot to clear pending state if needed
      ansible.windows.win_reboot:
        reboot_timeout: 300
        post_reboot_delay: 30
      when: reboot_needed

# =============================================================================
# PHASE 9: Validation
# =============================================================================
- name: Validate Configuration (Windows)
  hosts: all
  gather_facts: false
  serial: 0

  tasks:
    - name: Get network configuration
      ansible.windows.win_shell: |
        $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
        $ip = Get-NetIPAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4
        $dns = Get-DnsClientServerAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4

        [PSCustomObject]@{
          Hostname = $env:COMPUTERNAME
          IPAddress = $ip.IPAddress
          DNS = $dns.ServerAddresses -join ","
        } | ConvertTo-Json
      register: network_info
      changed_when: false

    - name: Parse network information
      set_fact:
        network_config: "{{ network_info.stdout | from_json }}"

    - name: Validate configuration
      debug:
        msg:
          - "{{ inventory_hostname }}:"
          - "  IP: {{ network_config.IPAddress }} ✓"
          - "  Hostname: {{ network_config.Hostname }} ✓"
          - "  DNS: {{ network_config.DNS }}"
          - "  Changed: {{ vm_changed }}"

# =============================================================================
# PHASE 10: Snapshot Changed VMs
# =============================================================================
- name: Snapshot Changed VMs
  hosts: all
  gather_facts: false
  serial: 2

  tasks:
    - name: Display snapshot plan
      debug:
        msg: "{{ inventory_hostname }} - Will {{ 'SNAPSHOT' if vm_changed else 'SKIP snapshot' }}"

    - name: Create Proxmox snapshot
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        proxmox_operation: snapshot
        snapshot_name: "stage2-base-configured"
        snapshot_description: "After base OS configuration (IP, DNS, hostname, AD-DS features)"
      when: vm_changed

# =============================================================================
# PHASE 11: Summary
# =============================================================================
- name: Display Summary
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Count changed VMs
      set_fact:
        changed_vms: "{{ groups['all'] | map('extract', hostvars, 'vm_changed') | select('equalto', true) | list | length }}"
        total_vms: "{{ groups['all'] | length }}"

    - name: Display summary
      debug:
        msg:
          - ""
          - "========================================="
          - "Stage 02 Complete"
          - "========================================="
          - ""
          - "VMs Configured: {{ changed_vms }}/{{ total_vms }}"
          - ""
          - "{{ (total_vms | int) - (changed_vms | int) }} VMs were already configured"
          - ""
          - "✓ AD-DS features installed on all domain controllers"
          - ""
          - "Next: Run playbooks/03-build-forests.yml to build AD forests"