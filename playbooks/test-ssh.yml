---
- name: Seed ad-hoc host (no inventory needed)
  hosts: localhost
  gather_facts: false
  vars:
    target_ip: "192.168.35.248"              # hard-coded DHCP IP
    ssh_user: "blyons"
    key_path: "~/.ssh/ansible_key"           # adjust to the real path on the Semaphore runner

  tasks:
    - name: Define ad-hoc target host with key-only SSH
      add_host:
        name: adhoc_target
        ansible_host: "{{ target_ip }}"
        groups: ["adhoc_group"]
        ansible_connection: ssh
        ansible_user: "{{ ssh_user }}"
        ansible_python_interpreter: /usr/bin/python3
        ansible_ssh_private_key_file: "{{ key_path }}"
        ansible_ssh_common_args: "-o PreferredAuthentications=publickey -o PasswordAuthentication=no -o StrictHostKeyChecking=no"
        ansible_ssh_password_mechanism: disable  # if your ansible-core supports it (2.19+)

- name: Test SSH using the key
  hosts: adhoc_target
  gather_facts: false
  tasks:
    - name: Ping over SSH
      ansible.builtin.ping:

    - name: Who am I
      ansible.builtin.command: whoami
      register: who
      changed_when: false

    - name: Show result
      ansible.builtin.debug:
        msg: "Connected to {{ inventory_hostname }} as {{ who.stdout }}"