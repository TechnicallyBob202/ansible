---
- name: Build rainier.alpine.lab Child Domain PDC
  hosts: rainier_child_pdc
  gather_facts: no
  vars:
    windows_password: "{{ lookup('env','WINDOWS_PASSWORD') }}"
    domain_name: "rainier.alpine.lab"

  tasks:
    - name: Check domain status
      include_tasks: ../tasks/check-domain-exists.yml

    - name: Store domain facts to localhost
      set_fact:
        rainier_domain_exists: "{{ domain_exists }}"
        rainier_domain_sid: "{{ domain_sid }}"
      delegate_to: localhost
      delegate_facts: yes

    - name: Install AD-DS if domain doesn't exist
      include_tasks: ../tasks/install-adds.yml
      when: not hostvars['localhost']['rainier_domain_exists']

    - name: Promote to child domain PDC
      include_tasks: ../tasks/promote-child-domain-pdc.yml
      vars:
        child_domain_name: "rainier"
        parent_domain_name: "alpine.lab"
        parent_netbios_name: "ALPINE"
      when: not hostvars['localhost']['rainier_domain_exists']

    - name: Update domain SID fact
      set_fact:
        rainier_domain_sid: "{{ domain_sid }}"
      delegate_to: localhost
      delegate_facts: yes
      when: 
        - not hostvars['localhost']['rainier_domain_exists']
        - domain_sid is defined

- name: Save rainier.alpine.lab Domain SID
  hosts: localhost
  gather_facts: yes
  tasks:
    - name: Save SID to file
      include_tasks: ../tasks/save-domain-sid.yml
      vars:
        domain_name: "rainier.alpine.lab"
        domain_sid: "{{ hostvars['localhost']['rainier_domain_sid'] }}"
        output_file: "rainier-domain-sid.txt"
