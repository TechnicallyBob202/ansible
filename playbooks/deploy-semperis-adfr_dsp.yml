---
- name: Deploy Semperis ADFR/DSP Lab VMs on Proxmox
  hosts: localhost
  gather_facts: no
  vars:
    # Proxmox connection details
    proxmox_host1: 192.168.35.21
    proxmox_host2: 192.168.35.22
    proxmox_user: root@pam
    # Using SSH key authentication - no password needed
    validate_certs: no

    # Template IDs (one per host) - Windows Server 2022 with cloudbase-init
    template_host1: 9000
    template_host2: 9001

    # Network configuration - VLAN 35
    network_bridge: vmbr0
    network_vlan: 35
    network_subnet: 192.168.35.0/24
    network_gateway: 192.168.35.1
    dns_servers: "192.168.33.6,192.168.33.7"

    # VM definitions - split evenly between hosts
    vms:
      # Host 1 VMs (9 VMs on 192.168.35.21)
      - name: ATLAS
        vmid: 3510
        host: "{{ proxmox_host1 }}"
        template: "{{ template_host1 }}"
        ip: 192.168.35.10
        cores: 4
        memory: 8192
        disk_size: 100G
        description: "ADFR Management Server"

      - name: SUMMIT
        vmid: 3511
        host: "{{ proxmox_host1 }}"
        template: "{{ template_host1 }}"
        ip: 192.168.35.11
        cores: 4
        memory: 8192
        disk_size: 100G
        description: "DSP Management Server"

      - name: PEAK
        vmid: 3512
        host: "{{ proxmox_host1 }}"
        template: "{{ template_host1 }}"
        ip: 192.168.35.12
        cores: 4
        memory: 16384
        disk_size: 200G
        description: "SQL Server (ADFR & DSP Backend)"

      - name: RIDGE
        vmid: 3513
        host: "{{ proxmox_host1 }}"
        template: "{{ template_host1 }}"
        ip: 192.168.35.13
        cores: 2
        memory: 4096
        disk_size: 500G
        description: "Distribution Point 1 (Primary)"

      - name: KOA-DC01
        vmid: 3520
        host: "{{ proxmox_host1 }}"
        template: "{{ template_host1 }}"
        ip: 192.168.35.20
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "arbor.lab Forest Root PDC"

      - name: GRANITE-DC01
        vmid: 3530
        host: "{{ proxmox_host1 }}"
        template: "{{ template_host1 }}"
        ip: 192.168.35.30
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "alpine.lab Forest Root PDC"

      - name: SLATE-DC01
        vmid: 3532
        host: "{{ proxmox_host1 }}"
        template: "{{ template_host1 }}"
        ip: 192.168.35.32
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "mauna.alpine.lab Child Domain PDC"

      - name: MARBLE-DC01
        vmid: 3534
        host: "{{ proxmox_host1 }}"
        template: "{{ template_host1 }}"
        ip: 192.168.35.34
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "rainier.alpine.lab Child Domain PDC"

      - name: MESA-R01
        vmid: 3550
        host: "{{ proxmox_host1 }}"
        template: "{{ template_host1 }}"
        ip: 192.168.35.50
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "Blank Recovery VM 1"

      # Host 2 VMs (8 VMs on 192.168.35.22)
      - name: CREST
        vmid: 3514
        host: "{{ proxmox_host2 }}"
        template: "{{ template_host2 }}"
        ip: 192.168.35.14
        cores: 2
        memory: 4096
        disk_size: 500G
        description: "Distribution Point 2 (Secondary/DR)"

      - name: SLOPE
        vmid: 3519
        host: "{{ proxmox_host2 }}"
        template: "{{ template_host2 }}"
        ip: 192.168.35.19
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "Utility Server (Jump/Admin)"

      - name: OAK-DC01
        vmid: 3521
        host: "{{ proxmox_host2 }}"
        template: "{{ template_host2 }}"
        ip: 192.168.35.21
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "arbor.lab Forest Root Replica DC"

      - name: BASALT-DC01
        vmid: 3531
        host: "{{ proxmox_host2 }}"
        template: "{{ template_host2 }}"
        ip: 192.168.35.31
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "alpine.lab Forest Root Replica DC"

      - name: SHALE-DC01
        vmid: 3533
        host: "{{ proxmox_host2 }}"
        template: "{{ template_host2 }}"
        ip: 192.168.35.33
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "mauna.alpine.lab Child Domain Replica DC"

      - name: QUARTZ-DC01
        vmid: 3535
        host: "{{ proxmox_host2 }}"
        template: "{{ template_host2 }}"
        ip: 192.168.35.35
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "rainier.alpine.lab Child Domain Replica DC"

      - name: BLUFF-R01
        vmid: 3551
        host: "{{ proxmox_host2 }}"
        template: "{{ template_host2 }}"
        ip: 192.168.35.51
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "Blank Recovery VM 2"

      - name: CLIFF-R01
        vmid: 3552
        host: "{{ proxmox_host2 }}"
        template: "{{ template_host2 }}"
        ip: 192.168.35.52
        cores: 2
        memory: 4096
        disk_size: 80G
        description: "Blank Recovery VM 3"

  tasks:
    - name: Display deployment summary
      debug:
        msg:
          - "Deploying {{ vms | length }} VMs across 2 Proxmox hosts"
          - "Host 1 ({{ proxmox_host1 }}): {{ vms | selectattr('host', 'equalto', proxmox_host1) | list | length }} VMs"
          - "Host 2 ({{ proxmox_host2 }}): {{ vms | selectattr('host', 'equalto', proxmox_host2) | list | length }} VMs"

    - name: Clone VMs from templates
      community.general.proxmox_kvm:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        validate_certs: no
        clone: "{{ item.template }}"
        vmid: "{{ item.vmid }}"
        name: "{{ item.name }}"
        node: "{{ 'semperis-nuc-1' if item.host == proxmox_host1 else 'semperis-nuc-2' }}"
        description: "{{ item.description }}"
        full: yes
        timeout: 300
      loop: "{{ vms }}"
      register: clone_result

    - name: Wait for clone operations to complete
      pause:
        seconds: 10

    - name: Configure network interface with VLAN tag
      community.general.proxmox_nic:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        validate_certs: no
        vmid: "{{ item.vmid }}"
        interface: net0
        bridge: "{{ network_bridge }}"
        tag: "{{ network_vlan }}"
      loop: "{{ vms }}"

    - name: Configure VM hardware resources
      community.general.proxmox_kvm:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        validate_certs: no
        vmid: "{{ item.vmid }}"
        node: "{{ 'semperis-nuc-1' if item.host == proxmox_host1 else 'semperis-nuc-2' }}"
        name: "{{ item.name }}"
        cores: "{{ item.cores }}"
        memory: "{{ item.memory }}"
        update: yes
      loop: "{{ vms }}"

    - name: Resize VM disks
      community.general.proxmox_disk:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        validate_certs: no
        vmid: "{{ item.vmid }}"
        disk: scsi0
        size: "{{ item.disk_size }}"
        state: resized
      loop: "{{ vms }}"
      when: item.disk_size is defined

    - name: Configure network settings via cloud-init
      community.general.proxmox_kvm:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        validate_certs: no
        vmid: "{{ item.vmid }}"
        node: "{{ 'semperis-nuc-1' if item.host == proxmox_host1 else 'semperis-nuc-2' }}"
        ipconfig:
          ipconfig0: "ip={{ item.ip }}/24,gw={{ network_gateway }}"
        nameservers: "{{ dns_servers }}"
        update: yes
      loop: "{{ vms }}"
      when: item.ip is defined

    - name: Start all VMs
      community.general.proxmox_kvm:
        api_host: "{{ item.host }}"
        api_user: "{{ proxmox_user }}"
        validate_certs: no
        vmid: "{{ item.vmid }}"
        node: "{{ 'semperis-nuc-1' if item.host == proxmox_host1 else 'semperis-nuc-2' }}"
        state: started
      loop: "{{ vms }}"

    - name: Display deployment completion summary
      debug:
        msg:
          - "==================================================="
          - "Semperis Lab Deployment Complete!"
          - "==================================================="
          - ""
          - "Infrastructure Tier:"
          - "  - ATLAS (3301): {{ vms | selectattr('name', 'equalto', 'ATLAS') | map(attribute='ip') | first }}"
          - "  - SUMMIT (3302): {{ vms | selectattr('name', 'equalto', 'SUMMIT') | map(attribute='ip') | first }}"
          - "  - PEAK (3303): {{ vms | selectattr('name', 'equalto', 'PEAK') | map(attribute='ip') | first }}"
          - "  - RIDGE (3304): {{ vms | selectattr('name', 'equalto', 'RIDGE') | map(attribute='ip') | first }}"
          - "  - CREST (3305): {{ vms | selectattr('name', 'equalto', 'CREST') | map(attribute='ip') | first }}"
          - "  - SLOPE (3309): {{ vms | selectattr('name', 'equalto', 'SLOPE') | map(attribute='ip') | first }}"
          - ""
          - "arbor.lab Forest:"
          - "  - KOA-DC01 (3310): {{ vms | selectattr('name', 'equalto', 'KOA-DC01') | map(attribute='ip') | first }}"
          - "  - OAK-DC01 (3311): {{ vms | selectattr('name', 'equalto', 'OAK-DC01') | map(attribute='ip') | first }}"
          - ""
          - "alpine.lab Forest:"
          - "  - GRANITE-DC01 (3320): {{ vms | selectattr('name', 'equalto', 'GRANITE-DC01') | map(attribute='ip') | first }}"
          - "  - BASALT-DC01 (3321): {{ vms | selectattr('name', 'equalto', 'BASALT-DC01') | map(attribute='ip') | first }}"
          - "  - SLATE-DC01 (3322): {{ vms | selectattr('name', 'equalto', 'SLATE-DC01') | map(attribute='ip') | first }}"
          - "  - SHALE-DC01 (3323): {{ vms | selectattr('name', 'equalto', 'SHALE-DC01') | map(attribute='ip') | first }}"
          - "  - MARBLE-DC01 (3324): {{ vms | selectattr('name', 'equalto', 'MARBLE-DC01') | map(attribute='ip') | first }}"
          - "  - QUARTZ-DC01 (3325): {{ vms | selectattr('name', 'equalto', 'QUARTZ-DC01') | map(attribute='ip') | first }}"
          - ""
          - "Recovery VMs:"
          - "  - MESA-R01 (3350): {{ vms | selectattr('name', 'equalto', 'MESA-R01') | map(attribute='ip') | first }}"
          - "  - BLUFF-R01 (3351): {{ vms | selectattr('name', 'equalto', 'BLUFF-R01') | map(attribute='ip') | first }}"
          - "  - CLIFF-R01 (3352): {{ vms | selectattr('name', 'equalto', 'CLIFF-R01') | map(attribute='ip') | first }}"
          - ""
          - "Next Steps:"
          - "  1. Verify all VMs are running"
          - "  2. Configure static IPs in Windows (if cloud-init failed)"
          - "  3. Install SQL Server on PEAK (3303)"
          - "  4. Build arbor.lab forest on KOA-DC01"
          - "  5. Build alpine.lab forest on GRANITE-DC01"
          - "  6. Install ADFR on ATLAS"
          - "  7. Install DSP on SUMMIT"
          - "==================================================="