---
# =============================================================================
# Stage 5: Verify Lab Environment
# =============================================================================

- name: Lab Verification - Introduction
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Display verification plan
      debug:
        msg:
          - "========================================="
          - "  Stage 5: Verify Lab Environment"
          - "========================================="
          - ""
          - "Verification steps:"
          - "  1. Test connectivity (Windows & Linux)"
          - "  2. Validate Windows configuration"
          - "  3. Validate Linux configuration"
          - "  4. Check AD health and replication"
          - "  5. Collect forest domain SIDs"
          - "  6. Generate mRemoteNG configuration"
          - "  7. Commit documentation to git"
          - "  8. Create ready-to-rock snapshots"
          - ""
          - "All systems validated and operational"
          - "Documentation generated in files/"
          - "  - forest-domain-sids.txt"
          - "  - semperis-lab-mremoteng.xml"

# =============================================================================
# PHASE 1: Connectivity Tests
# =============================================================================
- name: Test Basic Connectivity (Windows)
  hosts: all:!linux_infrastructure
  gather_facts: false

  tasks:
    - name: Test WinRM connectivity
      ansible.windows.win_ping:
      register: connectivity_test

    - name: Display connectivity results
      debug:
        msg: "{{ inventory_hostname }} - {{ 'ONLINE' if connectivity_test is succeeded else 'OFFLINE' }}"

- name: Test Basic Connectivity (Linux)
  hosts: linux_infrastructure
  gather_facts: false

  tasks:
    - name: Test SSH connectivity
      ansible.builtin.ping:
      register: connectivity_test

    - name: Display connectivity results
      debug:
        msg: "{{ inventory_hostname }} - {{ 'ONLINE' if connectivity_test is succeeded else 'OFFLINE' }}"

# =============================================================================
# PHASE 2: Validate Windows Configuration
# =============================================================================
- name: Validate Windows Configuration
  hosts: all:!linux_infrastructure
  gather_facts: false

  tasks:
    - name: Get network configuration
      ansible.windows.win_shell: |
        $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
        $ip = Get-NetIPAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4
        $dns = Get-DnsClientServerAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4

        [PSCustomObject]@{
          Hostname = $env:COMPUTERNAME
          IPAddress = $ip.IPAddress
          DNS = $dns.ServerAddresses -join ","
        } | ConvertTo-Json
      register: network_info
      changed_when: false

    - name: Parse network configuration
      set_fact:
        network_config: "{{ network_info.stdout | from_json }}"

    - name: Validate network configuration
      set_fact:
        hostname_matches: "{{ network_config.Hostname | lower == inventory_hostname_short | lower }}"
        ip_matches: "{{ network_config.IPAddress == ansible_host }}"
        dns_configured: "{{ network_config.DNS | length > 0 }}"

    - name: Display validation results
      debug:
        msg:
          - "{{ inventory_hostname }} validation:"
          - "  Hostname: {{ 'OK' if hostname_matches else 'MISMATCH' }}"
          - "  IP Address: {{ 'OK' if ip_matches else 'MISMATCH' }}"
          - "  DNS: {{ 'OK' if dns_configured else 'NOT CONFIGURED' }}"

    - name: Set VM as unchanged (default state)
      set_fact:
        vm_changed: false

# =============================================================================
# PHASE 3: Validate Linux Configuration
# =============================================================================
- name: Validate Linux Configuration
  hosts: linux_infrastructure
  gather_facts: true

  tasks:
    - name: Get network configuration
      set_fact:
        network_config:
          Hostname: "{{ ansible_hostname }}"
          IPAddress: "{{ ansible_default_ipv4.address }}"
          DNS: "{{ ansible_dns.nameservers | join(',') }}"

    - name: Validate network configuration
      set_fact:
        hostname_matches: "{{ ansible_hostname | lower == inventory_hostname_short | lower }}"
        ip_matches: "{{ ansible_default_ipv4.address == hostvars[inventory_hostname].ip }}"
        dns_configured: "{{ ansible_dns.nameservers | length > 0 }}"

    - name: Display validation results
      debug:
        msg:
          - "{{ inventory_hostname }} validation:"
          - "  Hostname: {{ 'OK' if hostname_matches else 'MISMATCH' }}"
          - "  IP Address: {{ 'OK' if ip_matches else 'MISMATCH' }}"
          - "  DNS: {{ 'OK' if dns_configured else 'NOT CONFIGURED' }}"

    - name: Set VM as unchanged (default state)
      set_fact:
        vm_changed: false

# =============================================================================
# PHASE 4: Validate Active Directory
# =============================================================================
- name: Validate AD Health and Replication
  hosts: domain_controllers
  gather_facts: false

  tasks:
    - name: Check AD replication
      include_role:
        name: activeDirectory
        tasks_from: verify_replication.yml

    - name: Check FSMO roles
      include_role:
        name: activeDirectory
        tasks_from: check_fsmo_roles.yml

# =============================================================================
# PHASE 5: Collect Forest Domain SIDs
# =============================================================================
- name: Collect Forest Root Domain SIDs
  hosts: arbor_pdc:alpine_pdc
  gather_facts: false

  tasks:
    - name: Get forest domain SID
      ansible.windows.win_shell: |
        $domain = Get-ADDomain
        [PSCustomObject]@{
          DomainName = $domain.DNSRoot
          NetBIOSName = $domain.NetBIOSName
          DomainSID = $domain.DomainSID.Value
          ForestName = $domain.Forest
        } | ConvertTo-Json
      register: forest_sid_info
      changed_when: false

    - name: Parse domain SID information
      set_fact:
        domain_sid_data: "{{ forest_sid_info.stdout | from_json }}"

    - name: Display forest SID
      debug:
        msg:
          - "{{ inventory_hostname }} Forest Information:"
          - "  Domain: {{ domain_sid_data.DomainName }}"
          - "  NetBIOS: {{ domain_sid_data.NetBIOSName }}"
          - "  SID: {{ domain_sid_data.DomainSID }}"
          - "  Forest: {{ domain_sid_data.ForestName }}"

- name: Save Forest SIDs to File
  hosts: localhost
  gather_facts: true

  tasks:
    - name: Collect SID data from all forest roots
      set_fact:
        all_forest_sids: "{{ groups['arbor_pdc'] | union(groups['alpine_pdc']) | map('extract', hostvars) | selectattr('domain_sid_data', 'defined') | map(attribute='domain_sid_data') | list }}"

    - name: Generate forest SID file
      copy:
        content: |
          # Forest Domain SIDs - {{ ansible_date_time.iso8601 }}
          # Generated by: playbooks/05-verify-lab.yml

          {% for sid in all_forest_sids %}
          Forest: {{ sid.ForestName }}
          Domain: {{ sid.DomainName }}
          NetBIOS: {{ sid.NetBIOSName }}
          SID: {{ sid.DomainSID }}

          {% endfor %}
        dest: "{{ playbook_dir }}/../files/forest-domain-sids.txt"
        mode: '0644'

# =============================================================================
# PHASE 6: Generate mRemoteNG Configuration
# =============================================================================
- name: Generate mRemoteNG Configuration
  hosts: localhost
  gather_facts: true

  tasks:
    - name: Generate mRemoteNG config file
      include_tasks: ../tasks/generate_mremoteng.yml

# =============================================================================
# PHASE 7: Commit Documentation to Git
# =============================================================================
- name: Commit Documentation to Git
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Commit and push documentation files
      include_tasks: ../tasks/git_commit_docs.yml

# =============================================================================
# PHASE 8: Create "Ready to Rock" Snapshots for ALL VMs
# =============================================================================
- name: Create Ready-to-Rock Snapshots
  hosts: all
  gather_facts: false
  serial: 2

  tasks:
    - name: Set all VMs as changed for final snapshot
      set_fact:
        vm_changed: true

    - name: Display snapshot plan
      debug:
        msg: "{{ inventory_hostname }} - Creating 'ready-to-rock' snapshot"

    - name: Take ready-to-rock snapshot
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: ready-to-rock

# =============================================================================
# PHASE 9: Final Summary
# =============================================================================
- name: Final Summary
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Calculate VM counts
      set_fact:
        total_dcs: "{{ groups['domain_controllers'] | length }}"
        total_infra: "{{ groups['infrastructure'] | default([]) | length }}"
        total_linux: "{{ groups['linux_infrastructure'] | default([]) | length }}"
        total_recovery: "{{ groups['recovery_vms'] | default([]) | length }}"
        total_vms: "{{ groups['all'] | length }}"

    - name: Display final summary
      debug:
        msg:
          - "========================================="
          - "Lab Verification & Snapshot Complete!"
          - "========================================="
          - ""
          - "Ready-to-Rock Snapshots Created:"
          - "  Domain Controllers: {{ total_dcs }}"
          - "  Infrastructure VMs: {{ total_infra }}"
          - "  Linux Infrastructure: {{ total_linux }}"
          - "  Recovery VMs: {{ total_recovery }}"
          - "  ─────────────────────────────────"
          - "  Total: {{ total_vms }} VMs"
          - ""
          - "All VMs are now in a validated, ready-to-rock state!"
          - "You can revert to these snapshots at any time."
          - ""
          - "Documentation files (committed to git):"
          - "  - files/forest-domain-sids.txt"
          - "  - files/semperis-lab-mremoteng.xml"