---
- name: Diagnostic - Check Replication Details
  hosts: d1_dcs,d2_parent_dcs
  gather_facts: false

  tasks:
    - name: Get detailed replication info
      ansible.windows.win_shell: |
        # Get all replication partners
        $partners = repadmin /showrepl | Out-String

        # Get replication summary
        $summary = repadmin /replsummary | Out-String

        # Check if this DC knows about other DCs
        $allDCs = nltest /dclist:{{ domain_name }} 2>&1 | Out-String

        Write-Output "=== REPLICATION PARTNERS ==="
        Write-Output $partners
        Write-Output ""
        Write-Output "=== REPLICATION SUMMARY ==="
        Write-Output $summary
        Write-Output ""
        Write-Output "=== ALL DCs IN DOMAIN ==="
        Write-Output $allDCs
      register: repl_details

    - name: Display replication details
      debug:
        msg: "{{ repl_details.stdout_lines }}"