---
# =============================================================================
# Snapshot AD VMs (replace if exist, create if missing)
# =============================================================================
- name: Snapshot All AD VMs
  hosts: domain_controllers
  gather_facts: false
  serial: 2

  tasks:
    - name: Force replacement of existing snapshots
      set_fact:
        vm_changed: true

    - name: Snapshot VM
      include_role:
        name: proxmox
        tasks_from: snapshot.yml
        apply:
          delegate_to: localhost
      vars:
        snapshot_name: "clean-ad-config"
        snapshot_description: "After AD is fully configured"