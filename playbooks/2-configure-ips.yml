---
- name: Discover DHCP IPs and Create Inventory
  hosts: localhost
  gather_facts: no

  vars:
    windows_user: Administrator
    windows_password: "{{ lookup('env', 'WINDOWS_PASSWORD') }}"
    proxmox_host1: 192.168.33.21
    proxmox_host2: 192.168.33.22

    vm_configs:
      - { vmid: 3510, ip: "192.168.35.10", hostname: "ATLAS", pxhost: "{{ proxmox_host1 }}" }
      - { vmid: 3511, ip: "192.168.35.11", hostname: "SUMMIT", pxhost: "{{ proxmox_host1 }}" }
      - { vmid: 3512, ip: "192.168.35.12", hostname: "PEAK", pxhost: "{{ proxmox_host1 }}" }
      - { vmid: 3513, ip: "192.168.35.13", hostname: "RIDGE", pxhost: "{{ proxmox_host1 }}" }
      - { vmid: 3520, ip: "192.168.35.20", hostname: "KOA-DC01", pxhost: "{{ proxmox_host1 }}" }
      - { vmid: 3530, ip: "192.168.35.30", hostname: "GRANITE-DC01", pxhost: "{{ proxmox_host1 }}" }
      - { vmid: 3532, ip: "192.168.35.32", hostname: "SLATE-DC01", pxhost: "{{ proxmox_host1 }}" }
      - { vmid: 3534, ip: "192.168.35.34", hostname: "MARBLE-DC01", pxhost: "{{ proxmox_host1 }}" }
      - { vmid: 3550, ip: "192.168.35.50", hostname: "MESA-R01", pxhost: "{{ proxmox_host1 }}" }
      - { vmid: 3514, ip: "192.168.35.14", hostname: "CREST", pxhost: "{{ proxmox_host2 }}" }
      - { vmid: 3519, ip: "192.168.35.19", hostname: "SLOPE", pxhost: "{{ proxmox_host2 }}" }
      - { vmid: 3521, ip: "192.168.35.21", hostname: "OAK-DC01", pxhost: "{{ proxmox_host2 }}" }
      - { vmid: 3531, ip: "192.168.35.31", hostname: "BASALT-DC01", pxhost: "{{ proxmox_host2 }}" }
      - { vmid: 3533, ip: "192.168.35.33", hostname: "SHALE-DC01", pxhost: "{{ proxmox_host2 }}" }
      - { vmid: 3535, ip: "192.168.35.35", hostname: "QUARTZ-DC01", pxhost: "{{ proxmox_host2 }}" }
      - { vmid: 3551, ip: "192.168.35.51", hostname: "BLUFF-R01", pxhost: "{{ proxmox_host2 }}" }
      - { vmid: 3552, ip: "192.168.35.52", hostname: "CLIFF-R01", pxhost: "{{ proxmox_host2 }}" }

  tasks:
    - name: Get DHCP IPs from all VMs
      shell: "ssh root@{{ item.pxhost }} 'qm guest cmd {{ item.vmid }} network-get-interfaces' 2>/dev/null | grep -oP '(?<=\"ip-address\" : \")[^\"]*' | grep -v '^127' | grep -v '^fe80' | grep -v '^::1' | head -1"
      loop: "{{ vm_configs }}"
      register: dhcp_ips
      ignore_errors: yes

    - name: Create dynamic inventory
      add_host:
        name: "{{ item.item.hostname }}"
        groups: windows_vms
        ansible_host: "{{ item.stdout }}"
        ansible_user: "{{ windows_user }}"
        ansible_password: "{{ windows_password }}"
        ansible_connection: winrm
        ansible_winrm_transport: basic
        ansible_winrm_server_cert_validation: ignore
        ansible_port: 5985
        target_ip: "{{ item.item.ip }}"
        target_hostname: "{{ item.item.hostname }}"
      loop: "{{ dhcp_ips.results }}"
      when: item.stdout != ""

- name: Phase 1 - Change All IPs
  hosts: windows_vms
  gather_facts: no

  tasks:
    - name: Configure static IP
      win_shell: |
        $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
        New-NetIPAddress -InterfaceAlias $adapter.Name -IPAddress "{{ target_ip }}" -PrefixLength 24 -DefaultGateway 192.168.35.1
      async: 10
      poll: 0
      ignore_errors: yes

- name: Wait for IPs to Stabilize
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Wait 15 seconds
      pause:
        seconds: 15

- name: Phase 2 - Configure DNS and Hostnames
  hosts: windows_vms
  gather_facts: no
  serial: 1

  tasks:
    - name: Test new static IP
      wait_for:
        host: "{{ target_ip }}"
        port: 5985
        timeout: 30
      delegate_to: localhost
      ignore_errors: yes
      register: ip_test

    - name: Skip if unreachable
      meta: end_host
      when: ip_test is failed

    - name: Update to use static IP
      set_fact:
        ansible_host: "{{ target_ip }}"

    - name: Configure DNS
      win_shell: |
        $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
        Set-DnsClientServerAddress -InterfaceAlias $adapter.Name -ServerAddresses "192.168.33.6","192.168.33.7"

    - name: Set hostname
      win_hostname:
        name: "{{ target_hostname }}"
      register: hostname_result

- name: Reboot VMs
  hosts: windows_vms
  gather_facts: no

  tasks:
    - name: Reboot if needed
      win_reboot:
        reboot_timeout: 600
      when: hostvars[inventory_hostname].hostname_result.reboot_required | default(false)

- name: Summary
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Display completion
      debug:
        msg:
          - "=========================================="
          - "IP Configuration Complete!"
          - "=========================================="
          - "All VMs configured with static IPs"
          - "DNS and hostnames set"
          - "VMs rebooted as needed"
          - "=========================================="