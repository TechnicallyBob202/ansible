---
# Full VM deployment: clone + configure + start

- name: Clone VM from template
  include_tasks: clone.yml

- name: Set vm_changed based on clone result
  set_fact:
    vm_changed: "{{ not (vm_preexisted | default(false)) }}"

- name: Wait for clone to complete
  pause:
    seconds: 10
  when:
    - not vm_preexisted
    - clone_result is defined
    - clone_result.changed

- name: Preflight check - compute VM facts
  include_tasks: preflight.yml

- name: Configure VM network
  include_tasks: configure_network.yml

- name: Configure VM hardware
  include_tasks: configure_hardware.yml

- name: Start VM
  include_tasks: start.yml

- name: Deployment summary
  debug:
    msg:
      - "VM {{ inventory_hostname }} deployment complete"
      - "  VMID: {{ vmid }}"
      - "  Node: {{ proxmox_node }}"
      - "  Cores: {{ vm_cores }}"
      - "  Memory: {{ vm_memory }} MB"
      - "  Disk: {{ vm_disk }}"
      - "  IP: {{ ansible_host }}"
      - "  Newly deployed: {{ vm_changed | default(false) }}"