---
# Configure DNS servers on Linux using NetworkManager

- name: Get active ethernet connections
  ansible.builtin.command: nmcli -t -f NAME,TYPE,DEVICE,STATE c show --active
  register: nmcli_active
  changed_when: false
  become: true

- name: Determine connection name and interface
  ansible.builtin.set_fact:
    linux_conn_name: "{{ (nmcli_active.stdout_lines | map('split', ':') | selectattr(1, 'search', 'ethernet') | list | first)[0] }}"
    linux_ifname: "{{ (nmcli_active.stdout_lines | map('split', ':') | selectattr(1, 'search', 'ethernet') | list | first)[2] }}"
  when:
    - (linux_conn_name is not defined or linux_ifname is not defined)
    - nmcli_active.stdout_lines | map('split', ':') | selectattr(1, 'search', 'ethernet') | list | length > 0

- name: Configure DNS servers via nmcli
  community.general.nmcli:
    conn_name: "{{ linux_conn_name | default('System eth0') }}"
    ifname: "{{ linux_ifname | default('eth0') }}"
    type: ethernet
    dns4: "{{ linux_dns_servers | default(['1.1.1.1','1.0.0.1']) | join(',') }}"
    state: present
    autoconnect: yes
  register: dns_config
  become: true

- name: Display result
  debug:
    msg: "{{ inventory_hostname }} - DNS {{ 'configured to' if dns_config.changed else 'already set to' }} {{ linux_dns_servers | default(['1.1.1.1','1.0.0.1']) | join(', ') }}"