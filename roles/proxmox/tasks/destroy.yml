---
# Destroy (delete) a VM
- name: Check if VM exists
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: current
  register: vm_exists
  failed_when: false
  changed_when: false

- name: Stop VM before destruction (best effort)
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: stopped
    force: yes
  when: vm_exists.status is defined
  failed_when: false
  ignore_errors: true

- name: Destroy VM (purge disks)
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: absent
    purge: true
  when: vm_exists.status is defined
  register: destroy_result
  failed_when: false

- name: Record per-host destruction result
  set_fact:
    host_destroyed: "{{ destroy_result.changed | default(false) }}"
    host_absent: "{{ (destroy_result.changed | default(false)) | ternary(false, true) }}"
    host_skipped: "{{ vm_exists.status is not defined }}"

- name: Display destruction result
  debug:
    msg: >-
      VM {{ inventory_hostname }} ({{ vmid }}) - {{
        host_destroyed | ternary('destroyed',
        host_skipped | ternary('absent (pre-check)', 'did not exist'))
      }}