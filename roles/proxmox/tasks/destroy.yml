---
# Destroy (delete) a VM

- name: Check if VM exists
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: current
  register: vm_exists
  failed_when: false
  changed_when: false
  delegate_to: localhost
  vars:
    ansible_connection: local
    ansible_python_interpreter: /usr/bin/python3

- set_fact:
    vm_is_present: "{{ (vm_exists is defined) and (vm_exists.status is defined) and (vm_exists.status == 'running' or vm_exists.status == 'stopped') }}"
    
- name: Stop VM before destruction
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: stopped
    force: yes
  when: vm_exists.failed == false
  ignore_errors: true
  delegate_to: localhost
  vars:
    ansible_connection: local
    ansible_python_interpreter: /usr/bin/python3

- name: Wait for VM to stop
  pause:
    seconds: 5
  when: vm_exists.failed == false

- name: Destroy VM
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: absent
  when: vm_exists.failed == false
  register: destroy_result
  delegate_to: localhost
  vars:
    ansible_connection: local
    ansible_python_interpreter: /usr/bin/python3

- name: Display destruction result
  debug:
    msg: "VM {{ inventory_hostname }} ({{ vmid }}) - {{ 'destroyed' if destroy_result.changed | default(false) else 'did not exist or was not destroyed' }}"