---
# Destroy (delete) a VM using cluster-wide VM info and node->IP mapping, with purge

# Stop (best effort) and destroy on the resolved node
- name: Stop VM before destruction (best effort)
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: stopped
    force: yes

- name: Wait for VM to stop
  pause:
    seconds: 5

- name: Destroy VM (purge disks)
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: absent
    purge: true
  register: destroy_result

- name: Display destruction result
  debug:
    msg: >-
      VM {{ inventory_hostname }} ({{ vmid }}) - {{
        (_vm_match is defined)
          | ternary( (destroy_result.changed | default(false)) | ternary('destroyed (purged)','already absent'),
                    'not found')
      }}