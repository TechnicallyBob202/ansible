---
# Destroy (delete) a VM idempotently

- name: Stop VM before destruction (best effort)
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: stopped
    force: true
    timeout: "{{ proxmox_stop_timeout | default(120) }}"
  failed_when: false
  ignore_errors: true

- name: Destroy VM (purge disks)
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: absent
    purge: true
    timeout: "{{ proxmox_destroy_timeout | default(300) }}"
  register: destroy_result
  # Do NOT suppress failures here; surface auth/API errors.

- name: Record per-host destruction result
  set_fact:
    host_destroyed: "{{ destroy_result.changed | default(false) }}"
    host_skipped: false

- name: Display destruction result
  debug:
    msg: "VM {{ inventory_hostname }} ({{ vmid }}) - {{ host_destroyed | ternary('destroyed', 'already absent') }}"