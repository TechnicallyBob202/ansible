---
# Create or update a stage-specific snapshot
# Logic: create if missing, replace only if vm_changed, skip if exists and unchanged

- block:
    - name: Ensure default snapshot vars
      set_fact:
        snapshot_name: "{{ snapshot_name | default('post-deploy') }}"
        proxmox_snapshot_vmstate: "{{ proxmox_snapshot_vmstate | default(false) }}"
      delegate_facts: false

    - name: Debug vmid and proxmox_node
      debug:
        msg:
          - "{{ inventory_hostname }}"
          - "  vmid: {{ vmid | default('NOT SET') }}"
          - "  proxmox_node: {{ proxmox_node | default('NOT SET') }}"
          - "  proxmox_host: {{ proxmox_host | default('NOT SET') }}"

    - name: Check if snapshot exists
      shell: |
        ssh -i /root/.ssh/ansible_key \
          -o StrictHostKeyChecking=no \
          root@{{ proxmox_host }} \
          "qm snapshot {{ vmid }} --list" 2>&1 | grep -q "{{ snapshot_name }}" && echo "exists" || echo "missing"
      delegate_to: localhost
      register: snapshot_check
      changed_when: false
      failed_when: false

    - name: Debug snapshot check command
      debug:
        msg: "Command that will run: ssh root@{{ proxmox_host }} 'qm snapshot {{ vmid }} --list' | grep '{{ snapshot_name }}'"

    - name: Debug snapshot check
      debug:
        msg:
          - "{{ inventory_hostname }}"
          - "  snapshot_check.stdout: '{{ snapshot_check.stdout | trim }}'"
          - "  vm_changed: {{ vm_changed | default(false) }}"

    - name: Determine snapshot action
      set_fact:
        snapshot_action: "{{ 'replace' if (snapshot_check.stdout | trim == 'exists' and vm_changed | default(false)) else ('create' if snapshot_check.stdout | trim == 'missing' else 'skip') }}"

    - name: Display snapshot plan
      debug:
        msg: "{{ inventory_hostname }} - snapshot '{{ snapshot_name }}': {{ snapshot_action | upper }}"

    - name: Remove existing snapshot (if replacing)
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: absent
        force: true
        timeout: 300
      when: snapshot_action == 'replace'
      failed_when: false
      register: remove_snapshot_result
      delegate_to: localhost

    - name: Wait for removal to complete
      pause:
        seconds: 10
      when: snapshot_action == 'replace' and remove_snapshot_result.changed | default(false)

    - name: Create snapshot
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: present
        description: "{{ snapshot_description | default(snapshot_name) }}"
        vmstate: "{{ proxmox_snapshot_vmstate }}"
        timeout: 600
      when: snapshot_action in ['create', 'replace']
      register: snapshot_result
      retries: 3
      delay: 10
      until: snapshot_result is succeeded
      delegate_to: localhost

    - name: Display result
      debug:
        msg: "{{ inventory_hostname }} - snapshot '{{ snapshot_name }}' {{ snapshot_action | upper }}"
      when: snapshot_action in ['create', 'replace']

  delegate_to: localhost