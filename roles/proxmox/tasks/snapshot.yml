---
# roles/proxmox/tasks/snapshot.yml
# Delete-then-create a stage-specific snapshot using proxmox_snap only.

- block:
    - name: Ensure default snapshot vars
      set_fact:
        snapshot_name: "{{ snapshot_name | default('post-deploy') }}"
        proxmox_snapshot_vmstate: "{{ proxmox_snapshot_vmstate | default(false) }}"
      delegate_facts: false

    - name: Check if VM exists (on this node)
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        vmid: "{{ vmid }}"
        node: "{{ proxmox_node }}"
        state: current
      register: vm_exists
      failed_when: false
      changed_when: false

    - name: Remove existing stage snapshot (if present)
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: absent
      when: vm_exists.status is defined

    - name: Create stage snapshot
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: present
        description: "Stage snapshot: {{ snapshot_name }}"
        vmstate: "{{ proxmox_snapshot_vmstate }}"
      when: vm_exists.status is defined
      register: snapshot_result

    - name: Display snapshot result
      debug:
        msg: "VM {{ inventory_hostname }} ({{ vmid }}) snapshot '{{ snapshot_name }}' {{ 'created' if snapshot_result.changed else 'already existed' }}"
      when: vm_exists.status is defined

  delegate_to: localhost