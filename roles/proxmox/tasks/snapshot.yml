---
# Create or update a stage-specific snapshot
# Logic: create if missing, replace if vm_changed=true, skip if exists and unchanged

- block:
    - name: Ensure default snapshot vars
      set_fact:
        snapshot_name: "{{ snapshot_name | default('post-deploy') }}"
        proxmox_snapshot_vmstate: "{{ proxmox_snapshot_vmstate | default(false) }}"
      delegate_facts: false

    - name: Get snapshot list via REST API
      ansible.builtin.uri:
        url: "https://{{ proxmox_host }}:8006/api2/json/nodes/{{ proxmox_node }}/qemu/{{ vmid }}/status/current"
        method: GET
        user: "{{ proxmox_user }}"
        password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        force_basic_auth: yes
      delegate_to: localhost
      register: vm_status
      changed_when: false
      ignore_errors: true

    - name: Debug API response
      debug:
        msg:
          - "API status: {{ vm_status.status | default('NO STATUS') }}"
          - "API failed: {{ vm_status.failed | default(false) }}"
          - "Response keys: {{ vm_status.json.keys() | list if vm_status.json is defined else 'NO JSON' }}"
      when: vm_status.json is defined or vm_status.failed

    - name: Check if snapshot exists
      set_fact:
        snapshot_exists: "{{ snapshot_name in (vm_status.json.snapshots | default([]) | map(attribute='name') | list) }}"
      when: vm_status.json is defined and not vm_status.failed

    - name: Set snapshot_exists to false if API call failed
      set_fact:
        snapshot_exists: false
      when: vm_status.failed or vm_status.json is not defined

    - name: Determine snapshot action
      set_fact:
        snapshot_action: >-
          {%- if vm_changed | default(false) -%}
            {%- if snapshot_exists -%}replace{%- else -%}create{%- endif -%}
          {%- elif snapshot_exists -%}skip
          {%- else -%}create
          {%- endif -%}

    - name: Display snapshot plan
      debug:
        msg: "{{ inventory_hostname }} - snapshot '{{ snapshot_name }}': {{ snapshot_action | upper }} (exists: {{ snapshot_exists }})"

    - name: Remove existing snapshot (if replacing)
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: absent
        force: true
        timeout: 300
      when: snapshot_action == 'replace'
      failed_when: false
      register: remove_snapshot_result
      delegate_to: localhost

    - name: Wait for removal to complete
      pause:
        seconds: 10
      when: snapshot_action == 'replace' and remove_snapshot_result.changed | default(false)

    - name: Create snapshot
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: present
        description: "{{ snapshot_description | default(snapshot_name) }}"
        vmstate: "{{ proxmox_snapshot_vmstate }}"
        timeout: 600
      when: snapshot_action in ['create', 'replace']
      register: snapshot_result
      retries: 3
      delay: 10
      until: snapshot_result is succeeded
      delegate_to: localhost

    - name: Display result
      debug:
        msg: "{{ inventory_hostname }} - snapshot '{{ snapshot_name }}' {{ snapshot_action | upper }}"
      when: snapshot_action in ['create', 'replace']

  delegate_to: localhost