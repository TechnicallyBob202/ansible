---
# roles/proxmox/tasks/snapshot.yml
# Idempotent: remove a fixed-named snapshot if it exists, then create it again.

- block:
    - name: Check if VM exists (on this node)
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        vmid: "{{ vmid }}"
        node: "{{ proxmox_node }}"
        state: current
      register: vm_exists
      failed_when: false
      changed_when: false

    - name: Remove existing post-deploy snapshot (if present)
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: absent
      when: vm_exists.status is defined

    - name: Create post-deploy snapshot
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: present
        description: "Post-deploy snapshot {{ snapshot_name }}"
        vmstate: "{{ proxmox_snapshot_vmstate }}"
      when: vm_exists.status is defined
      register: snapshot_result

    - name: Display snapshot result
      debug:
        msg: "VM {{ inventory_hostname }} ({{ vmid }}) snapshot '{{ snapshot_name }}' {{ 'created' if snapshot_result.changed else 'already existed' }}"
      when: vm_exists.status is defined

  vars:
    # Use a fixed name so delete-then-create works without listing
    snapshot_name: "{{ snapshot_name | default('post-deploy') }}"
    proxmox_snapshot_vmstate: "{{ proxmox_snapshot_vmstate | default(false) }}"
  delegate_to: localhost