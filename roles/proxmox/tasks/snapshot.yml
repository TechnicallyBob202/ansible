---
# Create or update a stage-specific snapshot
# Logic: create if missing, replace if vm_changed=true, skip if exists and unchanged

- block:
    - name: Ensure default snapshot vars
      set_fact:
        snapshot_name: "{{ snapshot_name | default('post-deploy') }}"
        proxmox_snapshot_vmstate: "{{ proxmox_snapshot_vmstate | default(false) }}"
      delegate_facts: false

    - name: Get snapshot list via qm command
      ansible.builtin.shell: |
        ssh -i /root/.ssh/ansible_key \
          -o StrictHostKeyChecking=no \
          root@{{ proxmox_host }} \
          "qm snapshot {{ vmid }} --list" 2>&1
      delegate_to: localhost
      register: qm_output
      changed_when: false
      ignore_errors: true

    - name: Debug qm output
      debug:
        msg:
          - "VMID: {{ vmid }}"
          - "Full output:"
          - "{{ qm_output.stdout_lines }}"

    - name: Check if snapshot exists by parsing qm output
      set_fact:
        snapshot_exists: "{{ qm_output.stdout is regex('.*' + snapshot_name + '.*') }}"
      when: qm_output.rc == 0

    - name: Determine snapshot action
      set_fact:
        snapshot_action: >-
          {%- if vm_changed | default(false) -%}
            {%- if snapshot_exists -%}replace{%- else -%}create{%- endif -%}
          {%- elif snapshot_exists -%}skip
          {%- else -%}create
          {%- endif -%}

    - name: Display snapshot plan
      debug:
        msg: "{{ inventory_hostname }} - snapshot '{{ snapshot_name }}': {{ snapshot_action | upper }} (exists: {{ snapshot_exists }})"

    - name: Remove existing snapshot (if replacing)
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: absent
        force: true
        timeout: 300
      when: snapshot_action == 'replace'
      failed_when: false
      register: remove_snapshot_result
      delegate_to: localhost

    - name: Wait for removal to complete
      pause:
        seconds: 10
      when: snapshot_action == 'replace' and remove_snapshot_result.changed | default(false)

    - name: Create snapshot
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: present
        description: "{{ snapshot_description | default(snapshot_name) }}"
        vmstate: "{{ proxmox_snapshot_vmstate }}"
        timeout: 600
      when: snapshot_action in ['create', 'replace']
      register: snapshot_result
      retries: 3
      delay: 10
      until: snapshot_result is succeeded
      delegate_to: localhost

    - name: Display result
      debug:
        msg: "{{ inventory_hostname }} - snapshot '{{ snapshot_name }}' {{ snapshot_action | upper }}"
      when: snapshot_action in ['create', 'replace']

  delegate_to: localhost