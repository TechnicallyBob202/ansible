---
# Clone a VM from template

- name: Check if VM already exists
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    vmid: "{{ vmid }}"
    node: "{{ proxmox_node }}"
    state: current
  register: vm_check
  failed_when: false
  changed_when: false

- name: Clone VM from template
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ template_id }}"
    clone: "{{ template_id }}"
    newid: "{{ vmid }}"
    name: "{{ inventory_hostname }}"
    pool: "{{ proxmox_pool }}"
    full: yes
    timeout: "{{ proxmox_clone_timeout }}"
  when: vm_check.failed or vm_check.status is not defined
  register: clone_result

- name: Display clone result
  debug:
    msg: "VM {{ inventory_hostname }} ({{ vmid }}) - {{ 'cloned from template' if clone_result.changed else 'already exists' }}"