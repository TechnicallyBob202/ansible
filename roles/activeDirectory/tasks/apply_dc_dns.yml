---
# Apply DNS configuration to DC after promotion
# This runs AFTER microsoft.ad promotion completes
# Uses the windows_dns_servers variable from group_vars

- name: Get current DNS configuration
  ansible.windows.win_shell: |
    $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
    $dns = Get-DnsClientServerAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4
    $dns.ServerAddresses -join ","
  register: current_dns
  changed_when: false

- name: Set DNS servers on {{ inventory_hostname }}
  ansible.windows.win_shell: |
    $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
    Set-DnsClientServerAddress -InterfaceAlias $adapter.Name -ServerAddresses "{{ windows_dns_servers | join('","') }}"
    Clear-DnsClientCache
  register: dns_set
  changed_when: "'{{ windows_dns_servers[0] }}' not in current_dns.stdout"

- name: Verify DNS configuration
  ansible.windows.win_shell: |
    $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
    $dns = Get-DnsClientServerAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4
    Write-Output "DNS servers: $($dns.ServerAddresses -join ', ')"
  register: dns_verify
  changed_when: false

- name: Display DNS configuration
  debug:
    msg:
      - "{{ inventory_hostname }} DNS configured"
      - "  {{ dns_verify.stdout | trim }}"
  when: dns_set.changed