---
# Assign users to groups to create realistic membership patterns

- name: Get domain DN
  ansible.windows.win_shell: |
    (Get-ADDomain).DistinguishedName
  register: domain_dn_result
  changed_when: false

- name: Set domain facts
  set_fact:
    domain_dn: "{{ domain_dn_result.stdout | trim }}"
    top_level_ou_name: "{{ netbios_name }}"

# 1) Department group assignments for Standard Users
- name: Assign users to department security groups
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"

    # Get all standard users
    $standardUsersOU = "OU=Standard Users,OU=Users,OU={{ top_level_ou_name }},{{ domain_dn }}"
    $allUsers = Get-ADUser -Filter * -SearchBase $standardUsersOU

    if (-not $allUsers -or $allUsers.Count -eq 0) {
      Write-Output "NO_USERS"
      exit 0
    }

    # Define department groups and assign random users
    $departments = @(
      "Finance-Users",
      "HR-Users",
      "Sales-Users",
      "Marketing-Users",
      "Engineering-Users"
    )

    $assignedCount = 0
    # Ensure at least 1 per dept when users exist
    $usersPerDept = [math]::Max(1, [math]::Floor($allUsers.Count / [math]::Max(1, $departments.Count)))

    # Shuffle user pool
    $userPool = $allUsers | Sort-Object {Get-Random}
    $currentIndex = 0

    foreach ($deptGroup in $departments) {
      try {
        $group = Get-ADGroup -Identity $deptGroup -ErrorAction Stop

        $endIndex = [math]::Min($currentIndex + $usersPerDept - 1, $userPool.Count - 1)
        if ($endIndex -lt $currentIndex) { continue }

        $usersForThisGroup = $userPool[$currentIndex..$endIndex]

        foreach ($user in $usersForThisGroup) {
          try {
            Add-ADGroupMember -Identity $group -Members $user -ErrorAction SilentlyContinue
            $assignedCount++
          } catch {
            # Ignore membership duplicates
          }
        }

        $currentIndex = $endIndex + 1
        if ($currentIndex -ge $userPool.Count) { break }
      } catch {
        Write-Warning "Could not assign to $deptGroup : $_"
      }
    }

    Write-Output "ASSIGNED=$assignedCount"
  register: department_assignments
  changed_when: >
    'ASSIGNED=' in (department_assignments.stdout | default('')) and
    (
      (department_assignments.stdout | default('') | split('=') | last | int) > 0
    )

# 2) Privileged users to IT groups
- name: Assign privileged users to IT groups
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"

    $privUsersOU = "OU=Privileged Users,OU=Users,OU={{ top_level_ou_name }},{{ domain_dn }}"
    $privUsers = Get-ADUser -Filter * -SearchBase $privUsersOU

    if (-not $privUsers -or $privUsers.Count -eq 0) {
      Write-Output "NO_USERS"
      exit 0
    }

    $assignedCount = 0

    # Add all privileged users to IT-Admins if it exists
    try {
      $itAdminsGroup = Get-ADGroup -Identity "IT-Admins" -ErrorAction Stop
      foreach ($user in $privUsers) {
        try {
          Add-ADGroupMember -Identity $itAdminsGroup -Members $user -ErrorAction SilentlyContinue
          $assignedCount++
        } catch {}
      }
    } catch {
      Write-Warning "Could not assign to IT-Admins"
    }

    # Randomly assign some to other IT groups (clamped)
    $itGroups = @("IT-HelpDesk", "IT-ServerAdmins", "Security-Team")
    foreach ($group in $itGroups) {
      try {
        $groupObj = Get-ADGroup -Identity $group -ErrorAction Stop
        $take = [Math]::Min(3, [Math]::Max(0, $privUsers.Count))
        if ($take -le 0) { continue }
        $randomUsers = $privUsers | Get-Random -Count $take
        foreach ($user in $randomUsers) {
          try {
            Add-ADGroupMember -Identity $groupObj -Members $user -ErrorAction SilentlyContinue
            $assignedCount++
          } catch {}
        }
      } catch {
        Write-Warning "Could not assign to $group"
      }
    }

    Write-Output "ASSIGNED=$assignedCount"
  register: privileged_assignments
  changed_when: >
    'ASSIGNED=' in (privileged_assignments.stdout | default('')) and
    (
      (privileged_assignments.stdout | default('') | split('=') | last | int) > 0
    )

# 3) Admin accounts to admin groups and Privileged-Access
- name: Assign administrators to admin groups
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"

    $adminsOU = "OU=Administrators,OU={{ top_level_ou_name }},{{ domain_dn }}"
    $adminUsers = Get-ADUser -Filter * -SearchBase $adminsOU

    if (-not $adminUsers -or $adminUsers.Count -eq 0) {
      Write-Output "NO_USERS"
      exit 0
    }

    $assignedCount = 0

    # Add one helpdesk admin if present
    $helpDeskUser = $adminUsers | Where-Object {$_.SamAccountName -like "*helpdesk*"} | Select-Object -First 1
    if ($helpDeskUser) {
      try { Add-ADGroupMember -Identity "IT-HelpDesk" -Members $helpDeskUser -ErrorAction SilentlyContinue; $assignedCount++ } catch {}
    }

    # Add one server admin if present
    $serverAdminUser = $adminUsers | Where-Object {$_.SamAccountName -like "*server*"} | Select-Object -First 1
    if ($serverAdminUser) {
      try { Add-ADGroupMember -Identity "IT-ServerAdmins" -Members $serverAdminUser -ErrorAction SilentlyContinue; $assignedCount++ } catch {}
    }

    # Add all admins to Privileged-Access if it exists
    try {
      $privAccessGroup = Get-ADGroup -Identity "Privileged-Access" -ErrorAction Stop
      foreach ($admin in $adminUsers) {
        try { Add-ADGroupMember -Identity $privAccessGroup -Members $admin -ErrorAction SilentlyContinue; $assignedCount++ } catch {}
      }
    } catch {
      Write-Warning "Could not assign to Privileged-Access"
    }

    Write-Output "ASSIGNED=$assignedCount"
  register: admin_assignments
  changed_when: >
    'ASSIGNED=' in (admin_assignments.stdout | default('')) and
    (
      (admin_assignments.stdout | default('') | split('=') | last | int) > 0
    )

# 4) Distribution groups across all users under the top OU
- name: Assign random users to distribution groups
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"

    $topOU = "OU={{ top_level_ou_name }},{{ domain_dn }}"
    $allUsers = Get-ADUser -Filter * -SearchBase $topOU

    if (-not $allUsers -or $allUsers.Count -eq 0) {
      Write-Output "NO_USERS"
      exit 0
    }

    $assignedCount = 0

    # Assign everyone to All-Employees if present
    try {
      $allEmployeesGroup = Get-ADGroup -Identity "All-Employees" -ErrorAction Stop
      foreach ($user in $allUsers) {
        try { Add-ADGroupMember -Identity $allEmployeesGroup -Members $user -ErrorAction SilentlyContinue; $assignedCount++ } catch {}
      }
    } catch {
      Write-Warning "Could not assign to All-Employees"
    }

    # Assign ~30% of users to these groups if present
    $distGroups = @("Company-News", "Social-Events", "Training-Announcements")
    foreach ($group in $distGroups) {
      try {
        $groupObj = Get-ADGroup -Identity $group -ErrorAction Stop
        $randomCount = [math]::Floor($allUsers.Count * 0.3)
        if ($randomCount -le 0) { continue }
        $randomUsers = $allUsers | Get-Random -Count $randomCount
        foreach ($user in $randomUsers) {
          try { Add-ADGroupMember -Identity $groupObj -Members $user -ErrorAction SilentlyContinue; $assignedCount++ } catch {}
        }
      } catch {
        Write-Warning "Could not assign to $group"
      }
    }

    Write-Output "ASSIGNED=$assignedCount"
  register: distribution_assignments
  changed_when: >
    'ASSIGNED=' in (distribution_assignments.stdout | default('')) and
    (
      (distribution_assignments.stdout | default('') | split('=') | last | int) > 0
    )

# Parse and summarize
- name: Parse assignment results
  set_fact:
    department_assigned: "{{ (department_assignments.stdout | default('ASSIGNED=0') | split('=') | last) }}"
    privileged_assigned: "{{ (privileged_assignments.stdout | default('ASSIGNED=0') | split('=') | last) }}"
    admin_assigned: "{{ (admin_assignments.stdout | default('ASSIGNED=0') | split('=') | last) }}"
    distribution_assigned: "{{ (distribution_assignments.stdout | default('ASSIGNED=0') | split('=') | last) }}"

- name: Display membership assignment summary
  debug:
    msg:
      - "Group memberships assigned for {{ domain_name }}:"
      - "  Department groups: {{ department_assigned }} assignments"
      - "  Privileged/IT groups: {{ privileged_assigned }} assignments"
      - "  Admin groups: {{ admin_assigned }} assignments"
      - "  Distribution groups: {{ distribution_assigned }} assignments"
      - "  Total: {{ (department_assigned | int) + (privileged_assigned | int) + (admin_assigned | int) + (distribution_assigned | int) }} memberships"