---
# Verify Active Directory replication is healthy

- name: Get replication status
  ansible.windows.win_shell: |
    $replStatus = Get-ADReplicationPartnerMetadata -Target $env:COMPUTERNAME -Scope Domain
    $failures = $replStatus | Where-Object { $_.LastReplicationResult -ne 0 }

    if ($failures) {
      [PSCustomObject]@{
        Status = "FAILED"
        FailureCount = $failures.Count
        Partners = ($replStatus | Select-Object Partner, LastReplicationResult, LastReplicationSuccess | ConvertTo-Json)
      } | ConvertTo-Json
    } else {
      [PSCustomObject]@{
        Status = "OK"
        FailureCount = 0
        PartnerCount = $replStatus.Count
        Partners = ($replStatus | Select-Object Partner, LastReplicationResult, LastReplicationSuccess | ConvertTo-Json)
      } | ConvertTo-Json
    }
  register: repl_status
  retries: "{{ ad_replication_check_retries }}"
  delay: "{{ ad_replication_check_delay }}"
  until: (repl_status.stdout | from_json).Status == "OK"
  changed_when: false
  failed_when: false

- name: Parse replication status
  set_fact:
    replication_info: "{{ repl_status.stdout | from_json }}"

- name: Display replication status
  debug:
    msg:
      - "Replication Status for {{ inventory_hostname }}: {{ replication_info.Status }}"
      - "  Partners: {{ replication_info.PartnerCount | default(0) }}"
      - "  Failures: {{ replication_info.FailureCount }}"

- name: Fail if replication has errors
  fail:
    msg: "Replication failures detected on {{ inventory_hostname }}"
  when: replication_info.Status != "OK"