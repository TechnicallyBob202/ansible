---
# Always-run healing for forest root PDCs:
# DNS = [self, forest root replica] (+ child PDCs if include_child_dns_in_roots is true)

- name: Resolve replica and child PDC IPs (once)
  set_fact:
    arbor_root_replica_ip: >-
      {{ (groups['arbor_forest_root_replica'] | default([])) | length > 0
         | ternary(hostvars[groups['arbor_forest_root_replica'][0]].ansible_host, omit) }}
    alpine_root_replica_ip: >-
      {{ (groups['alpine_forest_root_replica'] | default([])) | length > 0
         | ternary(hostvars[groups['alpine_forest_root_replica'][0]].ansible_host, omit) }}
    mauna_pdc_ip: >-
      {{ (groups['mauna_child_pdc'] | default([])) | length > 0
         | ternary(hostvars[groups['mauna_child_pdc'][0]].ansible_host, omit) }}
    rainier_pdc_ip: >-
      {{ (groups['rainier_child_pdc'] | default([])) | length > 0
         | ternary(hostvars[groups['rainier_child_pdc'][0]].ansible_host, omit) }}
  run_once: yes

- name: Build DNS list for arbor forest root PDC
  set_fact:
    windows_dns_servers: >-
      {{
        [ ansible_host ] +
        ([ arbor_root_replica_ip ] if arbor_root_replica_ip is defined else []) +
        (
          (
            ([ mauna_pdc_ip ] if mauna_pdc_ip is defined else []) +
            ([ rainier_pdc_ip ] if rainier_pdc_ip is defined else [])
          ) if include_child_dns_in_roots | default(false) else []
        )
      }}
  when: inventory_hostname in (groups['arbor_forest_root_pdc'] | default([]))

- name: Build DNS list for alpine forest root PDC
  set_fact:
    windows_dns_servers: >-
      {{
        [ ansible_host ] +
        ([ alpine_root_replica_ip ] if alpine_root_replica_ip is defined else []) +
        (
          (
            ([ mauna_pdc_ip ] if mauna_pdc_ip is defined else []) +
            ([ rainier_pdc_ip ] if rainier_pdc_ip is defined else [])
          ) if include_child_dns_in_roots | default(false) else []
        )
      }}
  when: inventory_hostname in (groups['alpine_forest_root_pdc'] | default([]))

- name: Apply DNS (post-heal)
  include_role:
    name: windows
    tasks_from: set_dns.yml
  when: windows_dns_servers is defined