---
# Link GPOs to appropriate OUs

- name: Get domain DN
  ansible.windows.win_shell: |
    (Get-ADDomain).DistinguishedName
  register: domain_dn_result
  changed_when: false

- name: Set domain facts
  set_fact:
    domain_dn: "{{ domain_dn_result.stdout | trim }}"
    top_level_ou_name: "{{ netbios_name }}"

- name: Define GPO to OU link mappings
  set_fact:
    gpo_links:
      # Domain-wide policies (linked to top-level OU)
      - gpo_name: "Password Policy - Weak"
        ou_path: "OU={{ top_level_ou_name }},{{ domain_dn }}"
        link_enabled: yes
        enforced: yes
        order: 1

      - gpo_name: "Audit Policy"
        ou_path: "OU={{ top_level_ou_name }},{{ domain_dn }}"
        link_enabled: yes
        enforced: no
        order: 2

      # User policies
      - gpo_name: "Software Deployment - Office"
        ou_path: "OU=Standard Users,OU=Users,OU={{ top_level_ou_name }},{{ domain_dn }}"
        link_enabled: yes
        enforced: no
        order: 1

      - gpo_name: "Mapped Drives"
        ou_path: "OU=Standard Users,OU=Users,OU={{ top_level_ou_name }},{{ domain_dn }}"
        link_enabled: yes
        enforced: no
        order: 2

      # Workstation policies
      - gpo_name: "Desktop Lockdown"
        ou_path: "OU=Workstations,OU=Computers,OU={{ top_level_ou_name }},{{ domain_dn }}"
        link_enabled: yes
        enforced: no
        order: 1

      - gpo_name: "Printer Deployment"
        ou_path: "OU=Workstations,OU=Computers,OU={{ top_level_ou_name }},{{ domain_dn }}"
        link_enabled: yes
        enforced: no
        order: 2

      - gpo_name: "Screen Saver Policy"
        ou_path: "OU=Workstations,OU=Computers,OU={{ top_level_ou_name }},{{ domain_dn }}"
        link_enabled: yes
        enforced: no
        order: 3

      # Server policies
      - gpo_name: "Firewall Rules"
        ou_path: "OU=Servers,OU=Computers,OU={{ top_level_ou_name }},{{ domain_dn }}"
        link_enabled: yes
        enforced: no
        order: 1

      - gpo_name: "Windows Update Settings"
        ou_path: "OU=Servers,OU=Computers,OU={{ top_level_ou_name }},{{ domain_dn }}"
        link_enabled: yes
        enforced: no
        order: 2

      # Note: "Orphaned GPO 1" and "Orphaned GPO 2" are intentionally NOT linked

- name: Check which GPOs exist before linking
  ansible.windows.win_shell: |
    try {
      Get-GPO -Name "{{ item.gpo_name }}" -ErrorAction Stop | Out-Null
      Write-Output "EXISTS"
    } catch {
      Write-Output "NOT_EXISTS"
    }
  loop: "{{ gpo_links }}"
  register: gpo_exists_check
  changed_when: false

- name: Check if GPO links already exist
  ansible.windows.win_shell: |
    $gpoName = "{{ item.item.gpo_name }}"
    $ouPath = "{{ item.item.ou_path }}"

    try {
      $links = Get-GPInheritance -Target $ouPath -ErrorAction Stop
      $existingLink = $links.GpoLinks | Where-Object { $_.DisplayName -eq $gpoName }

      if ($existingLink) {
        Write-Output "LINKED"
      } else {
        Write-Output "NOT_LINKED"
      }
    } catch {
      Write-Output "ERROR: $($_.Exception.Message)"
    }
  loop: "{{ gpo_exists_check.results }}"
  when: "'EXISTS' in item.stdout"
  register: link_check
  changed_when: false
  failed_when: "'ERROR:' in link_check.stdout"

- name: Create GPO links
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $gpoName = "{{ item.item.item.gpo_name }}"
    $ouPath = "{{ item.item.item.ou_path }}"
    $linkEnabled = [bool]::Parse("{{ item.item.item.link_enabled }}")
    $enforced = [bool]::Parse("{{ item.item.item.enforced }}")
    $order = {{ item.item.item.order }}

    try {
      $link = New-GPLink -Name $gpoName -Target $ouPath -LinkEnabled $linkEnabled -Enforced $enforced -Order $order -ErrorAction Stop
      Write-Output "LINKED: $gpoName to $ouPath"
    } catch {
      Write-Output "ERROR: $($_.Exception.Message)"
    }
  loop: "{{ link_check.results }}"
  when:
    - item.item is defined
    - "'NOT_LINKED' in item.stdout"
  register: link_creation
  changed_when: "'LINKED:' in link_creation.stdout"
  failed_when: "'ERROR:' in link_creation.stdout"

- name: Count GPO links
  set_fact:
    total_links: "{{ gpo_links | length }}"
    created_links: "{{ link_creation.results | selectattr('changed', 'equalto', true) | list | length }}"
    existing_links: "{{ link_check.results | selectattr('stdout', 'search', 'LINKED') | list | length | default(0) }}"

- name: Display GPO linking summary
  debug:
    msg:
      - "GPO Linking Summary for {{ domain_name }}:"
      - "  Created: {{ created_links }}"
      - "  Already existed: {{ existing_links }}"
      - "  Total: {{ total_links }}"
      - ""
      - "GPO Links:"
      - "  OU={{ top_level_ou_name }}:"
      - "    • Password Policy - Weak (ENFORCED)"
      - "    • Audit Policy"
      - "  OU=Standard Users:"
      - "    • Software Deployment - Office"
      - "    • Mapped Drives"
      - "  OU=Workstations:"
      - "    • Desktop Lockdown"
      - "    • Printer Deployment"
      - "    • Screen Saver Policy"
      - "  OU=Servers:"
      - "    • Firewall Rules"
      - "    • Windows Update Settings"
      - ""
      - "Orphaned GPOs (intentionally unlinked):"
      - "    • Orphaned GPO 1"
      - "    • Orphaned GPO 2"