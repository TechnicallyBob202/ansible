---
# Always-run healing for forest root replicas: ensure DNS = [self, forest root PDC]

- name: Resolve forest root PDC IPs (once)
  set_fact:
    arbor_root_pdc_ip: "{{ hostvars[groups['arbor_forest_root_pdc'][0]].ansible_host }}"
    alpine_root_pdc_ip: "{{ hostvars[groups['alpine_forest_root_pdc'][0]].ansible_host }}"
  run_once: yes

- name: Set DNS for forest root replicas (post)
  set_fact:
    windows_dns_servers: >-
      {{
        [ ansible_host ] +
        (
          [ arbor_root_pdc_ip ]
          if inventory_hostname in (groups['arbor_forest_root_replica'] | default([]))
          else [ alpine_root_pdc_ip ]
        )
      }}

- name: Apply DNS (post)
  include_role:
    name: windows
    tasks_from: set_dns.yml