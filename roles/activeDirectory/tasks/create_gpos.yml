---
# Create Group Policy Objects (GPOs)

- name: Get domain DN
  ansible.windows.win_shell: |
    (Get-ADDomain).DistinguishedName
  register: domain_dn_result
  changed_when: false

- name: Set domain facts
  set_fact:
    domain_dn: "{{ domain_dn_result.stdout | trim }}"
    top_level_ou_name: "{{ netbios_name }}"

- name: Define GPO list
  set_fact:
    gpos_to_create:
      - name: "Password Policy - Weak"
        comment: "Weak password policy for testing/demos"
      - name: "Desktop Lockdown"
        comment: "Desktop lockdown settings for workstations"
      - name: "Software Deployment - Office"
        comment: "Microsoft Office deployment"
      - name: "Printer Deployment"
        comment: "Network printer deployment"
      - name: "Mapped Drives"
        comment: "Network drive mappings"
      - name: "Firewall Rules"
        comment: "Windows Firewall rules for servers"
      - name: "Windows Update Settings"
        comment: "Windows Update configuration"
      - name: "Screen Saver Policy"
        comment: "Screen saver lock settings"
      - name: "Audit Policy"
        comment: "Audit and logging policy"
      - name: "Orphaned GPO 1"
        comment: "Unlinked GPO for realism"
      - name: "Orphaned GPO 2"
        comment: "Another unlinked GPO"

- name: Check if GPOs already exist
  ansible.windows.win_shell: |
    try {
      Get-GPO -Name "{{ item.name }}" -ErrorAction Stop | Out-Null
      Write-Output "EXISTS"
    } catch [System.ArgumentException] {
      Write-Output "NOT_EXISTS"
    } catch {
      Write-Output "ERROR: $($_.Exception.Message)"
    }
  loop: "{{ gpos_to_create }}"
  register: gpo_check
  failed_when: "'ERROR:' in gpo_check.stdout"
  changed_when: false

- name: Create only missing GPOs
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    try {
      $null = New-GPO -Name "{{ item.item.name }}" -Comment "{{ item.item.comment }}"
      Write-Output "CREATED: {{ item.item.name }}"
    } catch {
      Write-Output "ERROR: $($_.Exception.Message)"
    }
  loop: "{{ gpo_check.results }}"
  when: "'NOT_EXISTS' in item.stdout"
  register: gpo_creation
  changed_when: "'CREATED:' in gpo_creation.stdout"
  failed_when: "'ERROR:' in gpo_creation.stdout"

- name: Count created and existing GPOs
  set_fact:
    created_gpos: "{{ gpo_creation.results | selectattr('changed', 'equalto', true) | list | length | default(0) }}"
    existing_gpos: "{{ gpo_check.results | selectattr('stdout', 'search', 'EXISTS') | list | length | default(0) }}"

- name: Display GPO creation summary
  debug:
    msg:
      - "GPO Creation Summary for {{ domain_name }}:"
      - "  Created: {{ created_gpos }}"
      - "  Already existed: {{ existing_gpos }}"
      - "  Total (tracked): {{ gpos_to_create | length }}"