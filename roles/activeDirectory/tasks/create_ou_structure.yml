---
# Create complete nested OU structure

- name: Get domain DN
  ansible.windows.win_shell: |
    (Get-ADDomain).DistinguishedName
  register: domain_dn_result
  changed_when: false

- name: Set domain facts
  set_fact:
    domain_dn: "{{ domain_dn_result.stdout | trim }}"
    top_level_ou_name: "{{ netbios_name }}"

- name: Define OU structure
  set_fact:
    ou_structure:
      # Top-level OU
      - name: "{{ top_level_ou_name }}"
        path: "{{ domain_dn }}"
        description: "Top-level OU for {{ domain_name }}"
        protected: yes

      # First-level OUs
      - name: "Users"
        path: "OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "User accounts"
        protected: yes

      - name: "Groups"
        path: "OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "Security and distribution groups"
        protected: yes

      - name: "Computers"
        path: "OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "Computer accounts"
        protected: yes

      - name: "Service Accounts"
        path: "OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "Service accounts for applications and services"
        protected: yes

      # Users sub-OUs
      - name: "Standard Users"
        path: "OU=Users,OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "Standard employee user accounts"
        protected: yes

      - name: "Privileged Users"
        path: "OU=Users,OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "Privileged user accounts (IT staff, managers)"
        protected: yes

      - name: "Disabled Users"
        path: "OU=Users,OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "Disabled user accounts"
        protected: yes

      # Groups sub-OUs
      - name: "Security Groups"
        path: "OU=Groups,OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "Security groups"
        protected: yes

      - name: "Distribution Groups"
        path: "OU=Groups,OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "Distribution groups"
        protected: yes

      # Computers sub-OUs
      - name: "Workstations"
        path: "OU=Computers,OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "End-user workstations"
        protected: yes

      - name: "Servers"
        path: "OU=Computers,OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "Server computer accounts"
        protected: yes

      - name: "Disabled Computers"
        path: "OU=Computers,OU={{ top_level_ou_name }},{{ domain_dn }}"
        description: "Disabled computer accounts"
        protected: yes

- name: Create OUs in order
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $ouName = "{{ item.name }}"
    $ouPath = "{{ item.path }}"
    $description = "{{ item.description }}"
    $protected = [bool]::Parse("{{ item.protected }}")

    try {
      $fullPath = "OU=$ouName,$ouPath"
      Get-ADOrganizationalUnit -Identity $fullPath -ErrorAction Stop | Out-Null
      Write-Output "EXISTS"
    } catch [Microsoft.ActiveDirectory.Management.ADIdentityNotFoundException] {
      New-ADOrganizationalUnit -Name $ouName -Path $ouPath `
        -Description $description `
        -ProtectedFromAccidentalDeletion $protected `
        -ErrorAction Stop | Out-Null
      Write-Output "CREATED"
    }
  loop: "{{ ou_structure }}"
  register: ou_creation
  changed_when: "'CREATED' in ou_creation.stdout"

- name: Display OU creation summary
  debug:
    msg:
      - "OU Structure created for {{ domain_name }}:"
      - "  ✓ OU={{ top_level_ou_name }},{{ domain_dn }}"
      - "    ├── OU=Users"
      - "    │   ├── OU=Standard Users"
      - "    │   ├── OU=Privileged Users"
      - "    │   └── OU=Disabled Users"
      - "    ├── OU=Groups"
      - "    │   ├── OU=Security Groups"
      - "    │   └── OU=Distribution Groups"
      - "    ├── OU=Computers"
      - "    │   ├── OU=Workstations"
      - "    │   ├── OU=Servers"
      - "    │   └── OU=Disabled Computers"
      - "    └── OU=Service Accounts"