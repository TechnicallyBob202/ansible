---
# Add users to groups to create realistic membership patterns

- name: Get all users
  ansible.windows.win_shell: |
    Get-ADUser -Filter * -SearchBase "OU=Users,{{ domain_dn }}" |
      Select-Object -ExpandProperty SamAccountName
  register: all_users
  changed_when: false

- name: Get all groups
  ansible.windows.win_shell: |
    Get-ADGroup -Filter * -SearchBase "OU=Groups,{{ domain_dn }}" |
      Select-Object -ExpandProperty SamAccountName
  register: all_groups
  changed_when: false

- name: Parse user and group lists
  set_fact:
    user_list: "{{ all_users.stdout_lines }}"
    group_list: "{{ all_groups.stdout_lines }}"

- name: Populate groups with random members
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"

    $groupName = "{{ item }}"
    $allUsers = @({{ user_list | to_json }})

    # Randomly select 5-15 users for this group
    $memberCount = Get-Random -Minimum 5 -Maximum 15
    $selectedUsers = $allUsers | Get-Random -Count $memberCount

    $added = 0
    foreach ($user in $selectedUsers) {
      try {
        Add-ADGroupMember -Identity $groupName -Members $user -ErrorAction SilentlyContinue
        $added++
      } catch {
        # User might already be a member, ignore
      }
    }

    Write-Output "ADDED $added members to $groupName"
  loop: "{{ group_list }}"
  register: group_population
  changed_when: true
  when: group_list | length > 0 and user_list | length > 0

- name: Display group population summary
  debug:
    msg: "Populated {{ group_list | length }} groups with members"
  when: group_list | length > 0