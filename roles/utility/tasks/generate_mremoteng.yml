---
# Generate mRemoteNG configuration - auto-detects ADFR vs DSP inventory

- name: Detect inventory type
  set_fact:
    is_adfr_inventory: "{{ 'adfr_infrastructure' in groups }}"
    is_dsp_inventory: "{{ 'dsp_infrastructure' in groups }}"
  delegate_to: localhost

- name: Set project paths
  set_fact:
    project_root: "{{ playbook_dir | dirname }}"
    templates_dir: "{{ (playbook_dir | dirname) }}/templates"
    files_dir: "{{ (playbook_dir | dirname) }}/files"
  delegate_to: localhost

- name: Ensure files directory exists
  file:
    path: "{{ files_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

# ============================================================================
# ADFR mRemoteNG generation
# ============================================================================
- name: Generate ADFR mRemoteNG (ADFR inventory detected)
  block:
    - name: Build ADFR lab_design from inventory
      set_fact:
        lab_design:
          adfr_infrastructure: "{{ groups.get('adfr_infrastructure', []) | map('extract', hostvars, ['hostname', 'ansible_host', 'role']) | map('combine', {'ip': hostvars[item].ansible_host}) | list | sort(attribute='hostname') }}"
          adfr_recovery: "{{ groups.get('adfr_recovery', []) | map('extract', hostvars, ['hostname', 'ansible_host', 'role']) | map('combine', {'ip': hostvars[item].ansible_host}) | list | sort(attribute='hostname') }}"
          d1_dcs: "{{ groups.get('d1_dcs', []) | map('extract', hostvars, ['hostname', 'ansible_host', 'dc_role']) | map('combine', {'ip': hostvars[item].ansible_host, 'role': hostvars[item].dc_role}) | list | sort(attribute='hostname') }}"
          d2_parent_dcs: "{{ groups.get('d2_parent_dcs', []) | map('extract', hostvars, ['hostname', 'ansible_host', 'dc_role']) | map('combine', {'ip': hostvars[item].ansible_host, 'role': hostvars[item].dc_role}) | list | sort(attribute='hostname') }}"
          d21_child_dcs: "{{ groups.get('d21_child_dcs', []) | map('extract', hostvars, ['hostname', 'ansible_host', 'dc_role']) | map('combine', {'ip': hostvars[item].ansible_host, 'role': hostvars[item].dc_role}) | list | sort(attribute='hostname') }}"
          d22_child_dcs: "{{ groups.get('d22_child_dcs', []) | map('extract', hostvars, ['hostname', 'ansible_host', 'dc_role']) | map('combine', {'ip': hostvars[item].ansible_host, 'role': hostvars[item].dc_role}) | list | sort(attribute='hostname') }}"
      delegate_to: localhost

    - name: Generate ADFR mRemoteNG XML
      template:
        src: "{{ templates_dir }}/adfr-mremoteng.xml.j2"
        dest: "{{ files_dir }}/adfr-lab-mremoteng.xml"
        mode: '0644'
      delegate_to: localhost

    - name: Display ADFR generation result
      debug:
        msg:
          - "Generated ADFR mRemoteNG: {{ files_dir }}/adfr-lab-mremoteng.xml"
          - "  Infrastructure: {{ lab_design.adfr_infrastructure | length }} VMs"
          - "  Recovery: {{ lab_design.adfr_recovery | length }} VMs"
          - "  D1.lab: {{ lab_design.d1_dcs | length }} DCs"
          - "  D2.lab: {{ (lab_design.d2_parent_dcs | length) + (lab_design.d21_child_dcs | length) + (lab_design.d22_child_dcs | length) }} DCs"
      delegate_to: localhost

  when: is_adfr_inventory

# ============================================================================
# DSP mRemoteNG generation
# ============================================================================
- name: Generate DSP mRemoteNG (DSP inventory detected)
  block:
    - name: Build DSP lab_design from inventory
      set_fact:
        lab_design:
          dsp_infrastructure: "{{ (groups.get('dsp_infrastructure', []) + groups.get('dsp_linux', [])) | map('extract', hostvars, ['hostname', 'ansible_host', 'role']) | map('combine', {'ip': hostvars[item].ansible_host}) | list | sort(attribute='hostname') }}"
          d3_dcs: "{{ groups.get('d3_dcs', []) | map('extract', hostvars, ['hostname', 'ansible_host', 'dc_role']) | map('combine', {'ip': hostvars[item].ansible_host, 'role': hostvars[item].dc_role}) | list | sort(attribute='hostname') }}"
      delegate_to: localhost

    - name: Generate DSP mRemoteNG XML
      template:
        src: "{{ templates_dir }}/dsp-mremoteng.xml.j2"
        dest: "{{ files_dir }}/dsp-lab-mremoteng.xml"
        mode: '0644'
      delegate_to: localhost

    - name: Display DSP generation result
      debug:
        msg:
          - "Generated DSP mRemoteNG: {{ files_dir }}/dsp-lab-mremoteng.xml"
          - "  Infrastructure: {{ lab_design.dsp_infrastructure | length }} VMs"
          - "  D3.lab: {{ lab_design.d3_dcs | length }} DCs"
      delegate_to: localhost

  when: is_dsp_inventory