---
# Generate mRemoteNG configuration - unified for both ADFR and DSP
# Simply collects all VMs with 'role' and 'ip' attributes
# Template auto-groups by role

- name: Set project paths
  set_fact:
    project_root: "{{ playbook_dir | dirname }}"
    templates_dir: "{{ (playbook_dir | dirname) }}/templates"
    files_dir: "{{ (playbook_dir | dirname) }}/files"

- name: Ensure files directory exists
  file:
    path: "{{ files_dir }}"
    state: directory
    mode: '0755'

# ============================================================================
# Build unified VM list from ALL groups (works for ADFR or DSP)
# ============================================================================
- name: Collect all VMs across all groups
  set_fact:
    lab_design:
      all_vms: "{{ lab_design.all_vms | default([]) + [{'hostname': item, 'ip': hostvars[item].ansible_host, 'role': hostvars[item].role | default(hostvars[item].dc_role | default('Uncategorized'))}] }}"
  loop: "{{ groups.get('all', []) }}"

- name: Filter out localhost from VM list
  set_fact:
    lab_design:
      all_vms: "{{ lab_design.all_vms | rejectattr('hostname', 'equalto', 'localhost') | list | sort(attribute='hostname') }}"

- name: Debug VM collection
  debug:
    msg:
      - "Collected {{ lab_design.all_vms | length }} VMs"
      - "Roles found: {{ lab_design.all_vms | map(attribute='role') | unique | list | sort }}"

- name: Generate mRemoteNG XML
  template:
    src: "{{ templates_dir }}/mremoteng.xml.j2"
    dest: "{{ files_dir }}/semperis-lab-mremoteng.xml"
    mode: '0644'

- name: Verify XML file created
  stat:
    path: "{{ files_dir }}/semperis-lab-mremoteng.xml"
  register: xml_stat

- name: Display generation result
  debug:
    msg:
      - "âœ“ Generated mRemoteNG: semperis-lab-mremoteng.xml"
      - "  Total VMs: {{ lab_design.all_vms | length }}"
      - "  Roles: {{ lab_design.all_vms | map(attribute='role') | unique | list | sort | join(', ') }}"
      - "  File size: {{ xml_stat.stat.size }} bytes"