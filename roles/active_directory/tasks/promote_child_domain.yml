---
# Promote server to first DC in child domain
# FIX: Same approach as replica - promote without reboot, force replication to parent, verify secure channel BEFORE reboot

- name: Check if already promoted
  include_tasks: check_dc_status.yml

- name: Wait for parent domain to be reachable
  ansible.windows.win_shell: |
    $cred = New-Object System.Management.Automation.PSCredential("{{ parent_domain_netbios }}\Administrator", (ConvertTo-SecureString "{{ ad_safe_mode_password }}" -AsPlainText -Force))
    Get-ADDomain -Identity "{{ parent_domain }}" -Credential $cred -ErrorAction Stop | Out-Null
    Write-Output "Parent domain reachable"
  retries: 30
  delay: 10
  until: result.rc == 0
  register: result
  changed_when: false
  when: not is_domain_controller

- name: Promote to child domain PDC (no immediate reboot)
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $SecurePassword = ConvertTo-SecureString "{{ ad_safe_mode_password }}" -AsPlainText -Force
    $ParentCred = New-Object System.Management.Automation.PSCredential("{{ parent_domain_netbios }}\Administrator", $SecurePassword)

    Install-ADDSDomain `
      -NewDomainName "{{ domain_name.split('.')[0] }}" `
      -ParentDomainName "{{ parent_domain }}" `
      -SafeModeAdministratorPassword $SecurePassword `
      -Credential $ParentCred `
      -InstallDNS:${{ ad_install_dns | ternary('true', 'false') }} `
      -DatabasePath "{{ ad_database_path }}" `
      -SysvolPath "{{ ad_sysvol_path }}" `
      -LogPath "{{ ad_log_path }}" `
      -Force `
      -NoRebootOnCompletion:$true
  when: not is_domain_controller and not domain_exists
  register: child_promotion
  async: "{{ ad_promotion_timeout }}"
  poll: 30

- name: Wait for NTDS to stabilize after promotion
  ansible.windows.win_service:
    name: NTDS
    state: started
  register: ntds_service
  retries: 10
  delay: 10
  until: ntds_service is succeeded
  when: child_promotion.changed | default(false)

- name: Get parent PDC hostname for replication
  set_fact:
    parent_pdc_hostname: "{{ parent_pdc_host }}"
  when: child_promotion.changed | default(false)

- name: Force replication of new domain to parent (critical for trust chain)
  ansible.windows.win_shell: |
    $parent_pdc = "{{ parent_pdc_hostname }}"
    $domain_nc = "DC={{ domain_name.split('.')[0] }},{{ (Get-ADDomain -Identity '{{ parent_domain }}').DistinguishedName }}"
    $config_nc = (Get-ADRootDSE).configurationNamingContext

    # Wait for local AD to be queryable
    Start-Sleep -Seconds 5

    # Force inbound replication from parent (pull parent changes)
    repadmin /replicate localhost $parent_pdc $domain_nc 2>&1 | Out-String
    Start-Sleep -Seconds 3

    # Force outbound replication to parent (push new domain object up)
    repadmin /replicate $parent_pdc localhost $domain_nc 2>&1 | Out-String

    # Also replicate config
    repadmin /replicate $parent_pdc localhost $config_nc 2>&1 | Out-String

    Write-Output "Replication forced to parent"
  register: repl_force
  retries: 5
  delay: 10
  until: repl_force.rc == 0
  when: child_promotion.changed | default(false)

- name: Wait for secure channel to parent (before reboot)
  ansible.windows.win_shell: |
    $parent_pdc = "{{ parent_pdc_hostname }}"
    $maxRetries = 30
    $attempt = 0

    while ($attempt -lt $maxRetries) {
      try {
        Test-ComputerSecureChannel -Server $parent_pdc -ErrorAction Stop | Out-Null
        Write-Output "Secure channel established to parent $parent_pdc"
        exit 0
      } catch {
        $attempt++
        if ($attempt -lt $maxRetries) {
          Start-Sleep -Seconds 10
        }
      }
    }

    Write-Output "Failed to establish secure channel to parent after $maxRetries attempts"
    exit 1
  register: secure_channel_wait
  when: child_promotion.changed | default(false)
  failed_when: false

- name: Fail if secure channel to parent not established before reboot
  fail:
    msg: |
      Could not establish secure channel to parent domain before reboot.
      This would cause trust relationship issues.
      Run the rollback playbook and try again.
  when:
    - child_promotion.changed | default(false)
    - secure_channel_wait.rc != 0

- name: Now safe to reboot
  ansible.windows.win_reboot:
    reboot_timeout: "{{ ad_reboot_timeout }}"
    post_reboot_delay: 90
  when: child_promotion.changed | default(false)

- name: Wait for connection after reboot
  wait_for_connection:
    timeout: 300
    delay: 10
  when: child_promotion.changed | default(false)

- name: Verify child domain PDC is fully ready after promotion
  include_tasks: check_dc_status.yml
  when: child_promotion.changed | default(false)

- name: Display promotion result
  debug:
    msg:
      - "{{ inventory_hostname }} - Child Domain {{ 'promoted' if (child_promotion.changed | default(false)) else 'already exists' }}"
      - "  Domain: {{ domain_name }}"
      - "  Parent: {{ parent_domain }}"
      - "  NetBIOS: {{ netbios_name }}"