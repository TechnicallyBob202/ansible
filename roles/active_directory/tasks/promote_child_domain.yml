---
# Promote server to first DC in child domain (PDC) under an existing parent domain

# Require domain_name (e.g., D21.D2.lab)
- name: Assert required inputs
  assert:
    that:
      - domain_name is defined
      - (domain_name | length) > 0
    fail_msg: "domain_name must be set (e.g., D21.D2.lab)"
  changed_when: false

# Skip if already a DC
- name: Check if already a DC
  include_tasks: check_domain_status.yml

# Derive child/parent names if not provided
- name: Derive child_netbios from domain_name when missing
  set_fact:
    child_netbios: "{{ domain_name.split('.')[0] | upper }}"
  when: child_netbios is not defined
  changed_when: false

- name: Derive parent_domain (FQDN) from domain_name when missing
  set_fact:
    parent_domain: "{{ domain_name.split('.')[1:] | join('.') }}"
  when: parent_domain is not defined
  changed_when: false

- name: Derive parent_netbios from parent_domain when missing
  set_fact:
    parent_netbios: "{{ parent_domain.split('.')[0] | upper }}"
  when: parent_netbios is not defined
  changed_when: false

# 1) Ensure DNS is installed on the PARENT DC (delegate) - requires parent_pdc_host var
- name: Ensure DNS feature on parent PDC
  ansible.windows.win_feature:
    name: DNS
    state: present
    include_management_tools: true
  delegate_to: "{{ parent_pdc_host }}"
  when:
    - not is_domain_controller
    - not domain_exists
    - parent_pdc_host is defined
  changed_when: false

- name: Ensure DNS service started on parent PDC
  ansible.windows.win_service:
    name: DNS
    start_mode: auto
    state: started
  delegate_to: "{{ parent_pdc_host }}"
  when:
    - not is_domain_controller
    - not domain_exists
    - parent_pdc_host is defined
  changed_when: false

# 2) Install DNS on THIS CHILD PDC (pre-install is idempotent; ADDS can also install)
- name: Ensure DNS feature present on child PDC (pre-install)
  ansible.windows.win_feature:
    name: DNS
    state: present
    include_management_tools: true
  when:
    - not is_domain_controller
    - not domain_exists
  changed_when: false

# Switch to parent domain admin creds for promotion
- name: Switch to parent domain admin creds
  set_fact:
    ansible_user: "{{ parent_netbios }}\\Administrator"
    ansible_password: "{{ ansible_password }}"
  when: not is_domain_controller and not domain_exists
  changed_when: false

# Promote (no auto-reboot), then explicit reboot + waits
- name: Promote to child domain PDC (no auto-reboot)
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $Safe      = ConvertTo-SecureString "{{ ad_safe_mode_password }}" -AsPlainText -Force
    $ParentSec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
    $ParentCred = New-Object System.Management.Automation.PSCredential("{{ parent_netbios }}\Administrator", $ParentSec)

    Install-ADDSDomain `
      -NewDomainName "{{ child_netbios }}" `
      -ParentDomainName "{{ parent_domain }}" `
      -SafeModeAdministratorPassword $Safe `
      -Credential $ParentCred `
      -InstallDNS:${{ ad_install_dns | ternary('true','false') }} `
      -DatabasePath "{{ ad_database_path }}" `
      -SysvolPath "{{ ad_sysvol_path }}" `
      -LogPath "{{ ad_log_path }}" `
      -Force `
      -NoRebootOnCompletion:$true
  register: child_promo
  when: not is_domain_controller and not domain_exists

- name: Request reboot (tolerant)
  ansible.windows.win_reboot:
    reboot_timeout: "{{ ad_reboot_timeout | default(3600) }}"
    connect_timeout: 120
    post_reboot_delay: 60
  register: _rb
  failed_when: false
  when: not is_domain_controller and not domain_exists

- name: Force reboot if needed
  ansible.windows.win_shell: shutdown /r /t 0 /f
  when:
    - not is_domain_controller and not domain_exists
    - (_rb is failed) or (_rb is unreachable) or (not (_rb.rebooted | default(false)))
  ignore_errors: true

- name: Wait for WinRM to drop
  wait_for:
    host: "{{ ansible_host }}"
    port: 5985
    state: drained
    delay: 5
    timeout: 180
  delegate_to: localhost
  ignore_errors: true
  when: not is_domain_controller and not domain_exists

- name: Wait for connection after reboot
  wait_for_connection:
    timeout: "{{ ad_reboot_timeout | default(3600) }}"
    delay: 60

# 3) Validate DNS is installed on THIS CHILD PDC (service + zone)
- name: Ensure DNS service is running on child PDC
  ansible.windows.win_service:
    name: DNS
    start_mode: auto
    state: started

- name: Ensure child domain zone exists (AD-integrated)
  ansible.windows.win_shell: |
    $zone = Get-DnsServerZone -Name "{{ domain_name }}" -ErrorAction SilentlyContinue
    if (-not $zone) {
      Add-DnsServerPrimaryZone -Name "{{ domain_name }}" -ReplicationScope Domain -PassThru | Out-Null
    }
    exit 0
  register: _ensure_zone
  changed_when: false

# Readiness checks
- name: Wait for ADWS on child PDC
  ansible.windows.win_service:
    name: ADWS
    state: started
  register: child_adws
  retries: 10
  delay: 30
  until: child_adws.state == 'running'

- name: Verify child domain query on PDC
  ansible.windows.win_shell: |
    $d = Get-ADDomain -Identity "{{ domain_name }}" -ErrorAction Stop
    "$($d.DNSRoot)"
  register: child_domain_query
  retries: 10
  delay: 30
  until: child_domain_query.rc == 0
  changed_when: false