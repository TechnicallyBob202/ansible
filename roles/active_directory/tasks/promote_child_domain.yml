---
# Promote server to child domain PDC

- name: Check if already promoted
  include_tasks: check_domain_status.yml

- name: Promote to child domain PDC
  microsoft.ad.domain:
    dns_domain_name: "{{ domain_name }}"
    parent_domain_name: "{{ parent_domain }}"
    domain_admin_user: "{{ parent_domain_netbios }}\\Administrator"
    domain_admin_password: "{{ ad_safe_mode_password }}"
    safe_mode_password: "{{ ad_safe_mode_password }}"
    database_path: "{{ ad_database_path }}"
    sysvol_path: "{{ ad_sysvol_path }}"
    log_path: "{{ ad_log_path }}"
    install_dns: "{{ ad_install_dns }}"
    domain_mode: "{{ ad_functional_level }}"
    create_dns_delegation: false
    reboot: true
  when: not is_domain_controller
  register: child_promotion

- name: Wait for reboot to complete
  wait_for_connection:
    timeout: "{{ ad_reboot_timeout }}"
    delay: 60
  when: child_promotion.changed | default(false)

- name: Wait for Active Directory Web Services
  ansible.windows.win_service:
    name: ADWS
    state: started
  register: adws_service
  retries: 10
  delay: 30
  until: adws_service.state == 'running'
  when: child_promotion.changed | default(false)

- name: Display promotion result
  debug:
    msg:
      - "{{ inventory_hostname }} - Child Domain PDC {{ 'promoted' if child_promotion.changed else 'already exists' }}"
      - "  Domain: {{ domain_name }}"
      - "  Parent: {{ parent_domain }}"