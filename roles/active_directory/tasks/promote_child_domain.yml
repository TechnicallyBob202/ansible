---
# Promote server to first DC in child domain

- name: Check if already promoted
  include_tasks: check_domain_status.yml

- name: Promote to child domain PDC (no reboot; we reboot explicitly next)
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"

    # Single secret from Semaphore for both parent admin and DSRM (Safe Mode)
    $Plain = "{{ lookup('env','WINDOWS_PASSWORD') }}"
    if ([string]::IsNullOrEmpty($Plain)) { throw "WINDOWS_PASSWORD env var is empty or undefined" }
    $Secure = ConvertTo-SecureString $Plain -AsPlainText -Force

    # Always Administrator scoped to parent domain
    $ParentUser = "administrator@{{ parent_domain }}"
    $ParentCred = New-Object System.Management.Automation.PSCredential($ParentUser, $Secure)

    Install-ADDSDomain `
      -DomainType ChildDomain `
      -NewDomainName "{{ netbios_name }}" `
      -ParentDomainName "{{ parent_domain }}" `
      -SafeModeAdministratorPassword $Secure `
      -Credential $ParentCred `
      -InstallDNS:${{ ad_install_dns | ternary('true','false') }} `
      -CreateDNSDelegation:$true `
      -DnsDelegationCredential $ParentCred `
      -DatabasePath "{{ ad_database_path }}" `
      -SysvolPath "{{ ad_sysvol_path }}" `
      -LogPath "{{ ad_log_path }}" `
      -Force `
      -NoRebootOnCompletion:$true
  when: not is_domain_controller and not domain_exists
  register: child_promotion

- name: Reboot after child domain promotion
  ansible.windows.win_reboot:
    reboot_timeout: "{{ ad_reboot_timeout }}"
    post_reboot_delay: 60
  when:
    - child_promotion is defined
    - child_promotion.rc == 0

- name: Wait for Active Directory Web Services
  ansible.windows.win_service:
    name: ADWS
    state: started
  register: adws_service
  retries: 15
  delay: 30
  until: adws_service.state == 'running'
  when:
    - child_promotion is defined
    - child_promotion.rc == 0

- name: Get new domain SID
  ansible.windows.win_shell: |
    Start-Sleep -Seconds 30
    $domain = Get-ADDomain -Identity "{{ domain_name }}"
    Write-Output $domain.DomainSID.Value
  register: new_domain_sid
  retries: 5
  delay: 30
  until: new_domain_sid.rc == 0
  when:
    - child_promotion is defined
    - child_promotion.rc == 0

- name: Update domain SID fact
  set_fact:
    domain_sid: "{{ new_domain_sid.stdout | trim }}"
  when:
    - child_promotion is defined
    - child_promotion.rc == 0

- name: Save domain SID to localhost
  copy:
    content: "{{ domain_name }}={{ domain_sid }}\n"
    dest: "/tmp/domain-sid-{{ domain_name | replace('.', '-') }}.txt"
  delegate_to: localhost
  when:
    - child_promotion is defined
    - child_promotion.rc == 0

- name: Display promotion result
  debug:
    msg:
      - "{{ inventory_hostname }} - Child Domain {{ 'promoted' if (child_promotion.rc == 0) else 'already exists' }}"
      - "  Domain: {{ domain_name }}"
      - "  Parent: {{ parent_domain }}"
      - "  NetBIOS: {{ netbios_name }}"
      - "  SID: {{ domain_sid | default('N/A') }}"