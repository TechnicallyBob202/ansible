- name: Promote to child domain PDC
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"

    # Use the single secret from Semaphore for BOTH:
    #  - Parent domain admin credential (administrator@<parent_domain>)
    #  - DSRM (Safe Mode) password
    $Plain = "{{ lookup('env','WINDOWS_PASSWORD') }}"
    if ([string]::IsNullOrEmpty($Plain)) { throw "WINDOWS_PASSWORD env var is empty or undefined" }
    $Secure = ConvertTo-SecureString $Plain -AsPlainText -Force

    # Always use Administrator with the parent domain context
    $ParentUser = "administrator@{{ parent_domain }}"
    $ParentCred = New-Object System.Management.Automation.PSCredential($ParentUser, $Secure)

    Install-ADDSDomain `
      -NewDomainName "{{ netbios_name }}" `
      -ParentDomainName "{{ parent_domain }}" `
      -SafeModeAdministratorPassword $Secure `
      -Credential $ParentCred `
      -InstallDNS:$true `
      -CreateDNSDelegation:$true `
      -DnsDelegationCredential $ParentCred `
      -DatabasePath "{{ ad_database_path }}" `
      -SysvolPath "{{ ad_sysvol_path }}" `
      -LogPath "{{ ad_log_path }}" `
      -Force `
      -NoRebootOnCompletion:$false
  when: not is_domain_controller and not domain_exists
  register: child_promotion
  async: "{{ ad_promotion_timeout }}"
  poll: 30