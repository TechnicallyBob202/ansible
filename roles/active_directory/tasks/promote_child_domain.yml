---
# Promote server to first DC in child domain
# Includes parent domain verification, promotion, and DNS zone creation post-promo

- name: Check if already promoted
  include_tasks: check_dc_status.yml

- name: Configure DNS to point to parent DCs for promotion
  block:
    - name: Set DNS to parent domain controllers
      ansible.windows.win_dns_client:
        adapter_names: '*'
        dns_servers:
          - "{{ hostvars[groups['root_pdcs'][0]]['ansible_host'] }}"
          - "{{ hostvars[groups['root_replicas'][0]]['ansible_host'] }}"
      register: dns_promo_config

    - name: Wait for DNS changes to take effect
      ansible.windows.win_shell: |
        Start-Sleep -Seconds 5
        $dns = Get-DnsClientServerAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"}
        Write-Output "DNS Servers: $($dns.ServerAddresses -join ', ')"
      changed_when: false

    - name: Display pre-promotion DNS configuration
      debug:
        msg: "DNS configured to parent DCs for promotion: {{ hostvars[groups['root_pdcs'][0]]['ansible_host'] }}, {{ hostvars[groups['root_replicas'][0]]['ansible_host'] }}"
  when: not is_domain_controller

- name: Verify parent domain is accessible
  include_tasks: check_parent_domain.yml
  when: not is_domain_controller

- name: Promote to child domain PDC
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $SecurePassword = ConvertTo-SecureString "{{ ad_safe_mode_password }}" -AsPlainText -Force
    $ParentCred = New-Object System.Management.Automation.PSCredential("{{ parent_domain_netbios }}\Administrator", $SecurePassword)

    Install-ADDSDomain `
      -NewDomainName "{{ domain_name.split('.')[0] }}" `
      -ParentDomainName "{{ parent_domain }}" `
      -SafeModeAdministratorPassword $SecurePassword `
      -Credential $ParentCred `
      -InstallDNS:${{ ad_install_dns | ternary('true', 'false') }} `
      -DatabasePath "{{ ad_database_path }}" `
      -SysvolPath "{{ ad_sysvol_path }}" `
      -LogPath "{{ ad_log_path }}" `
      -Force `
      -NoRebootOnCompletion:$false
  when: not is_domain_controller
  register: child_promotion
  async: "{{ ad_promotion_timeout }}"
  poll: 30
  changed_when: "'was successful' in child_promotion.stdout or child_promotion.rc == 0"

- name: Wait for reboot to complete after promotion
  wait_for_connection:
    timeout: "{{ ad_reboot_timeout }}"
    delay: 60
  when: child_promotion.changed | default(false)

- name: Verify DC is fully ready after promotion
  include_tasks: check_dc_status.yml
  when: child_promotion.changed | default(false)

- name: Configure DNS to point to child DCs after promotion
  block:
    - name: Set DNS to child domain controllers
      ansible.windows.win_dns_client:
        adapter_names: '*'
        dns_servers: "{{ dns_servers }}"
      register: dns_post_config

    - name: Wait for DNS changes to take effect
      ansible.windows.win_shell: |
        Start-Sleep -Seconds 5
        $dns = Get-DnsClientServerAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"}
        Write-Output "DNS Servers: $($dns.ServerAddresses -join ', ')"
      changed_when: false

    - name: Display post-promotion DNS configuration
      debug:
        msg: "DNS reconfigured to child DCs after promotion: {{ dns_servers | join(', ') }}"
  when: child_promotion.changed | default(false)

- name: Setup DNS zone for child domain
  include_tasks: setup_child_dns_zone.yml
  when: child_promotion.changed | default(false)

- name: Verify child domain was created successfully
  ansible.windows.win_shell: |
    try {
      $domain = Get-ADDomain -Identity "{{ domain_name }}" -ErrorAction Stop
      Write-Output "Domain: $($domain.DNSRoot)"
      Write-Output "NetBIOS: $($domain.NetBIOSName)"
      Write-Output "Parent: $($domain.ParentDomain)"
      Write-Output "Domain Mode: $($domain.DomainMode)"
      exit 0
    } catch {
      Write-Output "ERROR: Cannot query domain - $_"
      exit 1
    }
  retries: 10
  delay: 30
  until: domain_verify.rc == 0
  register: domain_verify
  changed_when: false
  when: child_promotion.changed | default(false)

- name: Verify trust relationship with parent domain
  ansible.windows.win_shell: |
    try {
      $trust = Get-ADTrust -Identity "{{ parent_domain }}" -ErrorAction Stop
      Write-Output "Trust relationship verified with {{ parent_domain }}"
      Write-Output "Trust Type: $($trust.TrustType)"
      Write-Output "Trust Direction: $($trust.TrustDirection)"
      exit 0
    } catch {
      Write-Output "WARNING: Cannot verify trust - $_"
      exit 0
    }
  register: trust_verify
  changed_when: false
  when: child_promotion.changed | default(false)

- name: Create DNS delegation in parent domain
  include_tasks: create_dns_delegation.yml
  vars:
    delegation_exists: false
  when: child_promotion.changed | default(false)

- name: Display child domain PDC promotion result
  debug:
    msg:
      - "{{ inventory_hostname }} - Child Domain PDC {{ 'promoted' if child_promotion.changed else 'already exists' }}"
      - "  Domain: {{ domain_name }}"
      - "  Parent: {{ parent_domain }}"
      - "  NetBIOS: {{ domain_netbios }}"
      - "  DNS Zone: created and configured"
      - "  Forwarders: configured to parent"
      - "  Delegation: {{ 'created' if child_promotion.changed else 'already exists' }}"