---
# Promote server to child domain PDC

- name: Check if already promoted
  include_tasks: check_domain_status.yml

- name: Promote to child domain PDC
  ansible.windows.win_shell: |
    $safeModePassword = ConvertTo-SecureString "{{ ad_safe_mode_password }}" -AsPlainText -Force
    $parentCred = New-Object System.Management.Automation.PSCredential("{{ parent_domain_netbios }}\Administrator", (ConvertTo-SecureString "{{ ad_safe_mode_password }}" -AsPlainText -Force))

    Install-ADDSDomain -NewDomainName "{{ domain_name.split('.')[0] }}" -ParentDomainName "{{ parent_domain }}" -DomainType ChildDomain -InstallDns -DatabasePath "{{ ad_database_path }}" -SysvolPath "{{ ad_sysvol_path }}" -LogPath "{{ ad_log_path }}" -SafeModeAdministratorPassword $safeModePassword -Credential $parentCred -Force
  when: not is_domain_controller
  register: child_promotion

- name: Wait for reboot to complete
  wait_for_connection:
    timeout: "{{ ad_reboot_timeout }}"
    delay: 60
  when: child_promotion.rc == 0

- name: Wait for Active Directory Web Services
  ansible.windows.win_service:
    name: ADWS
    state: started
  register: adws_service
  retries: 10
  delay: 30
  until: adws_service.state == 'running'
  when: child_promotion.rc == 0

- name: Create AD-integrated DNS zone
  ansible.windows.win_shell: |
    $zone = Get-DnsServerZone -Name "{{ domain_name }}" -ErrorAction SilentlyContinue
    if ($zone) {
      Write-Output "Zone already exists"
      exit 0
    }

    Add-DnsServerPrimaryZone -Name "{{ domain_name }}" -ReplicationScope Domain
    Write-Output "Zone created"
  when: child_promotion.rc == 0
  register: zone_result

- name: Display promotion result
  debug:
    msg:
      - "{{ inventory_hostname }} - Child Domain PDC promoted"
      - "  Domain: {{ domain_name }}"
      - "  Parent: {{ parent_domain }}"
      - "  DNS Zone: {{ 'created' if 'created' in zone_result.stdout else 'exists' }}"