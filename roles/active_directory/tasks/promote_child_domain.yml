---
# Promote a server to CHILD domain PDC under an existing parent domain (synchronous)

# 1) Skip if already a DC
- name: Check if already a DC
  include_tasks: check_domain_status.yml

# 2) Use parent domain admin creds on the child PDC candidate
#    Assumes youâ€™ve set parent_fqdn (e.g., D2.lab), parent_netbios (e.g., D2), child_netbios (e.g., D21)
- name: Switch to parent domain admin creds
  set_fact:
    ansible_user: "{{ parent_netbios }}\\Administrator"
    ansible_password: "{{ ansible_password }}"
  when: not is_domain_controller
  changed_when: false

# 3) Ensure DNS points to the parent PDC (facts persisted earlier by check_domain_status)
- name: Select parent PDC IP from persisted facts
  set_fact:
    dns_primary: "{{ hostvars['localhost']['pdc_' + (parent_netbios | lower) + '_ip'] | default(hostvars['localhost']['forest_pdc_ip'] | default('')) }}"
    dns_secondary: ""
  when: not is_domain_controller
  changed_when: false

- name: Apply DNS settings (parent PDC as resolver)
  include_role:
    name: active_directory
    tasks_from: set_dns.yml
  when: not is_domain_controller

# 4) Promote to child domain (NO auto-reboot here)
- name: Promote to child domain PDC (no auto-reboot)
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $Safe      = ConvertTo-SecureString "{{ ad_safe_mode_password }}" -AsPlainText -Force
    $ParentSec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
    $ParentCred = New-Object System.Management.Automation.PSCredential("{{ parent_netbios }}\Administrator", $ParentSec)

    Install-ADDSDomain `
      -NewDomainName "{{ child_netbios }}" `
      -ParentDomainName "{{ parent_fqdn }}" `
      -SafeModeAdministratorPassword $Safe `
      -Credential $ParentCred `
      -InstallDNS:$true `
      -DatabasePath "{{ ad_database_path }}" `
      -SysvolPath "{{ ad_sysvol_path }}" `
      -LogPath "{{ ad_log_path }}" `
      -Force `
      -NoRebootOnCompletion:$true
  register: child_promo
  when: not is_domain_controller

- name: Child domain promotion summary
  debug:
    msg: "Child domain promotion invoked (no reboot yet): host={{ inventory_hostname }} parent={{ parent_fqdn }} child_netbios={{ child_netbios }}"
  when: not is_domain_controller

# 5) Reboot and wait for WinRM to come back
- name: Reboot after child domain promotion
  ansible.windows.win_reboot:
    reboot_timeout: "{{ ad_reboot_timeout | default(3600) }}"
  when: not is_domain_controller

- name: Wait for ADWS on child PDC
  ansible.windows.win_service:
    name: ADWS
    state: started
  register: child_adws
  retries: 10
  delay: 30
  until: child_adws.state == 'running'
  when: not is_domain_controller

# 6) Verify the child domain is queryable
- name: Verify child domain query on PDC
  ansible.windows.win_shell: |
    $d = Get-ADDomain -Identity "{{ child_netbios }}.{{ parent_fqdn }}" -ErrorAction Stop
    "$($d.DNSRoot)"
  register: child_domain_query
  retries: 10
  delay: 30
  until: child_domain_query.rc == 0
  changed_when: false
  when: not is_domain_controller

- name: Promotion complete
  debug:
    msg: "Child domain PDC promotion complete: host={{ inventory_hostname }} domain={{ child_netbios }}.{{ parent_fqdn }}"
  when: not is_domain_controller