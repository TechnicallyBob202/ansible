---
# Promote server to first DC in child domain

- name: Check if already promoted
  include_tasks: check_dc_status.yml

- name: Verify parent domain is accessible
  include_tasks: check_parent_domain.yml
  when: not is_domain_controller

- name: Promote to child domain PDC
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $SecurePassword = ConvertTo-SecureString "{{ ad_safe_mode_password }}" -AsPlainText -Force
    $ParentCred = New-Object System.Management.Automation.PSCredential("{{ parent_domain_netbios }}\Administrator", $SecurePassword)

    Install-ADDSDomain `
      -NewDomainName "{{ domain_name.split('.')[0] }}" `
      -ParentDomainName "{{ parent_domain }}" `
      -SafeModeAdministratorPassword $SecurePassword `
      -Credential $ParentCred `
      -InstallDNS:${{ ad_install_dns | ternary('true', 'false') }} `
      -DatabasePath "{{ ad_database_path }}" `
      -SysvolPath "{{ ad_sysvol_path }}" `
      -LogPath "{{ ad_log_path }}" `
      -Force `
      -NoRebootOnCompletion:$false
  when: not is_domain_controller and not domain_exists
  register: child_promotion
  async: "{{ ad_promotion_timeout }}"
  poll: 30

- name: Wait for reboot to complete
  wait_for_connection:
    timeout: "{{ ad_reboot_timeout }}"
    delay: 60
  when: forest_promotion.changed | default(false)

- name: Verify DC is fully ready after promotion
  include_tasks: check_dc_status.yml
  when: forest_promotion.changed | default(false)

- name: Display promotion result
  debug:
    msg:
      - "{{ inventory_hostname }} - Child Domain {{ 'promoted' if child_promotion.changed else 'already exists' }}"
      - "  Domain: {{ domain_name }}"
      - "  Parent: {{ parent_domain }}"
      - "  NetBIOS: {{ netbios_name }}"
      - "  SID: {{ domain_sid }}"