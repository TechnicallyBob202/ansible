---
# Promote server to replica domain controller in existing domain

- name: Check if already a DC
  include_tasks: check_domain_status.yml

- name: Promote to replica DC
  microsoft.ad.domain_controller:
    dns_domain_name: "{{ domain_name }}"
    domain_admin_user: "{{ netbios_name }}\\Administrator"
    domain_admin_password: "{{ ad_safe_mode_password }}"
    safe_mode_password: "{{ ad_safe_mode_password }}"
    database_path: "{{ ad_database_path }}"
    sysvol_path: "{{ ad_sysvol_path }}"
    domain_log_path: "{{ ad_log_path }}"
    install_dns: "{{ ad_install_dns }}"
    state: domain_controller
    reboot: yes
  when: not is_domain_controller
  register: replica_promotion
  timeout: 1200

- name: Wait for replica to reboot and come back
  wait_for_connection:
    timeout: "{{ ad_reboot_timeout }}"
    delay: 60
  when: replica_promotion.changed

- name: Wait for DC to be fully ready
  include_tasks: wait_for_dc_ready.yml
  when: replica_promotion.changed

- name: Force initial replication after promotion
  ansible.windows.win_shell: |
    $domain = "{{ domain_name }}"
    $nc = "DC=$($domain -replace '\.',',DC=')"
    repadmin /replicate $env:COMPUTERNAME $env:COMPUTERNAME $nc /force
    Start-Sleep -Seconds 5
    repadmin /showrepl
  when: replica_promotion.changed
  changed_when: false
  register: repl_force

- name: Display promotion result
  debug:
    msg:
      - "{{ inventory_hostname }} - Replica DC {{ 'promoted' if replica_promotion.changed else 'already exists' }}"
      - "  Domain: {{ domain_name }}"
      - "  Replication: {{ 'forced' if replica_promotion.changed else 'already running' }}"