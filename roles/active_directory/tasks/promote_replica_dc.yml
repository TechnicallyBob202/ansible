---
# Promote server to replica domain controller in existing domain

- name: Check if already a DC
  include_tasks: check_domain_status.yml

# Retry until the PDC emulator is discoverable (handles promotion/replication lag)
- name: Discover current PDC emulator (retry)
  ansible.windows.win_shell: |
    $ErrorActionPreference = 'SilentlyContinue'
    $dc = Get-ADDomainController -Discover -Service "PrimaryDC"
    if ($dc) { $dc.HostName } else { exit 1 }
  register: pdc_query
  retries: 20
  delay: 15
  until: pdc_query.rc == 0
  changed_when: false

- name: Set PDC hostname fact
  set_fact:
    pdc_hostname: "{{ pdc_query.stdout | trim }}"
  changed_when: false

# Optional: ensure DNS for PDC resolves before proceeding
- name: Wait until PDC hostname resolves
  ansible.windows.win_shell: |
    $name = "{{ pdc_hostname }}"
    try {
      [System.Net.Dns]::GetHostAddresses($name) | Out-Null
      exit 0
    } catch { exit 1 }
  register: pdc_dns
  retries: 10
  delay: 6
  until: pdc_dns.rc == 0
  changed_when: false

- name: Wait for PDC to be fully operational
  ansible.windows.win_shell: |
    Test-ComputerSecureChannel -Server {{ pdc_hostname }} -ErrorAction Stop
    Write-Output "OK"
  register: pdc_test
  retries: 20
  delay: 30
  until: pdc_test.rc == 0
  failed_when: false
  when: not is_domain_controller

- name: Promote to replica DC
  microsoft.ad.domain_controller:
    dns_domain_name: "{{ domain_name }}"
    domain_admin_user: "{{ netbios_name }}\\Administrator"
    domain_admin_password: "{{ ad_safe_mode_password }}"
    safe_mode_password: "{{ ad_safe_mode_password }}"
    database_path: "{{ ad_database_path }}"
    sysvol_path: "{{ ad_sysvol_path }}"
    log_path: "{{ ad_log_path }}"
    install_dns: "{{ ad_install_dns }}"
    state: domain_controller
    reboot: yes
  when: not is_domain_controller
  register: replica_promotion
  async: "{{ ad_promotion_timeout }}"
  poll: 30

- name: Wait for replica to reboot and come back
  wait_for_connection:
    timeout: "{{ ad_reboot_timeout }}"
    delay: 60
  when: replica_promotion.changed

- name: Wait for Active Directory Web Services
  ansible.windows.win_service:
    name: ADWS
    state: started
  register: adws_service
  retries: 10
  delay: 30
  until: adws_service.state == 'running'
  when: replica_promotion.changed

- name: Display promotion result
  debug:
    msg:
      - "{{ inventory_hostname }} - Replica DC {{ 'promoted' if replica_promotion.changed else 'already exists' }}"
      - "  Domain: {{ domain_name }}"
