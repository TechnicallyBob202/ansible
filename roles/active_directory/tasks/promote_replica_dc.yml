---
# Promote server to replica domain controller using steady-state DNS from inventory

- name: Check if already a DC
  include_tasks: check_domain_status.yml

- name: Switch to domain admin creds for replica tasks
  set_fact:
    ansible_user: "{{ netbios_name }}\\Administrator"
    ansible_password: "{{ ansible_password }}"
  when: not is_domain_controller
  changed_when: false

# 1) Ensure DNS is installed on the DOMAIN PDC (delegate) - requires domain_pdc_host var
- name: Ensure DNS feature on domain PDC
  ansible.windows.win_feature:
    name: DNS
    state: present
    include_management_tools: true
  delegate_to: "{{ domain_pdc_host }}"
  when:
    - not is_domain_controller
    - domain_pdc_host is defined
  changed_when: false

- name: Ensure DNS service started on domain PDC
  ansible.windows.win_service:
    name: DNS
    start_mode: auto
    state: started
  delegate_to: "{{ domain_pdc_host }}"
  when:
    - not is_domain_controller
    - domain_pdc_host is defined
  changed_when: false

# 2) Install DNS on THIS replica (module can do it, but we also validate after)
- name: Promote to replica DC
  microsoft.ad.domain_controller:
    dns_domain_name: "{{ domain_name }}"
    domain_admin_user: "{{ netbios_name }}\\Administrator"
    domain_admin_password: "{{ ansible_password }}"
    safe_mode_password: "{{ ad_safe_mode_password }}"
    database_path: "{{ ad_database_path }}"
    sysvol_path: "{{ ad_sysvol_path }}"
    domain_log_path: "{{ ad_log_path }}"
    install_dns: "{{ ad_install_dns }}"
    state: domain_controller
    reboot: yes
  when: not is_domain_controller
  register: replica_promotion
  poll: 30

- name: Wait for replica to reboot and come back
  wait_for_connection:
    timeout: "{{ ad_reboot_timeout }}"
    delay: 60
  when: replica_promotion.changed

# 3) Validate DNS is installed on THIS replica (service + zone)
- name: Ensure DNS service is running on replica
  ansible.windows.win_service:
    name: DNS
    start_mode: auto
    state: started
  when: ad_install_dns | default(true)

- name: Ensure domain zone exists on replica (AD-integrated)
  ansible.windows.win_shell: |
    $zone = Get-DnsServerZone -Name "{{ domain_name }}" -ErrorAction SilentlyContinue
    if (-not $zone) {
      Add-DnsServerPrimaryZone -Name "{{ domain_name }}" -ReplicationScope Domain -PassThru | Out-Null
    }
    exit 0
  register: _ensure_zone_replica
  changed_when: false
  when: ad_install_dns | default(true)

# Readiness checks
- name: Wait for ADWS on replica
  ansible.windows.win_service:
    name: ADWS
    state: started
  register: adws_service
  retries: 10
  delay: 30
  until: adws_service.state == 'running'
  when: replica_promotion.changed

- name: Wait for Netlogon on replica
  ansible.windows.win_service:
    name: Netlogon
    state: started
  register: netlogon_service
  retries: 10
  delay: 30
  until: netlogon_service.state == 'running'
  when: replica_promotion.changed

- name: Wait for DNS Server on replica
  ansible.windows.win_service:
    name: DNS
    state: started
  register: dns_service
  retries: 10
  delay: 30
  until: dns_service.state == 'running'
  when:
    - replica_promotion.changed
    - ad_install_dns | default(true)

- name: Short settle pause before AD cmdlets
  pause:
    seconds: 20
  when: replica_promotion.changed
  changed_when: false

- name: Verify domain query on replica
  ansible.windows.win_shell: |
    $domain = Get-ADDomain -Identity "{{ domain_name }}" -ErrorAction Stop
    "$($domain.DNSRoot)"
  register: domain_query
  retries: 10
  delay: 30
  until: domain_query.rc == 0
  changed_when: false
  when: replica_promotion.changed