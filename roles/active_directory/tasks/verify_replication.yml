---
# Verify Active Directory replication is healthy
# Simplified to avoid false positives right after promotion

- name: Get replication status
  ansible.windows.win_shell: |
    # Check 1: Is NTDS running? (if DC)
    $ntds = Get-Service NTDS -ErrorAction SilentlyContinue
    if (-not $ntds) {
      Write-Output "NOT_A_DC"
      exit 1
    }

    # Check 2: Get partner count and error count
    $partners = @()
    try {
      # Method 1: Get-ADReplicationPartnerMetadata (works reliably)
      $partners = Get-ADReplicationPartnerMetadata -Target $env:COMPUTERNAME -Scope Server -ErrorAction SilentlyContinue
    } catch {
      # Fallback: just check if domain is queryable
    }

    $failedCount = ($partners | Where-Object { $_.LastReplicationResult -ne 0 } | Measure-Object).Count
    $partnerCount = ($partners | Measure-Object).Count

    [PSCustomObject]@{
      Status = if ($failedCount -gt 0) { "FAILED" } else { "OK" }
      PartnerCount = $partnerCount
      FailedCount = $failedCount
    } | ConvertTo-Json
  register: repl_status
  retries: 3
  delay: 30
  until: (repl_status.stdout | from_json).Status in ["OK", "FAILED"]
  changed_when: false
  failed_when: false

- name: Parse replication status
  set_fact:
    replication_info: "{{ repl_status.stdout | from_json }}"
  when: repl_status.stdout | length > 0

- name: Display replication status
  debug:
    msg:
      - "{{ inventory_hostname }} - Replication Status: {{ replication_info.Status | default('UNKNOWN') }}"
      - "  Partners: {{ replication_info.PartnerCount | default(0) }}"
      - "  Failed: {{ replication_info.FailedCount | default(0) }}"
  when: replication_info is defined

- name: Fail if replication has critical failures
  fail:
    msg: "Replication failures detected on {{ inventory_hostname }} ({{ replication_info.FailedCount }} failed partners)"
  when:
    - replication_info is defined
    - replication_info.FailedCount | int > 0