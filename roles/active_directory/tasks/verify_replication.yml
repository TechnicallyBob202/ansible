---
# Verify Active Directory replication is healthy

- name: Get replication status
  ansible.windows.win_shell: |
    # Get ALL replication partners (inbound and outbound)
    $allPartners = @()

    # Method 1: Get-ADReplicationPartnerMetadata (outbound partners)
    try {
      $outbound = Get-ADReplicationPartnerMetadata -Target $env:COMPUTERNAME -Scope Server -ErrorAction SilentlyContinue
      $allPartners += $outbound
    } catch {}

    # Method 2: Also check repadmin for inbound partners
    try {
      $repadminOutput = repadmin /showrepl | Out-String
      # Count unique INBOUND NEIGHBORS sections
      $inboundMatches = [regex]::Matches($repadminOutput, "Default-First-Site-Name\\(\w+-DC\d+) via RPC")
      $inboundPartners = $inboundMatches | ForEach-Object { $_.Groups[1].Value } | Sort-Object -Unique
      $inboundCount = ($inboundPartners | Measure-Object).Count
    } catch {
      $inboundCount = 0
    }

    # Calculate total unique partners
    $outboundCount = ($allPartners | Measure-Object).Count
    $totalPartners = [Math]::Max($outboundCount, $inboundCount)

    # Check for failures
    $failures = $allPartners | Where-Object { $_.LastReplicationResult -ne 0 }
    $failureCount = ($failures | Measure-Object).Count

    # Determine status
    if ($failureCount -gt 0) {
      $status = "FAILED"
    } elseif ($totalPartners -eq 0) {
      # No partners might mean single DC or just promoted - check domain role
      $dcList = nltest /dclist:$env:USERDNSDOMAIN 2>&1 | Out-String
      $dcCount = ([regex]::Matches($dcList, "\[DS\]")).Count
      if ($dcCount -gt 1) {
        $status = "WARNING"  # Multiple DCs but no replication partners detected
      } else {
        $status = "OK"  # Single DC, no partners expected
      }
      $totalPartners = $dcCount - 1  # Expected partners = total DCs - self
    } else {
      $status = "OK"
    }

    [PSCustomObject]@{
      Status = $status
      FailureCount = $failureCount
      PartnerCount = $totalPartners
      OutboundPartners = $outboundCount
      InboundPartners = $inboundCount
    } | ConvertTo-Json
  register: repl_status
  retries: "{{ ad_replication_check_retries | default(3) }}"
  delay: "{{ ad_replication_check_delay | default(30) }}"
  until: (repl_status.stdout | from_json).Status in ["OK", "WARNING"]
  changed_when: false
  failed_when: false

- name: Parse replication status
  set_fact:
    replication_info: "{{ repl_status.stdout | from_json }}"

- name: Display replication status
  debug:
    msg:
      - "Replication Status for {{ inventory_hostname }}: {{ replication_info.Status }}"
      - "  Total Partners: {{ replication_info.PartnerCount | default(0) }}"
      - "  Inbound Partners: {{ replication_info.InboundPartners | default(0) }}"
      - "  Outbound Partners: {{ replication_info.OutboundPartners | default(0) }}"
      - "  Failures: {{ replication_info.FailureCount }}"

- name: Fail if replication has errors
  fail:
    msg: "Replication failures detected on {{ inventory_hostname }}"
  when: replication_info.Status == "FAILED"