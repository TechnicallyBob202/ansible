---
# Apply NIC DNS servers idempotently.
# Accepts either:
#   - dns_servers: [list]
#   - or dns_primary (+ optional dns_secondary)

- name: Build desired DNS list
  set_fact:
    _desired_dns: >-
      {{
        (dns_servers | default([]))
        if (dns_servers is defined)
        else (
          [dns_primary] +
          (([dns_secondary] if (dns_secondary | default('') | length > 0) else []))
        )
      }}
  changed_when: false

- name: Assert desired DNS list is non-empty
  assert:
    that:
      - _desired_dns | length > 0
    fail_msg: "No DNS servers specified for {{ inventory_hostname }}"
  changed_when: false

# 1) Read current DNS to a raw var; never fail
- name: Read current IPv4 DNS server list (first NIC)
  ansible.windows.win_shell: |
    try {
      $nic = Get-DnsClientServerAddress -AddressFamily IPv4 |
             Where-Object { $_.ServerAddresses -ne $null } |
             Select-Object -First 1
      if ($nic -and $nic.ServerAddresses) {
        ($nic.ServerAddresses -join ',')
      } else {
        ""
      }
      exit 0
    } catch {
      ""
      exit 0
    }
  register: _dns_now_raw
  changed_when: false

# 2) Ensure we always have a string
- name: Initialize _dns_now_str
  set_fact:
    _dns_now_str: ""
  changed_when: false

- name: Set _dns_now_str from command output if present
  set_fact:
    _dns_now_str: "{{ _dns_now_raw.stdout }}"
  when: (_dns_now_raw is defined) and (_dns_now_raw.stdout is defined)
  changed_when: false

# 3) Normalize to a list
- name: Initialize _current_dns as empty list
  set_fact:
    _current_dns: []
  changed_when: false

- name: Parse current DNS list when string is non-empty
  set_fact:
    _current_dns: "{{ (_dns_now_str | string).split(',') | map('trim') | reject('equalto','') | list }}"
  when: (_dns_now_str is defined) and (_dns_now_str | string | length > 0)
  changed_when: false

# 4) Compare desired vs current
- name: Decide if DNS needs update (order matters)
  set_fact:
    _dns_needs_change: "{{ _current_dns != _desired_dns }}"
  changed_when: false

# 5) Apply only if different
- name: Apply DNS servers on primary IPv4 interface (only if different)
  ansible.windows.win_shell: |
    $servers = "{{ _desired_dns | join(',') }}"
    $nic = Get-DnsClientServerAddress -AddressFamily IPv4 |
           Where-Object { $_.ServerAddresses -ne $null } |
           Select-Object -First 1
    if (-not $nic) { throw "No IPv4 DNS-capable NIC found" }
    Set-DnsClientServerAddress -InterfaceIndex $nic.InterfaceIndex -ServerAddresses ($servers -split ',')
  when: _dns_needs_change

- name: DNS setting summary
  debug:
    msg: "DNS on {{ inventory_hostname }} is now {{ _desired_dns }} (changed={{ _dns_needs_change }})"