---
# Create OUs if they don't already exist
# This ensures we have the proper OU structure for placing objects

- name: Get domain DN
  ansible.windows.win_shell: |
    (Get-ADDomain).DistinguishedName
  register: domain_dn_result
  changed_when: false

- name: Set domain DN fact
  set_fact:
    domain_dn: "{{ domain_dn_result.stdout | trim }}"

- name: Define OU structure
  set_fact:
    ou_structure:
      - name: Users
        path: "{{ domain_dn }}"
        description: "User accounts"
      - name: Standard Users
        path: "OU=Users,{{ domain_dn }}"
        description: "Regular user accounts"
      - name: Service Accounts
        path: "OU=Users,{{ domain_dn }}"
        description: "Service accounts"
      - name: Admin Accounts
        path: "OU=Users,{{ domain_dn }}"
        description: "Administrative accounts"
      - name: Groups
        path: "{{ domain_dn }}"
        description: "Security and distribution groups"
      - name: Security Groups
        path: "OU=Groups,{{ domain_dn }}"
        description: "Security groups"
      - name: Distribution Groups
        path: "OU=Groups,{{ domain_dn }}"
        description: "Distribution lists"
      - name: Computers
        path: "{{ domain_dn }}"
        description: "Computer accounts"
      - name: Workstations
        path: "OU=Computers,{{ domain_dn }}"
        description: "Desktop and laptop computers"
      - name: Servers
        path: "OU=Computers,{{ domain_dn }}"
        description: "Server computers"

- name: Create OUs
  ansible.windows.win_shell: |
    $ouName = "{{ item.name }}"
    $ouPath = "{{ item.path }}"
    $ouDescription = "{{ item.description }}"
    $ouDN = "OU=$ouName,$ouPath"

    try {
      Get-ADOrganizationalUnit -Identity $ouDN -ErrorAction Stop | Out-Null
      Write-Output "EXISTS"
    } catch {
      New-ADOrganizationalUnit -Name $ouName -Path $ouPath -Description $ouDescription -ProtectedFromAccidentalDeletion $true
      Write-Output "CREATED"
    }
  loop: "{{ ou_structure }}"
  register: ou_creation
  changed_when: "'CREATED' in ou_creation.stdout"

- name: Display OU creation results
  debug:
    msg: "OU {{ item.item.name }} - {{ 'created' if 'CREATED' in item.stdout else 'already exists' }}"
  loop: "{{ ou_creation.results }}"
  loop_control:
    label: "{{ item.item.name }}"