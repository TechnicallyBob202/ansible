---
# Stage ADFR installation files from SMB share to local directory

- name: Create local Semperis directory
  ansible.windows.win_file:
    path: "{{ adfr_local_path }}"
    state: directory

- name: Copy ADFR files using robocopy
  ansible.windows.win_shell: |
    Write-Host "Starting copy from {{ adfr_smb_source }}..."
    $result = robocopy "{{ adfr_smb_source }}" "{{ adfr_local_path }}" /E /MT:8
    Write-Host "Robocopy exit code: $LASTEXITCODE"
    if ($LASTEXITCODE -lt 8) {
      Write-Host "Copy completed successfully"
      exit 0
    } else {
      Write-Host "Copy failed with exit code $LASTEXITCODE"
      exit $LASTEXITCODE
    }
  register: adfr_copy_result
  changed_when: adfr_copy_result.rc == 0
  async: 600
  poll: 10

- name: Display copy result
  debug:
    msg:
      - "{{ inventory_hostname }} - ADFR files copied"
      - "  Output: {{ adfr_copy_result.stdout }}"