# roles/semperis_adfr/tasks/stage_adfr_install.yml
---
- name: Create local Semperis directory
  ansible.windows.win_file:
    path: "{{ adfr_local_path }}"
    state: directory

- name: Copy ADFR files from SMB share (mirror)
  ansible.windows.win_shell: |
    # Authenticate to SMB share
    $username = "{{ adfr_smb_username }}"
    $password = ConvertTo-SecureString "{{ adfr_smb_password }}" -AsPlainText -Force
    $credential = New-Object System.Management.Automation.PSCredential($username, $password)

    # Map drive
    $driveLetter = "Z"
    $shareRoot = "\\192.168.33.13\Semperis"

    if (Get-PSDrive -Name $driveLetter -ErrorAction SilentlyContinue) {
      Remove-PSDrive -Name $driveLetter -Force
    }

    New-PSDrive -Name $driveLetter -PSProvider FileSystem -Root $shareRoot -Credential $credential -Persist -ErrorAction Stop | Out-Null

    # Mirror files
    $dest = "{{ adfr_local_path }}"
    robocopy "${driveLetter}:\ADFR" "$dest" /MIR /NFL /NDL /NJH /NJS /nc /ns /np

    # Cleanup
    Remove-PSDrive -Name $driveLetter -Force -ErrorAction SilentlyContinue

    # Robocopy exit codes 0-7 are success
    if ($LASTEXITCODE -ge 8) {
      exit 1
    }
    exit 0
  register: copy_result
  failed_when: copy_result.rc != 0

- name: Display staging results
  debug:
    msg: "ADFR files staged to {{ adfr_local_path }}"