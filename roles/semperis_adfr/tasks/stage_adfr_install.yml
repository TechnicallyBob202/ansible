# roles/semperis_adfr/tasks/stage_adfr_install.yml
---
- name: Remove all files and subfolders in the Semperis directory
  ansible.windows.win_shell: |
    Get-ChildItem -Path "{{ adfr_local_path }}" -Recurse -Force | Remove-Item -Recurse -Force

- name: Create local Semperis directory
  ansible.windows.win_file:
    path: "{{ adfr_local_path }}"
    state: directory

- name: Copy ADFR files from SMB share
  ansible.windows.win_shell: |
    # Authenticate to SMB share
    $username = "{{ adfr_smb_username }}"
    $password = ConvertTo-SecureString "{{ adfr_smb_password }}" -AsPlainText -Force
    $credential = New-Object System.Management.Automation.PSCredential($username, $password)

    # Map drive
    $driveLetter = "Z"
    $shareRoot = "\\192.168.33.13\Semperis"

    if (Get-PSDrive -Name $driveLetter -ErrorAction SilentlyContinue) {
      Remove-PSDrive -Name $driveLetter -Force
    }

    New-PSDrive -Name $driveLetter -PSProvider FileSystem -Root $shareRoot -Credential $credential -Persist -ErrorAction Stop | Out-Null

    # Copy files
    $source = "${driveLetter}:\ADFR"
    $dest = "{{ adfr_local_path | replace('/', '\\') }}"

    robocopy "$source" "$dest" /E /Z /R:3 /W:5 /MT:8 /NFL /NDL /NP /LOG:"$dest\robocopy.log" | Out-Null

    # Cleanup
    Remove-PSDrive -Name $driveLetter -Force -ErrorAction SilentlyContinue

    # Check exit code
    if ($LASTEXITCODE -ge 8) {
      throw "Robocopy failed with exit code: $LASTEXITCODE"
    }
  register: copy_result

- name: Verify ADFR executable
  ansible.windows.win_stat:
    path: "{{ adfr_local_path }}/ADFR-{{ adfr_version }}.exe"
  register: adfr_exe
  failed_when: not adfr_exe.stat.exists