# roles/semperis_adfr/tasks/install_adfr.yml
---
- name: Check if ADFR is already installed
  ansible.windows.win_service:
    name: ADFRService
  register: adfr_service_check
  failed_when: false
  changed_when: false

- name: Display installation status
  debug:
    msg: "ADFR Service {{ 'already installed' if adfr_service_check.exists else 'not found - will install' }}"

- name: Execute ADFR silent installation script
  ansible.windows.win_shell: |
    Set-Location "{{ adfr_local_path }}"

    # Set execution policy for this session
    Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force

    # Execute the silent installation script
    .\install-adfr.ps1

    # Return exit code
    exit $LASTEXITCODE
  register: install_result
  when: not adfr_service_check.exists
  failed_when: install_result.rc != 0

- name: Display installation result
  debug:
    msg: "ADFR Installation on {{ inventory_hostname }}: {{ 'Completed Successfully' if install_result.changed else 'Already Installed' }}"