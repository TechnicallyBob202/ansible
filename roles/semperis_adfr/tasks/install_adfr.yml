# roles/semperis_adfr/tasks/install_adfr.yml
---
- name: Check if ADFR is already installed
  ansible.windows.win_service:
    name: ADFRService
  register: adfr_service_check
  failed_when: false
  changed_when: false

- name: Display installation status
  debug:
    msg: "ADFR Service {{ 'already installed' if adfr_service_check.exists else 'not found - will install' }}"

- name: Execute ADFR silent installation script
  ansible.windows.win_shell: |
    Set-Location "{{ adfr_local_path }}"

    # Set execution policy for this session
    Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force

    # Execute the silent installation script
    & "{{ adfr_local_path }}\install-adfr.ps1"

    # Wait to ensure service exists
    $timeout = 1200
    $elapsed = 0
    while ($elapsed -lt $timeout) {
      if (Get-Service -Name ADFRService -ErrorAction SilentlyContinue) {
        Write-Output "ADFR service found"
        exit 0
      }
      Start-Sleep -Seconds 10
      $elapsed += 10
    }

    Write-Error "ADFR service not found after $timeout seconds"
    exit 1
  register: install_result
  when: not adfr_service_check.exists
  async: 600
  poll: 30

- name: Display installation result
  debug:
    msg: "ADFR Installation on {{ inventory_hostname }}: {{ 'Completed Successfully' if install_result.changed else 'Already Installed' }}"