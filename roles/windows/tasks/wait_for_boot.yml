---
# Wait for Windows to boot and be ready

- name: Wait for WinRM port to be available
  wait_for:
    host: "{{ ansible_host }}"
    port: 5985
    timeout: "{{ windows_dhcp_discovery_timeout }}"
    delay: 10
  delegate_to: localhost
  register: winrm_wait

- name: Wait for Windows to be responsive
  ansible.windows.win_ping:
  register: ping_result
  retries: 5
  delay: 10
  until: ping_result is succeeded

- name: Wait for Windows Management Instrumentation service
  ansible.windows.win_service:
    name: Winmgmt
  register: wmi_check
  retries: 3
  delay: 10
  until: wmi_check.state == "running"

- name: Display boot status
  debug:
    msg: "{{ inventory_hostname }} - System ready ({{ winrm_wait.elapsed }}s)"