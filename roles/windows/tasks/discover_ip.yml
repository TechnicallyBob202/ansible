---
# Discover current IP address from Proxmox guest agent

- name: Get current IP from Proxmox guest agent
  shell: |
    timeout 3 ssh -i /root/.ssh/ansible_key \
      -o ConnectTimeout=2 \
      -o StrictHostKeyChecking=no \
      -o BatchMode=yes \
      root@{{ proxmox_host }} \
      'qm guest cmd {{ vmid }} network-get-interfaces' | \
      grep -oP '(?<="ip-address" : ")[^"]*' | \
      grep -v '^127' | grep -v '^fe80' | grep -v '^::1' | head -1 || echo ""
  register: ip_discovery
  delegate_to: localhost
  failed_when: false
  changed_when: false

- name: Set discovered IP as fact
  set_fact:
    discovered_ip: "{{ ip_discovery.stdout }}"
  when: ip_discovery.stdout != ""

- name: Display discovered IP
  debug:
    msg: "Discovered IP for {{ inventory_hostname }}: {{ discovered_ip | default('NOT FOUND') }}"

- name: Fail if no IP found
  fail:
    msg: "Could not discover IP for {{ inventory_hostname }}"
  when: discovered_ip is not defined or discovered_ip == ""