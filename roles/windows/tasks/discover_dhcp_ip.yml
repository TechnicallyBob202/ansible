---
# Discover current DHCP IP address from Proxmox
# This is used when VMs boot with DHCP initially

- name: Get DHCP IP from Proxmox guest agent
  shell: |
    timeout 3 ssh -i /root/.ssh/ansible_key \
      -o ConnectTimeout=2 \
      -o StrictHostKeyChecking=no \
      -o BatchMode=yes \
      root@{{ proxmox_host }} \
      'qm guest cmd {{ vmid }} network-get-interfaces' | \
      grep -oP '(?<="ip-address" : ")[^"]*' | \
      grep -v '^127' | grep -v '^fe80' | grep -v '^::1' | head -1 || echo ""
  register: dhcp_discovery
  delegate_to: localhost
  failed_when: false
  changed_when: false

- name: Set discovered DHCP IP as fact
  set_fact:
    discovered_dhcp_ip: "{{ dhcp_discovery.stdout }}"
  when: dhcp_discovery.stdout != ""

- name: Display discovered IP
  debug:
    msg: "Discovered DHCP IP for {{ inventory_hostname }}: {{ discovered_dhcp_ip | default('NOT FOUND') }}"

- name: Fail if no DHCP IP found
  fail:
    msg: "Could not discover DHCP IP for {{ inventory_hostname }}"
  when: discovered_dhcp_ip is not defined or discovered_dhcp_ip == ""