---
- name: Get network adapter name
  ansible.windows.win_shell: |
    (Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1).Name
  register: adapter_name
  changed_when: false

- name: Set static IP address
  ansible.windows.win_shell: |
    New-NetIPAddress -InterfaceAlias "{{ adapter_name.stdout | trim }}" -IPAddress "{{ target_ip }}" -PrefixLength {{ windows_ip_prefix }} -DefaultGateway {{ windows_gateway }} -ErrorAction SilentlyContinue
  async: 30
  poll: 0

- name: Wait for IP change
  pause:
    seconds: 20

- name: Display result
  debug:
    msg: "{{ inventory_hostname }} configured to {{ target_ip }}"