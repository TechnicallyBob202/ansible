---
# Configure static IP address on Windows

- name: Get network adapter name
  ansible.windows.win_shell: |
    $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
    $adapter.Name
  register: adapter_name
  changed_when: false

- name: Check if target IP is already configured
  ansible.windows.win_shell: |
    $adapter = Get-NetAdapter | Where-Object {$_.Name -eq "{{ adapter_name.stdout | trim }}"}
    $currentIP = Get-NetIPAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4 -ErrorAction SilentlyContinue
    if ($currentIP.IPAddress -eq "{{ target_ip }}") {
      Write-Output "CONFIGURED"
    } else {
      Write-Output "NOT_CONFIGURED"
    }
  register: ip_check
  changed_when: false

- name: Remove existing IP configuration
  ansible.windows.win_shell: |
    $adapter = Get-NetAdapter | Where-Object {$_.Name -eq "{{ adapter_name.stdout | trim }}"}
    Remove-NetIPAddress -InterfaceAlias $adapter.Name -Confirm:$false -ErrorAction SilentlyContinue
    Remove-NetRoute -InterfaceAlias $adapter.Name -Confirm:$false -ErrorAction SilentlyContinue
  when: "'NOT_CONFIGURED' in ip_check.stdout"
  failed_when: false

- name: Set static IP address
  ansible.windows.win_shell: |
    $adapter = Get-NetAdapter | Where-Object {$_.Name -eq "{{ adapter_name.stdout | trim }}"}
    New-NetIPAddress -InterfaceAlias $adapter.Name `
      -IPAddress "{{ target_ip }}" `
      -PrefixLength {{ windows_ip_prefix }} `
      -DefaultGateway {{ windows_gateway }} `
      -ErrorAction Stop
  when: "'NOT_CONFIGURED' in ip_check.stdout"
  async: 10
  poll: 0
  register: ip_config
  ignore_errors: yes

- name: Display IP configuration result
  debug:
    msg: "{{ inventory_hostname }} - IP {{ 'configured' if ip_config.changed else 'already set' }} to {{ target_ip }}"