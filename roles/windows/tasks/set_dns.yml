---
- name: Get current DNS servers
  ansible.windows.win_shell: |
    $adapter = (Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1).Name
    (Get-DnsClientServerAddress -InterfaceAlias $adapter -AddressFamily IPv4).ServerAddresses -join ","
  register: current_dns
  changed_when: false

- name: Set DNS servers
  ansible.windows.win_shell: |
    $adapter = (Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1).Name
    Set-DnsClientServerAddress -InterfaceAlias $adapter -ServerAddresses "{{ windows_dns_servers | join('","') }}"
  when: windows_dns_servers[0] not in current_dns.stdout

- name: Display DNS result
  debug:
    msg: "{{ inventory_hostname }} - DNS {{ 'configured' if windows_dns_servers[0] not in current_dns.stdout else 'already set' }}"