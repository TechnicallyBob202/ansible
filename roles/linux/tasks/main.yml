---
# Ensure NM is present when configuring network
- name: Ensure NetworkManager is running
  ansible.builtin.service:
    name: NetworkManager
    state: started
    enabled: yes
  when: linux_operation in ['configure_network', 'set_static_ip']

# Discover active ethernet connection/interface if none provided
- name: Get active connections
  ansible.builtin.command: nmcli -t -f NAME,TYPE,DEVICE,STATE c show --active
  register: nmcli_active
  changed_when: false
  when: linux_operation in ['configure_network', 'set_static_ip']
        and (linux_conn_name is not defined or linux_ifname is not defined)

- name: Pick primary ethernet connection
  ansible.builtin.set_fact:
    linux_conn_name: "{{ (nmcli_active.stdout_lines | map('split', ':') | selectattr(1, 'equalto', 'ethernet') | list | first)[0] }}"
    linux_ifname:   "{{ (nmcli_active.stdout_lines | map('split', ':') | selectattr(1, 'equalto', 'ethernet') | list | first)[2] }}"
  when: linux_operation in ['configure_network', 'set_static_ip']
        and (linux_conn_name is not defined or linux_ifname is not defined)

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
  when: linux_operation in ['set_hostname', 'configure_network']

- name: Configure static IP via nmcli
  community.general.nmcli:
    conn_name: "{{ linux_conn_name | default('System eth0') }}"
    ifname: "{{ linux_ifname | default('eth0') }}"
    type: ethernet
    ip4: "{{ ansible_host }}/{{ linux_ip_prefix | default(24) }}"
    gw4: "{{ linux_gateway | default('192.168.35.1') }}"
    dns4: "{{ linux_dns_servers | default(['1.1.1.1','1.0.0.1']) | join(',') }}"
    state: present
    autoconnect: yes
  register: network_config
  when: linux_operation in ['set_static_ip', 'configure_network']

- name: Reboot after network changes
  ansible.builtin.reboot:
    reboot_timeout: 600
  when:
    - linux_operation == 'configure_network'
    - network_config is defined
    - network_config.changed
  register: reboot_result

- name: Wait for system to come back
  ansible.builtin.wait_for_connection:
    delay: 30
    timeout: 300
  when:
    - linux_operation == 'configure_network'
    - reboot_result is defined
    - reboot_result.changed

# Optional: validation
- name: Validate configuration
  block:
    - name: Get IPv4 address on active interface
      ansible.builtin.shell: |
        nmcli -g IP4.ADDRESS dev show "{{ linux_ifname | default('eth0') }}" | head -n1 | cut -d/ -f1
      register: current_ip
      changed_when: false

    - name: Get hostname
      ansible.builtin.command: hostname
      register: current_hostname
      changed_when: false

    - name: Display validation results
      ansible.builtin.debug:
        msg:
          - "Hostname: {{ current_hostname.stdout }}"
          - "IP Address: {{ current_ip.stdout }}"
          - "Expected IP: {{ ansible_host }}"
          - "Match: {{ current_ip.stdout == ansible_host }}"
  when: linux_operation == 'validate'