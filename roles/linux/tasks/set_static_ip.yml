---
# Configure static IP on Linux using NetworkManager

- name: Ensure NetworkManager is running
  ansible.builtin.service:
    name: NetworkManager
    state: started
    enabled: yes

- name: Get active ethernet connections
  ansible.builtin.command: nmcli -t -f NAME,TYPE,DEVICE,STATE c show --active
  register: nmcli_active
  changed_when: false

- name: Debug active connections
  ansible.builtin.debug:
    msg: "Active connections: {{ nmcli_active.stdout_lines }}"

- name: Determine connection name and interface
  ansible.builtin.set_fact:
    linux_conn_name: "{{ (nmcli_active.stdout_lines | map('split', ':') | selectattr(1, 'search', 'ethernet') | list | first)[0] }}"
    linux_ifname: "{{ (nmcli_active.stdout_lines | map('split', ':') | selectattr(1, 'search', 'ethernet') | list | first)[2] }}"
  when:
    - (linux_conn_name is not defined or linux_ifname is not defined)
    - nmcli_active.stdout_lines | map('split', ':') | selectattr(1, 'search', 'ethernet') | list | length > 0

- name: Configure static IP via nmcli
  community.general.nmcli:
    conn_name: "{{ linux_conn_name | default('System eth0') }}"
    ifname: "{{ linux_ifname | default('eth0') }}"
    type: ethernet
    ip4: "{{ ansible_host }}/{{ linux_ip_prefix | default(24) }}"
    gw4: "{{ linux_gateway | default('192.168.35.1') }}"
    dns4: "{{ linux_dns_servers | default(['1.1.1.1','1.0.0.1']) | join(',') }}"
    state: present
    autoconnect: yes
  register: network_config

- name: Switch ansible_ssh_host to new static IP for future tasks
  ansible.builtin.set_fact:
    ansible_ssh_host: "{{ ansible_host }}"
    cacheable: true
  when: network_config.changed

- name: Display result
  debug:
    msg: "{{ inventory_hostname }} - IP {{ 'configured to' if network_config.changed else 'already set to' }} {{ ansible_host }}"