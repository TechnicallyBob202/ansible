---
# Configure static IP on Ubuntu using netplan

- name: Detect network interface
  ansible.builtin.shell: |
    ip -o link show | awk -F': ' '{print $2}' | grep -E '^(eth|ens|enp)' | head -1
  register: detected_interface
  changed_when: false

- name: Set interface fact
  ansible.builtin.set_fact:
    linux_ifname: "{{ detected_interface.stdout | trim }}"

- name: Ensure netplan directory exists
  ansible.builtin.file:
    path: /etc/netplan
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Check if netplan config exists
  ansible.builtin.stat:
    path: /etc/netplan/01-netcfg.yaml
  register: netplan_file

- name: Generate netplan configuration
  ansible.builtin.template:
    src: netplan.yaml.j2
    dest: /etc/netplan/01-netcfg.yaml
    owner: root
    group: root
    mode: '0600'
  become: true
  register: netplan_config
  changed_when: netplan_config.changed and needs_ip_config

- name: Apply netplan configuration
  ansible.builtin.command: netplan apply
  become: true
  when: netplan_config.changed and needs_ip_config
  async: 10
  poll: 0

- name: Wait for network to stabilize
  pause:
    seconds: 5
  when: netplan_config.changed and needs_ip_config

- name: Update ansible connection to new IP
  ansible.builtin.set_fact:
    ansible_host: "{{ target_ip }}"
  when: netplan_config.changed and needs_ip_config

- name: Display result
  debug:
    msg: "{{ inventory_hostname }} - IP {{ 'configured to' if (netplan_config.changed and needs_ip_config) else 'already set to' }} {{ target_ip }}"