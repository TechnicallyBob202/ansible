---
# Configure static IP on Ubuntu using netplan

- name: Detect primary network interface
  ansible.builtin.shell: |
    ip -o link show | awk -F': ' '{print $2}' | grep -E '^(eth|ens|enp)' | head -1
  register: detected_interface
  changed_when: false

- name: Set primary interface fact
  ansible.builtin.set_fact:
    linux_ifname: "{{ detected_interface.stdout | trim }}"

- name: Detect secondary network interface (if exists)
  ansible.builtin.shell: |
    ip -o link show | awk -F': ' '{print $2}' | grep -E '^(eth|ens|enp)' | sed -n '2p'
  register: detected_secondary_interface
  changed_when: false
  when: secondary_ip is defined

- name: Set secondary interface fact
  ansible.builtin.set_fact:
    linux_secondary_ifname: "{{ detected_secondary_interface.stdout | trim }}"
  when:
    - secondary_ip is defined
    - detected_secondary_interface.stdout | length > 0

- name: Ensure netplan directory exists
  ansible.builtin.file:
    path: /etc/netplan
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Check if netplan config exists
  ansible.builtin.stat:
    path: /etc/netplan/01-netcfg.yaml
  register: netplan_file

- name: Generate netplan configuration
  ansible.builtin.template:
    src: netplan.yaml.j2
    dest: /etc/netplan/01-netcfg.yaml
    owner: root
    group: root
    mode: '0600'
  become: true
  register: netplan_config
  changed_when: netplan_config.changed and needs_ip_config

- name: Apply netplan configuration
  ansible.builtin.command: netplan apply
  become: true
  when: netplan_config.changed and needs_ip_config
  async: 10
  poll: 0

- name: Wait for network to stabilize
  pause:
    seconds: 5
  when: netplan_config.changed and needs_ip_config

- name: Update ansible connection to new IP
  ansible.builtin.set_fact:
    ansible_host: "{{ target_ip }}"
  when: netplan_config.changed and needs_ip_config

- name: Display result
  debug:
    msg:
      - "{{ inventory_hostname }} - Primary IP {{ 'configured to' if (netplan_config.changed and needs_ip_config) else 'already set to' }} {{ target_ip }}"
      - "{{ inventory_hostname }} - Secondary IP {{ secondary_ip if (secondary_ip is defined and linux_secondary_ifname is defined) else 'not configured' }}"