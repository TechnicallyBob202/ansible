---
# Configure static IP on Ubuntu using netplan

- name: Detect primary network interface
  ansible.builtin.shell: |
    ip -o link show | awk -F': ' '{print $2}' | grep -E '^(eth|ens|enp)' | head -1
  register: detected_interface
  changed_when: false

- name: Set primary interface fact
  ansible.builtin.set_fact:
    linux_ifname: "{{ detected_interface.stdout | trim }}"

- name: Detect secondary network interface (if exists)
  ansible.builtin.shell: |
    ip -o link show | awk -F': ' '{print $2}' | grep -E '^(eth|ens|enp)' | sed -n '2p'
  register: detected_secondary_interface
  changed_when: false

- name: Set secondary interface fact
  ansible.builtin.set_fact:
    linux_secondary_ifname: "{{ detected_secondary_interface.stdout | trim }}"
  when: detected_secondary_interface.stdout | length > 0

- name: Display detected interfaces
  ansible.builtin.debug:
    msg:
      - "Primary interface: {{ linux_ifname }}"
      - "Secondary interface: {{ linux_secondary_ifname | default('not detected') }}"
      - "Secondary IP requested: {{ secondary_ip | default('not defined') }}"

- name: Ensure netplan directory exists
  ansible.builtin.file:
    path: /etc/netplan
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Generate netplan configuration
  ansible.builtin.template:
    src: netplan.yaml.j2
    dest: /etc/netplan/01-netcfg.yaml
    owner: root
    group: root
    mode: '0600'
  become: true
  register: netplan_config

- name: Apply netplan configuration
  ansible.builtin.command: netplan apply
  become: true
  when: netplan_config.changed or (secondary_ip is defined and linux_secondary_ifname is defined)
  async: 10
  poll: 0

- name: Wait for network to stabilize
  pause:
    seconds: 5
  when: netplan_config.changed or (secondary_ip is defined and linux_secondary_ifname is defined)

- name: Display result
  ansible.builtin.debug:
    msg:
      - "{{ inventory_hostname }} - Primary IP {{ 'configured to' if netplan_config.changed else 'already set to' }} {{ target_ip }}"
      - "{{ inventory_hostname }} - Secondary IP {{ secondary_ip if (secondary_ip is defined and linux_secondary_ifname is defined) else 'not configured' }}"