---
# roles/proxmox/tasks/snapshot.yml
# Delete-then-create a stage-specific snapshot using proxmox_snap only.

- block:
    - name: Ensure default snapshot vars
      set_fact:
        snapshot_name: "{{ snapshot_name | default('post-deploy') }}"
        proxmox_snapshot_vmstate: "{{ proxmox_snapshot_vmstate | default(false) }}"
      delegate_facts: false

    - name: Skip snapshot if VM didn't change
      debug:
        msg: "Skipping snapshot for {{ inventory_hostname }} - no changes made"
      when: not (vm_changed | default(false))

    - name: Check if VM exists (on this node)
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        vmid: "{{ vmid }}"
        node: "{{ proxmox_node }}"
        state: current
      register: vm_exists
      failed_when: false
      changed_when: false
      when: vm_changed | default(false)

    - name: Remove existing stage snapshot (if present)
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: absent
        force: true
        timeout: 300
      when:
        - vm_changed | default(false)
        - vm_exists.status is defined
      failed_when: false
      register: remove_snapshot_result

    - name: Display removal result
      debug:
        msg: "{{ inventory_hostname }} - existing snapshot {{ 'removed' if (remove_snapshot_result.changed | default(false)) else 'did not exist' }}"
      when:
        - vm_changed | default(false)
        - vm_exists.status is defined

    - name: Create stage snapshot
      community.general.proxmox_snap:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: "{{ proxmox_validate_certs }}"
        hostname: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        snapname: "{{ snapshot_name }}"
        state: present
        description: "Stage snapshot: {{ snapshot_name }}"
        vmstate: "{{ proxmox_snapshot_vmstate }}"
        timeout: 600
      when:
        - vm_changed | default(false)
        - vm_exists.status is defined
      register: snapshot_result
      retries: 3
      delay: 10
      until: snapshot_result is succeeded

    - name: Display snapshot result
      debug:
        msg: "VM {{ inventory_hostname }} ({{ vmid }}) snapshot '{{ snapshot_name }}' {{ 'created' if snapshot_result.changed else 'skipped - no changes' }}"
      when: vm_exists.status is defined

  delegate_to: localhost