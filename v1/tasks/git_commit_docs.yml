---
# Commit documentation files to git repository
- name: Check if git repository exists
  stat:
    path: "{{ playbook_dir }}/../.git"
  register: git_repo

- name: Add all documentation files to git
  shell: |
    cd {{ playbook_dir }}/..
    git add files/forest-domain-sids.txt files/semperis-lab-mremoteng.xml
  when: git_repo.stat.exists

- name: Commit documentation files
  shell: |
    cd {{ playbook_dir }}/..
    git config user.email "ansible@semperis.lab" || true
    git config user.name "Ansible Automation" || true
    git commit -m "Update lab documentation - {{ ansible_date_time.iso8601 }}" files/ || echo "No changes to commit"
  when: git_repo.stat.exists
  register: git_commit
  changed_when: "'No changes to commit' not in git_commit.stdout"

- name: Push documentation to git
  shell: |
    cd {{ playbook_dir }}/..
    git push origin main || git push origin master || echo "Push failed - check remote configuration"
  when:
    - git_repo.stat.exists
    - git_commit.changed
  register: git_push
  ignore_errors: true

- name: Display git status
  debug:
    msg:
      - "Documentation files committed to git:"
      - "  - files/forest-domain-sids.txt"
      - "  - files/semperis-lab-mremoteng.xml"
      - "Git commit: {{ 'Updated' if git_commit.changed else 'No changes' }}"
      - "Git push: {{ 'Success' if git_push is succeeded else 'Failed or skipped' }}"