---
# Install Active Directory Domain Services feature

- name: Install AD-Domain-Services on {{ inventory_hostname }}
  ansible.windows.win_feature:
    name: AD-Domain-Services
    include_management_tools: yes
  register: adds_install

- name: Display AD-DS installation result
  debug:
    msg: "AD-DS {{ 'installed successfully' if adds_install.changed else 'was already installed' }}"

- name: Wait for AD-DS installation to complete
  ansible.windows.win_powershell:
    script: |
      # Verify the feature is actually installed
      $feature = Get-WindowsFeature -Name AD-Domain-Services
      if ($feature.Installed) {
        Write-Output "AD-DS installation verified"
      } else {
        Write-Output "AD-DS installation incomplete"
        exit 1
      }
  register: adds_verify
  retries: 5
  delay: 10
  until: adds_verify is succeeded
  when: adds_install.changed