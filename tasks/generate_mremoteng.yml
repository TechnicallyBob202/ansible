---
# Generate mRemoteNG XML configuration and push to git
# Add this to playbooks/04-verify-lab.yml in the documentation phase

- name: Generate mRemoteNG configuration file
  template:
    src: "{{ playbook_dir }}/../templates/mremoteng.xml.j2"
    dest: "{{ playbook_dir }}/../files/adfr-lab-mremoteng.xml"
    mode: '0644'

- name: Check if git repository exists
  stat:
    path: "{{ playbook_dir }}/../.git"
  register: git_repo

- name: Add mRemoteNG file to git
  shell: |
    cd {{ playbook_dir }}/..
    git add files/adfr-lab-mremoteng.xml
  when: git_repo.stat.exists

- name: Commit mRemoteNG file
  shell: |
    cd {{ playbook_dir }}/..
    git config user.email "ansible@semperis.lab" || true
    git config user.name "Ansible Automation" || true
    git commit -m "Update mRemoteNG configuration - {{ ansible_date_time.iso8601 }}" files/adfr-lab-mremoteng.xml || echo "No changes to commit"
  when: git_repo.stat.exists
  register: git_commit
  changed_when: "'No changes to commit' not in git_commit.stdout"

- name: Push to git
  shell: |
    cd {{ playbook_dir }}/..
    git push origin main || git push origin master || echo "Push failed - check remote configuration"
  when:
    - git_repo.stat.exists
    - git_commit.changed
  register: git_push
  ignore_errors: yes

- name: Display git status
  debug:
    msg:
      - "mRemoteNG file generated: files/adfr-lab-mremoteng.xml"
      - "Git commit: {{ 'Updated' if git_commit.changed else 'No changes' }}"
      - "Git push: {{ 'Success' if git_push is succeeded else 'Failed or skipped' }}"