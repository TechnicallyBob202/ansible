---
# Verify DC promotion was successful

- name: Verify DC promotion for {{ inventory_hostname }}
  ansible.windows.win_powershell:
    script: |
      $CS = Get-WmiObject Win32_ComputerSystem
      Write-Output "Hostname: $($CS.Name)"
      Write-Output "Domain: $($CS.Domain)"
      Write-Output "DomainRole: $($CS.DomainRole)"

      try {
        $DC = Get-ADDomainController -Identity $env:COMPUTERNAME
        Write-Output "Site: $($DC.Site)"
        Write-Output "IsGlobalCatalog: $($DC.IsGlobalCatalog)"
        Write-Output "IsReadOnly: $($DC.IsReadOnly)"
        Write-Output "OperatingSystem: $($DC.OperatingSystem)"
        Write-Output "IPv4Address: $($DC.IPv4Address)"
      } catch {
        Write-Output "Error getting DC details: $($_.Exception.Message)"
      }
  register: verify_dc_details
  retries: 3
  delay: 10
  until: verify_dc_details is succeeded

- name: Display DC verification results
  debug:
    msg: "{{ verify_dc_details.output }}"
  when: verify_dc_details.output is defined