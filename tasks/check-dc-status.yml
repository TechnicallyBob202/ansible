---
# Output facts:
#   - is_domain_controller: boolean

- name: Check if {{ inventory_hostname }} is already a DC
  ansible.windows.win_powershell:
    script: |
      $CS = Get-WmiObject Win32_ComputerSystem
      if ($CS.DomainRole -ge 4) {
        Write-Output "IS_DC"
        Write-Output "Domain: $($CS.Domain)"
        Write-Output "Role: $($CS.DomainRole)"
      } else {
        Write-Output "NOT_DC"
        Write-Output "Workgroup/Member: $($CS.Domain)"
      }
  register: dc_check
  failed_when: false
  changed_when: false

- name: Set DC status for {{ inventory_hostname }}
  set_fact:
    is_domain_controller: "{{ 'IS_DC' in dc_check.output[0] if dc_check.output is defined and dc_check.output | length > 0 else false }}"

- name: Display DC status for {{ inventory_hostname }}
  debug:
    msg: "{{ dc_check.output }}"
  when: dc_check.output is defined