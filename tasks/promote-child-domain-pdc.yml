---
# Input variables required:
#   - child_domain_name: e.g., "mauna"
#   - parent_domain_name: e.g., "alpine.lab"
#   - parent_netbios_name: e.g., "ALPINE"
#   - windows_password: password

- name: Promote {{ inventory_hostname }} to child domain PDC
  ansible.windows.win_powershell:
    script: |
      $ErrorActionPreference = "Stop"
      $SecurePassword = ConvertTo-SecureString "{{ windows_password }}" -AsPlainText -Force
      $ParentCred = New-Object System.Management.Automation.PSCredential("{{ parent_netbios_name }}\Administrator", $SecurePassword)

      Install-ADDSDomain `
        -NewDomainName "{{ child_domain_name }}" `
        -ParentDomainName "{{ parent_domain_name }}" `
        -DomainType "ChildDomain" `
        -SafeModeAdministratorPassword $SecurePassword `
        -Credential $ParentCred `
        -InstallDNS `
        -CreateDnsDelegation `
        -DatabasePath "C:\Windows\NTDS" `
        -SysvolPath "C:\Windows\SYSVOL" `
        -LogPath "C:\Windows\NTDS" `
        -Force `
        -NoRebootOnCompletion:$false

      Write-Output "Child domain creation initiated"
  async: 1200
  poll: 0
  register: child_domain_promotion

- name: Wait for child domain promotion to complete
  async_status:
    jid: "{{ child_domain_promotion.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 40
  delay: 30
  when: child_domain_promotion.ansible_job_id is defined

- name: Wait for {{ inventory_hostname }} to come back after reboot
  wait_for_connection:
    timeout: 900
    delay: 60

- name: Verify child domain promotion
  ansible.windows.win_powershell:
    script: |
      Start-Sleep -Seconds 30
      $domain = Get-ADDomain -Identity "{{ child_domain_name }}.{{ parent_domain_name }}"
      Write-Output "Domain: $($domain.DNSRoot)"
      Write-Output "NetBIOS: $($domain.NetBIOSName)"
      Write-Output "SID: $($domain.DomainSID.Value)"
      Write-Output "Parent: $($domain.ParentDomain)"
  register: verify_child_promotion
  retries: 5
  delay: 30
  until: verify_child_promotion is succeeded

- name: Display child domain promotion results
  debug:
    msg: "{{ verify_child_promotion.output }}"
  when: verify_child_promotion.output is defined

- name: Get child domain SID
  ansible.windows.win_powershell:
    script: |
      $domain = Get-ADDomain -Identity "{{ child_domain_name }}.{{ parent_domain_name }}"
      Write-Output $domain.DomainSID.Value
  register: get_child_domain_sid

- name: Set child domain SID fact
  set_fact:
    domain_sid: "{{ get_child_domain_sid.output[0] }}"
  when: get_child_domain_sid.output is defined and get_child_domain_sid.output | length > 0